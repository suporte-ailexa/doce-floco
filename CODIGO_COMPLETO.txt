CONTEXTO DO PROJETO (C√ìDIGO FONTE)
Data da gera√ß√£o: 21/01/2026, 20:33:35

================================================================================
ARQUIVO: /package.json
================================================================================
{
  "name": "doce-floco-uaixia",
  "version": "1.0.0",
  "productName": "Doce Floco Dashboard",
  "description": "Sistema de Gest√£o de Pedidos com IA",
  "main": "src/main/index.js",
  "scripts": {
    "start": "chcp 65001 && electron .",
    "dev": "npm run build:css && electron .",
    "build:css": "tailwindcss -i src/renderer/assets/css/input.css -o src/renderer/assets/css/tailwind.css --minify",
    "watch:css": "tailwindcss -i src/renderer/assets/css/input.css -o src/renderer/assets/css/tailwind.css --watch",
    "package": "npm run build:css && electron-builder --win"
  },
  "keywords": [
    "Electron",
    "Laser",
    "Clinic",
    "HTML",
    "CSS",
    "JavaScript",
    "Firebase",
    "TailwindCSS"
  ],
  "author": "Camila Santos",
  "license": "MIT",
  "devDependencies": {
    "autoprefixer": "^10.4.17",
    "electron": "^28.2.3",
    "electron-builder": "^24.9.1",
    "postcss": "^8.4.35",
    "puppeteer": "13.0.0",
    "tailwindcss": "^3.4.1"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "clipboardy": "^5.0.2",
    "dotenv": "^16.4.5",
    "firebase": "^12.7.0",
    "firebase-admin": "^13.6.0",
    "luxon": "^3.7.2",
    "node-cron": "^4.2.1",
    "qrcode-terminal": "^0.12.0",
    "whatsapp-web.js": "1.19.5"
  },
  "build": {
    "appId": "com.docefloco.app",
    
    "win": {
      "target": "nsis",
      "icon": "src/renderer/assets/icon.png" 
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true
    },
    
    "directories": {
      "output": "dist"
    },
    "files": [
      "src/**/*",
      "package.json"
    ],
    "extraResources": [
      {
        "from": "config/.env",
        "to": "config/.env",
        "filter": ["**/*"]
      },
      {
        "from": "config/serviceAccountKey.json",
        "to": "config/serviceAccountKey.json",
        "filter": ["**/*"]
      },
      {
        "from": "chrome-bin",
        "to": "chrome-bin",
        "filter": ["**/*"]
      }
    ]
  }
}

================================================================================
ARQUIVO: /postcss.config.js
================================================================================
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

================================================================================
ARQUIVO: /src/main/controllers/AppController.js
================================================================================
// ================================================================================
// ARQUIVO: /src/main/controllers/AppController.js
// ================================================================================

const { ipcMain, BrowserWindow, app } = require('electron');
const path = require('path');
const fs = require('fs');

const DatabaseService = require('../services/DatabaseService');
const AIService = require('../services/AIService');
const WhatsappService = require('../services/WhatsappService');

const AI_REPLY_DELAY = 15000; 

class AppController {
    constructor(dbInstance, mainWindow) {
        this.mainWindow = mainWindow;
        this.db = new DatabaseService(dbInstance);
        this.ai = new AIService();
        
        const isDev = !app.isPackaged;
        const resourcePath = isDev ? path.join(__dirname, '../../../') : process.resourcesPath;
        const sessionPath = path.join(resourcePath, 'whatsapp_session');
        const chromePath = isDev ? undefined : path.join(resourcePath, 'chrome-bin', 'chrome-win64', 'chrome.exe');
        
        this.wa = new WhatsappService(sessionPath, chromePath, isDev);
        this.messageBuffers = new Map();
        this.workerWindow = null; 
    }

    async initialize() {
        console.log('[Controller] Inicializando sistema Doce Floco (V6.5 - Corre√ß√£o Estoque/Crash)...');
        const storeConfig = await this.db.getStoreConfig();
        if (storeConfig.geminiApiKey) {
            this.ai.init(storeConfig.geminiApiKey);
            this.ai.updateConfig(storeConfig);
        }
        this._setupWhatsappListeners();
        this._setupIpcHandlers();
        console.log('[Controller] Iniciando conex√£o autom√°tica do WhatsApp...');
        this.wa.initialize(); 
        console.log('[Controller] Sistema pronto.');
    }

    _setupWhatsappListeners() {
        this.wa.on('qr', (qr) => this.mainWindow.webContents.send('whatsapp-qr', qr));
        this.wa.on('status', (status) => this.mainWindow.webContents.send('whatsapp-status', status));
        this.wa.on('message', async (message) => { await this._handleIncomingMessage(message); });
    }

    async _handleIncomingMessage(message) {
        try {
            let rawPhone = message.from.replace('@c.us', '');
            let contactInfo = await message.getContact().catch(() => ({}));
            let senderName = contactInfo.pushname || contactInfo.name || `Cliente ${rawPhone.slice(-4)}`;
            
            const client = await this.db.getOrCreateClient(rawPhone, senderName);
            
            let body = message.body;
            let isAudio = false;

            if (message.type === 'ptt' || message.type === 'audio') {
                isAudio = true;
                const media = await message.downloadMedia();
                const transcript = await this.ai.transcribeAudio(media.data, media.mimetype);
                body = transcript ? `[√ÅUDIO]: ${transcript}` : "[√ÅUDIO INAUD√çVEL]";
            } else if (message.type !== 'chat') {
                return; 
            }

            let quotedContext = null;
            if (message.hasQuotedMsg) {
                try {
                    const quoted = await message.getQuotedMessage();
                    const content = quoted.caption || quoted.body || "[M√≠dia]";
                    quotedContext = `[CLIENTE RESPONDEU √Ä MENSAGEM: "${content}"]`;
                } catch (e) {
                    console.error("Erro ao ler quoted message:", e);
                }
            }

            await this.db.logMessage(client.id, {
                chatId: message.from,
                fromMe: false,
                content: body + (quotedContext ? `\n${quotedContext}` : ""), 
                body: body, 
                originalType: message.type,
                isAudio,
                read: false
            });

            if (client.aiPaused) return;
            this._queueAutoReply(message.from, client, body, quotedContext);

        } catch (error) {
            console.error('[Controller] Erro no handler de mensagem:', error);
        }
    }

    _queueAutoReply(chatId, client, text, quotedContext = null) {
        if (this.messageBuffers.has(chatId)) {
            const existing = this.messageBuffers.get(chatId);
            clearTimeout(existing.timer);
            existing.text += " " + text;
            if (quotedContext) existing.quotedContext = quotedContext;
            existing.timer = setTimeout(() => {
                this._processAiReply(chatId, client, existing.text, existing.quotedContext);
                this.messageBuffers.delete(chatId);
            }, AI_REPLY_DELAY);
            this.messageBuffers.set(chatId, existing);
        } else {
            const timer = setTimeout(() => {
                this._processAiReply(chatId, client, text, quotedContext);
                this.messageBuffers.delete(chatId);
            }, AI_REPLY_DELAY);
            this.messageBuffers.set(chatId, { timer, text, quotedContext });
        }
    }

    /**
     * MELHORADO: Parser de Produtos para Baixa de Estoque
     * Agora aceita "Picol√© Coco" sem n√∫mero (assume 1) e √© case-insensitive
     */
    _matchProductsFromText(textItems, allProducts) {
        if (!textItems || typeof textItems !== 'string') return [];
        const cart = [];
        
        // Separa linhas ou v√≠rgulas
        const lines = textItems.split(/[\n,]/);
        
        lines.forEach(line => {
            let clean = line.trim();
            if (!clean) return;

            // Remove h√≠fens no in√≠cio (ex: "- Picol√©")
            clean = clean.replace(/^-\s*/, '');

            // Regex tenta achar n√∫mero no come√ßo. 
            // Ex: "2x Coca" -> qty=2, name="Coca"
            // Ex: "Coca" -> match null -> qty=1, name="Coca"
            const match = clean.match(/^(\d+)\s*[xX]?\s*(.+)$/);
            
            let qty = 1;
            let searchName = clean.toLowerCase();

            if (match) {
                qty = parseInt(match[1]);
                searchName = match[2].trim().toLowerCase();
            }

            // Busca produto na lista (Case Insensitive)
            // Tenta match exato ou parcial
            const product = allProducts.find(p => {
                const pName = p.name.toLowerCase();
                return pName === searchName || pName.includes(searchName) || searchName.includes(pName);
            });
            
            if (product) {
                cart.push({ id: product.id, qty: qty, name: product.name });
            }
        });
        
        if(cart.length > 0) console.log(`[Estoque] Itens identificados para baixa: ${cart.length}`);
        return cart;
    }

    async _processAiReply(chatId, client, userText, quotedContext = null) {
        try {
            const history = await this.db.getClientHistory(client.id);
            const chatRecent = await this.db.getRecentChat(client.id);
            
            // Carrega produtos para o parser de estoque
            const productsSnapshot = await this.db.db.collection('products').where('active', '==', true).get();
            const allProducts = productsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const productsData = await this.db.getActiveProducts();
            
            // Anti-Duplicidade
            const activeOrder = await this.db.getLastPendingOrder(client.id);
            
            const { DateTime } = require('luxon');
            const today = DateTime.now().setLocale('pt-BR');
            const lastAddress = client.lastAddress || null;

            const context = {
                clientName: client.name,
                history,
                chatRecent,
                menuJson: JSON.stringify(productsData.menuStructured),
                todayDate: today.toFormat('dd/MM/yyyy'),
                dayName: today.toFormat('cccc'),
                forcedContext: quotedContext,
                lastAddress,
                activeOrder: activeOrder ? { shortId: activeOrder.shortId, items: activeOrder.items, total: activeOrder.total } : null
            };

            const response = await this.ai.generateSalesResponse(context, userText);
            let finalReply = response.text;
            
            if (response.command) {
                const cmd = response.command;
                console.log(`[IA Action] Executando: ${cmd.type}`);
                
                let result = { success: false };

                switch (cmd.type) {
                    case 'schedule_order':
                        result = await this.db.createScheduledOrder({ ...cmd, clientId: client.id, clientName: client.name });
                        if (result.success && !finalReply) {
                            finalReply = `üóìÔ∏è Agendado para ${cmd.date.split('-').reverse().join('/')}!`;
                        }
                        break;
                        
                    case 'create_order':
                        const shortId = Date.now().toString().slice(-4);
                        if (cmd.method === 'Entrega' && cmd.address) {
                            await this.db.updateDocument('clients', client.id, { lastAddress: cmd.address });
                        }
                        
                        // TENTA IDENTIFICAR PRODUTOS PARA BAIXA DE ESTOQUE
                        const computedCart = this._matchProductsFromText(cmd.items, allProducts);

                        // --- IN√çCIO DA VALIDA√á√ÉO DE M√çNIMO ---
                        const conf = await this.db.getStoreConfig();
                        const minQty = parseInt(conf.minDeliveryQty || 0);
                        const isDelivery = (cmd.method || '').toLowerCase().includes('entrega');

                        // Calcula quantidade total baseada no parser
                        let totalCount = 0;
                        if (computedCart.length > 0) {
                            totalCount = computedCart.reduce((sum, item) => sum + item.qty, 0);
                        } else {
                            // Fallback: se o parser falhou (ex: texto livre), tenta estimar via regex simples
                            // ou confia na IA (arriscado), aqui vamos assumir 1 se n√£o achou nada, 
                            // mas o ideal √© o parser funcionar.
                            totalCount = 1; 
                        }

                        if (isDelivery && minQty > 0 && totalCount < minQty) {
                            console.log(`[Regra Neg√≥cio] Pedido recusado. Qtd: ${totalCount}, M√≠nimo: ${minQty}`);
                            // N√£o cria o pedido. Responde ao cliente explicando.
                            finalReply = `‚ö†Ô∏è Ops! A IA se confundiu. Para entrega, o pedido m√≠nimo √© de *${minQty} unidades*. Voc√™ pediu apenas ${totalCount}. Gostaria de adicionar mais itens ou mudar para retirada?`;
                            await this.wa.sendText(chatId, finalReply);
                            await this.db.logMessage(client.id, { chatId, fromMe: true, body: finalReply, isAutoReply: true });
                            return; // INTERROMPE A CRIA√á√ÉO DO PEDIDO
                        }
                        // --- FIM DA VALIDA√á√ÉO ---

                        result = await this.db.createStandardOrder({ 
                            ...cmd, 
                            clientId: client.id, 
                            clientName: client.name,
                            shortId: shortId,
                            cart: computedCart // IMPORTANTE: Passa o carrinho
                        });
                        
                        if (result.success) {
                            if (!finalReply) finalReply = `üìù Pedido #${shortId} confirmado! Total: R$ ${cmd.total}.`;
                            const conf = await this.db.getStoreConfig();
                            if (conf.autoPrint && conf.printerName) {
                                this._printOrder(result.orderId, { ...result, items: cmd.items, clientName: client.name, total: cmd.total, deliveryMethod: cmd.method, address: cmd.address || 'Retirada', paymentMethod: cmd.payment || 'A Combinar', shortId: shortId });
                            }
                        } else {
                            if (result.error && result.error.includes('Estoque insuficiente')) {
                                finalReply = "‚ö†Ô∏è Ops! Acabei de conferir e algum item acabou de esgotar. üòî";
                            }
                        }
                        break;

                    case 'update_order':
                    case 'update_last_order':
                        let orderDoc = null;
                        
                        if (cmd.orderId) {
                            const qCheck = await this.db.db.collection('orders').where('shortId', '==', String(cmd.orderId)).limit(1).get();
                            if (!qCheck.empty) orderDoc = qCheck.docs[0];
                        }

                        // Fallback: Se n√£o achou pelo ID, tenta pelo pedido ativo na mem√≥ria
                        if (!orderDoc && activeOrder) {
                             orderDoc = await this.db.db.collection('orders').doc(activeOrder.id).get();
                        }
                        
                        // Fallback 2: Busca no banco
                        if (!orderDoc) {
                            const lastOrders = await this.db.db.collection('orders')
                                .where('clientId', '==', client.id)
                                .where('status', '==', 'Pendente')
                                .orderBy('createdAt', 'desc')
                                .limit(1)
                                .get();
                            if (!lastOrders.empty) orderDoc = lastOrders.docs[0];
                        }
                        
                        if (orderDoc) {
                            const updates = {};
                            
                            // CORRE√á√ÉO DO ERRO ReferenceError: logMsg DEFINIDA AQUI
                            let logMsg = "Pedido Atualizado"; 

                            if (cmd.newAddress || cmd.address) {
                                const addr = cmd.newAddress || cmd.address;
                                updates.address = addr;
                                await this.db.updateDocument('clients', client.id, { lastAddress: addr });
                                logMsg = "Endere√ßo Atualizado";
                            }
                            
                            if (cmd.newItems) {
                                updates.items = cmd.newItems;
                                if(cmd.newTotal) updates.total = cmd.newTotal;
                                logMsg = "Itens Alterados";
                            }

                            updates.notes = `${orderDoc.data().notes || ''} | ${logMsg}`;

                            await orderDoc.ref.update(updates);

                            const conf = await this.db.getStoreConfig();
                            if (conf.autoPrint && conf.printerName) {
                                const updatedData = { ...orderDoc.data(), ...updates };
                                this._printOrder(orderDoc.id, updatedData);
                            }

                            const displayId = orderDoc.data().shortId || '...';
                            if (!finalReply) finalReply = `‚úÖ Pedido #${displayId} atualizado com sucesso!`;
                            result.success = true;
                        } else {
                            finalReply = "N√£o encontrei o pedido para alterar. Pode me confirmar o n√∫mero dele?";
                        }
                        break;
                        
                    case 'send_image':
                        const imgData = await this.db.getProductImagePath(cmd.id);
                        if (imgData) {
                            await this.wa.sendImage(chatId, imgData.path, `üì∏ ${imgData.name}`);
                            result.success = true;
                        }
                        break;
                }
            }

            if (finalReply.trim()) {
                // Adiciona um pequeno atraso antes de tentar enviar a mensagem principal
                // Isso d√° tempo ao whatsapp-web.js para se estabilizar
                await new Promise(resolve => setTimeout(resolve, 500)); // Espera 500ms

                const sent = await this.wa.sendText(chatId, finalReply);
                if (sent) {
                    await this.db.logMessage(client.id, { chatId, fromMe: true, body: finalReply, isAutoReply: true });
                } else {
                    console.error('[Controller] Falha ao enviar resposta da IA ap√≥s atraso.');
                    // Tenta novamente com um delay maior se falhou, como √∫ltimo recurso.
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    const retrySent = await this.wa.sendText(chatId, finalReply);
                    if (retrySent) {
                         await this.db.logMessage(client.id, { chatId, fromMe: true, body: finalReply, isAutoReply: true });
                    } else {
                        console.error('[Controller] Falha persistente ao enviar resposta da IA.');
                    }
                }
            }

            // Os setTimeout para specialActions j√° t√™m atraso, mas vamos ajust√°-los um pouco tamb√©m
            if (response.specialActions) {
                if (response.specialActions.sendAcaiMenu) {
                    const config = await this.db.getStoreConfig();
                    if (config.imgAcaiPath) {
                        // Aumenta o atraso para ter certeza que a mensagem principal j√° foi
                        setTimeout(() => this.wa.sendImage(chatId, config.imgAcaiPath, "üíú Tabela de A√ßa√≠"), 2500); 
                    }
                }
                if (response.specialActions.sendVitrine) {
                    // Aumenta o atraso
                    setTimeout(() => this._sendDailyShowcase(chatId), 3000); 
                }
            }

        } catch (error) {
            console.error('[Controller] Erro processamento IA:', error);
        }
    }
    
    
    async _sendDailyShowcase(chatId) {
        try {
            const snap = await this.db.db.collection('products')
                .where('active', '==', true)
                .where('quantity', '>', 0)
                .get();

            const itemsToSend = [];
            snap.forEach(doc => {
                const p = doc.data();
                if (p.imagePath) {
                    itemsToSend.push({ name: p.name, price: p.price, path: p.imagePath, qty: p.quantity });
                }
            });
            if (itemsToSend.length === 0) return { success: false };
            await this.wa.sendText(chatId, `üì∏ *Vitrine de Hoje:*`);
            for (const item of itemsToSend) {
                if (!fs.existsSync(item.path)) continue;
                await new Promise(r => setTimeout(r, 4000));
                try {
                    const caption = `${item.name}\nüí∞ R$ ${parseFloat(item.price).toFixed(2)}\nüì¶ Restam: ${item.qty}un`;
                    await this.wa.sendImage(chatId, item.path, caption);
                } catch (e) {}
            }
            await new Promise(r => setTimeout(r, 2000));
            await this.wa.sendText(chatId, "üòã Escolheu? √â s√≥ me falar o nome!");
            return { success: true };

        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    _setupIpcHandlers() {
        ipcMain.handle('get-whatsapp-qr', () => null);
        ipcMain.handle('get-whatsapp-status', () => this.wa.status);
        ipcMain.handle('whatsapp-initialize', () => { this.wa.initialize(); return { success: true }; });
        ipcMain.handle('whatsapp-logout', async () => { await this.wa.logout(); return { success: true }; });
        ipcMain.handle('send-whatsapp-message', async (e, rawPhone, msg) => { 
            const success = await this.wa.sendText(rawPhone, msg);
            if (success) {
                try {
                    const cleanPhone = rawPhone.replace(/\D/g, '');
                    const client = await this.db.getOrCreateClient(cleanPhone);
                    if (client && client.id) {
                        await this.db.logMessage(client.id, { chatId: rawPhone.includes('@c.us') ? rawPhone : `${cleanPhone}@c.us`, fromMe: true, body: msg, content: msg, isAutomated: false });
                    }
                } catch (e) {}
            }
            return { success }; 
        });

        ipcMain.handle('send-product-image', async (e, { chatId, imagePath, caption }) => { const success = await this.wa.sendImage(chatId, imagePath, caption); return { success }; });

        ipcMain.handle('select-product-image', async (e, productId) => {
            const { dialog } = require('electron');
            const result = await dialog.showOpenDialog(this.mainWindow, { properties: ['openFile'], filters: [{ name: 'Imagens', extensions: ['jpg', 'png', 'jpeg', 'webp'] }] });
            if (result.canceled || result.filePaths.length === 0) return { success: false };
            try {
                const sourcePath = result.filePaths[0];
                const ext = path.extname(sourcePath);
                const userDataPath = app.getPath('userData');
                const imagesDir = path.join(userDataPath, 'product_images');
                if (!fs.existsSync(imagesDir)) fs.mkdirSync(imagesDir);
                const destPath = path.join(imagesDir, `${productId}${ext}`);
                fs.copyFileSync(sourcePath, destPath);
                await this.db.updateDocument('products', productId, { imagePath: destPath });
                return { success: true, path: destPath };
            } catch (err) { return { success: false, error: err.message }; }
        });

        ipcMain.handle('send-daily-showcase', async (e, chatId) => await this._sendDailyShowcase(chatId));

        ipcMain.handle('upload-config-image', async (e, { category, buffer }) => {
            try {
                const userDataPath = app.getPath('userData');
                const configDir = path.join(userDataPath, 'config_images');
                if (!fs.existsSync(configDir)) fs.mkdirSync(configDir);
                const fileName = `${category}_menu.jpg`; 
                const filePath = path.join(configDir, fileName);
                fs.writeFileSync(filePath, Buffer.from(buffer));
                return { success: true, path: filePath };
            } catch (err) { return { success: false, error: err.message }; }
        });

        ipcMain.handle('create-scheduled-order', async (e, data) => await this.db.createScheduledOrder(data));
        ipcMain.handle('get-scheduled-orders', async () => await this.db.getScheduledOrders());
        ipcMain.handle('get-client-appointments', async (e, clientId) => await this.db.getClientAppointments(clientId));
        ipcMain.handle('delete-order', async (e, id) => await this.db.deleteDocument('orders', id));
        ipcMain.handle('update-order', async (e, { id, data }) => await this.db.updateDocument('orders', id, data));

        ipcMain.handle('update-order-status', async (e, { orderId, newStatus, shouldNotify, orderData }) => {
            const res = await this.db.updateDocument('orders', orderId, { status: newStatus });
            if (!res.success) return res;
            if (shouldNotify && this.wa.status === 'conectado') {
                try {
                    const clientDoc = await this.db.db.collection('clients').doc(orderData.clientId).get();
                    if (clientDoc.exists) {
                        const phone = clientDoc.data().phone;
                        let message = "";
                        const method = (orderData.deliveryMethod || "").toLowerCase();
                        const isDelivery = method.includes('entrega') || method.includes('delivery');
                        switch (newStatus) {
                            case 'Preparo': message = `üë©‚Äçüç≥ Ol√° ${orderData.clientName}! Seu pedido est√° sendo preparado! üç¶`; break;
                            case 'Pronto/Envio': message = isDelivery ? `üõµ Saiu para entrega!` : `üéÅ Pronto para retirada!`; break;
                            case 'Conclu√≠do': message = `üíú Pedido finalizado! Obrigado!`; break;
                        }
                        if (message) {
                            const sent = await this.wa.sendText(phone, message);
                            if (sent) {
                                const chatId = phone.includes('@') ? phone : `${phone.replace(/\D/g,'')}@c.us`;
                                await this.db.logMessage(orderData.clientId, { chatId, fromMe: true, body: message, content: message, isAutomated: true, read: true });
                            }
                        }
                    }
                } catch (e) {}
            }
            return { success: true };
        });

        ipcMain.handle('create-client-if-not-exists', async (e, data) => {
            try { 
                return { 
                    success: true, 
                    client: await this.db.getOrCreateClient(
                        data.rawPhone, 
                        data.name, 
                        data.countryCode, 
                        data.address 
                    ) 
                }; 
            } 
            catch (err) { return { success: false, error: err.message }; }
        });
        ipcMain.handle('update-client', async (e, id, data) => await this.db.updateDocument('clients', id, data));
        ipcMain.handle('delete-client', async (e, id) => await this.db.deleteDocument('clients', id));
        
        ipcMain.handle('get-products', async () => {
             const snap = await this.db.db.collection('products').orderBy('name').get();
             return { success: true, products: snap.docs.map(d => ({ id: d.id, ...d.data() })) };
        });

        ipcMain.handle('add-product', async (e, p) => {
            try { await this.db.db.collection('products').add({ ...p, price: parseFloat(p.price), quantity: 0, active: true }); return { success: true }; } catch(err) { return { success: false, error: err.message }; }
        });

        ipcMain.handle('delete-product', async (e, id) => await this.db.deleteDocument('products', id));
        ipcMain.handle('toggle-product-status', async (e, { id, isActive }) => await this.db.updateDocument('products', id, { active: isActive }));
        ipcMain.handle('update-product-stock', async (e, { id, quantity }) => await this.db.updateDocument('products', id, { quantity: parseInt(quantity) }));
        ipcMain.handle('update-ai-settings', (e, s) => { this.db.updateDocument('settings', 'storeConfig', s); this.ai.updateConfig(s); return { success: true }; });
        ipcMain.handle('print-order-manual', (e, order) => this._printOrder('manual', order));
        ipcMain.handle('get-printers', async () => ({ success: true, printers: await this.mainWindow.webContents.getPrintersAsync() }));
        ipcMain.handle('create-manual-order', async (e, order) => {
            // Gera ID num√©rico simples baseado no tempo (√∫ltimos 4 d√≠gitos)
            const shortId = Date.now().toString().slice(-4);
            return await this.db.createStandardOrder({ ...order, shortId });
        });
        
        ipcMain.handle('print-report', async (e, data) => {
            const workerWindow = new BrowserWindow({ show: false });
            const html = `<html><body><h1>Relat√≥rio Gerado</h1></body></html>`; 
            await workerWindow.loadURL(`data:text/html;charset=utf-8,${encodeURIComponent(html)}`);
            workerWindow.webContents.print({ silent: false }); 
            return { success: true };
        });

        ipcMain.handle('print-close-register', async (e, summaryData) => {
             return await this._printCloseRegister(summaryData);
        });
    }

    async _printCloseRegister(data) {
        const conf = await this.db.getStoreConfig();
        const printerName = conf.printerName || ''; 

        if (this.workerWindow) { try { this.workerWindow.close(); } catch(e){} this.workerWindow = null; }
        this.workerWindow = new BrowserWindow({ show: false, width: 400, height: 600, webPreferences: { nodeIntegration: true } });

        const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    @page { margin: 0; size: auto; }
                    body { font-family: 'Courier New', monospace; font-size: 12px; color: #000; margin: 0; padding: 0; width: 100%; background: #fff; }
                    .ticket-wrapper { width: 92%; margin: 5px auto; padding-left: 5px; }
                    .header { margin-bottom: 10px; border-bottom: 2px dashed #000; padding-bottom: 5px; text-align: center; }
                    .title { font-size: 14px; font-weight: bold; }
                    .row { display: flex; justify-content: space-between; margin-bottom: 3px; }
                    .total-row { border-top: 1px solid #000; border-bottom: 1px solid #000; margin: 10px 0; padding: 5px 0; font-weight: bold; font-size: 14px; }
                    .footer { text-align: center; margin-top: 10px; font-size: 10px; }
                </style>
            </head>
            <body>
                <div class="ticket-wrapper">
                    <div class="header">
                        <div class="title">FECHAMENTO DE CAIXA</div>
                        <div>${conf.storeName || 'Doce Floco'}</div>
                        <div style="font-size: 10px; margin-top:4px;">${data.date}</div>
                    </div>

                    <div class="row"><span>Qtd Pedidos:</span> <span>${data.count}</span></div>
                    <div style="border-bottom: 1px dashed #000; margin: 5px 0;"></div>

                    <div class="row"><span>Pix:</span> <span>R$ ${data.methods['Pix'].toFixed(2)}</span></div>
                    <div class="row"><span>Dinheiro:</span> <span>R$ ${data.methods['Dinheiro'].toFixed(2)}</span></div>
                    <div class="row"><span>Cart√£o:</span> <span>R$ ${data.methods['Cart√£o'].toFixed(2)}</span></div>
                    ${data.methods['Outros'] > 0 ? `<div class="row"><span>Outros:</span> <span>R$ ${data.methods['Outros'].toFixed(2)}</span></div>` : ''}

                    <div class="total-row row">
                        <span>TOTAL GERAL:</span>
                        <span>R$ ${data.total.toFixed(2)}</span>
                    </div>

                    <div class="footer">
                        <br>__________________________<br>
                        Assinatura Respons√°vel
                    </div>
                </div>
            </body>
            </html>
        `;

        const tempPath = path.join(app.getPath('temp'), `close_reg_${Date.now()}.html`);
        fs.writeFileSync(tempPath, html);
        
        this.workerWindow.loadURL(`file://${tempPath}`);
        this.workerWindow.webContents.once('did-finish-load', () => {
            const printOptions = { silent: true, margins: { marginType: 'none' } };
            if (printerName) printOptions.deviceName = printerName;
            this.workerWindow.webContents.print(printOptions, () => {
                setTimeout(() => { 
                    if (this.workerWindow) { this.workerWindow.close(); this.workerWindow = null; } 
                    try { fs.unlinkSync(tempPath); } catch(e){} 
                }, 5000);
            });
        });

        return { success: true };
    }

    async _printOrder(orderId, orderData) {
        const conf = await this.db.getStoreConfig();
        const printerName = conf.printerName || ''; 

        if (this.workerWindow) { try { this.workerWindow.close(); } catch(e){} this.workerWindow = null; }
        this.workerWindow = new BrowserWindow({ show: false, width: 400, height: 600, webPreferences: { nodeIntegration: true } });
        
        const { DateTime } = require('luxon');
        const dateStr = DateTime.now().setLocale('pt-BR').toLocaleString(DateTime.DATETIME_SHORT);
        
        let itemsHtml = "-";
        if (orderData.items) {
            if (Array.isArray(orderData.items)) {
                const firstItem = orderData.items[0];
                if (firstItem && typeof firstItem === 'object') {
                    itemsHtml = orderData.items.map(i => {
                        const qtd = i.qty || i.quantity || i.q || 1;
                        const nome = i.name || i.item || i.n || 'Item sem nome';
                        const obs = i.obs ? ` (${i.obs})` : '';
                        return `${qtd}x ${nome}${obs}`;
                    }).join('<br>');
                } else {
                    itemsHtml = orderData.items.join('<br>');
                }
            } 
            else if (typeof orderData.items === 'string') {
                itemsHtml = orderData.items.replace(/\n/g, '<br>');
            } 
            else {
                itemsHtml = String(orderData.items);
            }
        }

        const totalFormatted = parseFloat(orderData.total || 0).toFixed(2);
        const displayId = orderData.shortId || (typeof orderId === 'string' ? orderId.slice(0, 4).toUpperCase() : 'MANUAL');
        const addressDisplay = orderData.address && orderData.address !== 'undefined' ? orderData.address : 'Retirada/Balc√£o';
        const notesHtml = orderData.notes ? `<div style="margin-top:5px; font-weight:bold; border:1px solid #000; padding:2px; font-size:10px;">OBS: ${orderData.notes}</div>` : '';
        let loanHtml = '';
        if (orderData.loanedItems) {
            loanHtml = `<div class="divider"></div><div class="info-row"><span class="info-label">DEVOLU√á√ÉO:</span> <span class="info-val">${orderData.returnDate || 'A combinar'}</span></div><div class="items-box">EMPR√âSTIMO:<br>${orderData.loanedItems}</div>`;
        }

        const html = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    @page { margin: 0; size: auto; }
                    body { font-family: 'Courier New', monospace; font-size: 11px; color: #000; margin: 0; padding: 0; width: 100%; background: #fff; }
                    .ticket-wrapper { width: 92%; margin: 5px auto; padding-left: 5px; }
                    .header { margin-bottom: 8px; border-bottom: 1px dashed #000; padding-bottom: 5px; text-align: center; }
                    .store-name { font-size: 14px; font-weight: bold; text-transform: uppercase; }
                    .id-box { text-align:center; font-size:18px; font-weight:bold; margin: 5px 0; border: 2px solid #000; padding: 2px; }
                    .info-row { margin-bottom: 2px; display: flex; }
                    .info-label { font-weight: bold; margin-right: 4px; }
                    .info-val { flex: 1; word-wrap: break-word; }
                    .divider { border-top: 1px dashed #000; margin: 8px 0; }
                    .items-box { margin: 5px 0; line-height: 1.3; }
                    .total-box { font-size: 16px; font-weight: bold; text-align: right; margin-top: 5px; }
                    .footer { margin-top: 15px; font-size: 9px; text-align: center; }
                </style>
            </head>
            <body>
                <div class="ticket-wrapper">
                    <div class="header">
                        <div class="store-name">${conf.storeName || 'Doce Floco'}</div>
                        <div style="font-size: 9px;">${dateStr}</div>
                    </div>
                    
                    <div class="id-box">SENHA: #${displayId}</div>

                    <div class="info-row"><span class="info-label">Cliente:</span> <span class="info-val">${orderData.clientName || 'Cliente'}</span></div>
                    <div class="info-row"><span class="info-label">End:</span> <span class="info-val">${addressDisplay}</span></div>
                    <div class="info-row"><span class="info-label">Tipo:</span> <span class="info-val">${orderData.deliveryMethod || 'Balc√£o'}</span></div>
                    <div class="info-row"><span class="info-label">Pag:</span> <span class="info-val">${orderData.paymentMethod || 'A Combinar'}</span></div>
                    
                    <div class="divider"></div>
                    <div class="items-box">${itemsHtml}</div>
                    ${loanHtml}
                    ${notesHtml}
                    <div class="divider"></div>
                    
                    <div class="total-box">TOTAL: R$ ${totalFormatted}</div>
                    <div class="footer">Obrigado pela prefer√™ncia!</div>
                </div>
            </body>
            </html>
        `;

        const tempPath = path.join(app.getPath('temp'), `print_${Date.now()}.html`);
        fs.writeFileSync(tempPath, html);
        
        this.workerWindow.loadURL(`file://${tempPath}`);
        this.workerWindow.webContents.once('did-finish-load', () => {
            const printOptions = { silent: true, margins: { marginType: 'none' } };
            if (printerName) printOptions.deviceName = printerName;
            this.workerWindow.webContents.print(printOptions, () => {
                setTimeout(() => { 
                    if (this.workerWindow) { this.workerWindow.close(); this.workerWindow = null; } 
                    try { fs.unlinkSync(tempPath); } catch(e){} 
                }, 5000);
            });
        });
        return { success: true };
    }
}

module.exports = AppController;

================================================================================
ARQUIVO: /src/main/index.js
================================================================================
// --- Arquivo: src/main/index.js (Entry Point) ---
// VERS√ÉO: V4.0 - CLEAN ARCHITECTURE (REFATORADO)

const { app, BrowserWindow } = require('electron');
const path = require('path');
const dotenv = require('dotenv');
const fs = require('fs');
const admin = require('firebase-admin');

// Importa o Maestro da Aplica√ß√£o
const AppController = require('./controllers/AppController');

const isDev = !app.isPackaged;

// --- 1. Utilit√°rios de Caminho ---
function getResourcePath(relativePath) {
    if (isDev) {
        return path.join(__dirname, '../../', relativePath);
    } else {
        return path.join(process.resourcesPath, relativePath);
    }
}

// Carrega vari√°veis de ambiente
dotenv.config({ path: getResourcePath('config/.env') });

let mainWindow;
let appController; // Mant√©m refer√™ncia para n√£o ser coletado pelo GC
let db; // Inst√¢ncia do Firestore

// --- 2. Inicializa√ß√£o do Firebase (√önica responsabilidade l√≥gica aqui) ---
function initializeFirebase() {
    try {
        const serviceAccountPath = getResourcePath('config/serviceAccountKey.json');
        if (fs.existsSync(serviceAccountPath)) {
            const serviceAccount = require(serviceAccountPath);
            // Evita erro de re-inicializa√ß√£o em hot-reload
            if (!admin.apps.length) {
                admin.initializeApp({
                    credential: admin.credential.cert(serviceAccount)
                });
            }
            db = admin.firestore();
            console.log('[Main] Firebase conectado com sucesso.');
            return db;
        } else {
            console.error('[Main] CR√çTICO: serviceAccountKey.json n√£o encontrado.');
            return null;
        }
    } catch (error) {
        console.error('[Main] Erro fatal no Firebase:', error.message);
        return null;
    }
}

// --- 3. Gerenciamento de Janelas ---
function createWindow() {
    mainWindow = new BrowserWindow({
        width: 1280,
        height: 800,
        minWidth: 1024,
        minHeight: 600,
        title: 'Doce Floco Dashboard',
        icon: path.join(__dirname, '../../src/renderer/assets/icon.png'),
        webPreferences: {
            preload: path.join(__dirname, 'preload.js'),
            nodeIntegration: false,
            contextIsolation: true
        }
    });

    mainWindow.loadFile(path.join(__dirname, '../renderer/index.html'));
    
    // Em dev, pode abrir o DevTools opcionalmente
    // if (isDev) mainWindow.webContents.openDevTools();
}

// --- 4. Ciclo de Vida da Aplica√ß√£o ---
app.whenReady().then(async () => {
    // A. Cria a Interface
    createWindow();

    // B. Conecta ao Banco
    const dbInstance = initializeFirebase();

    // C. Inicializa o Controlador Principal (O "C√©rebro")
    if (dbInstance) {
        appController = new AppController(dbInstance, mainWindow);
        await appController.initialize();
    } else {
        console.error("Aplica√ß√£o iniciada sem Banco de Dados. Funcionalidades limitadas.");
    }

    app.on('activate', () => {
        if (BrowserWindow.getAllWindows().length === 0) createWindow();
    });
});

app.on('window-all-closed', async () => {
    // Garante logout limpo do WhatsApp ao fechar
    if (appController) {
        try {
            // Se tiver m√©todo de cleanup no controller
            if(appController.wa) await appController.wa.logout(); 
        } catch (e) { }
    }
    
    if (process.platform !== 'darwin') app.quit();
});

================================================================================
ARQUIVO: /src/main/preload.js
================================================================================
// --- Arquivo: src/main/preload.js ---

const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('electronAPI', {
  getFirebaseConfig: () => ({
    apiKey: process.env.FIREBASE_API_KEY,
    authDomain: process.env.FIREBASE_AUTH_DOMAIN,
    projectId: process.env.FIREBASE_PROJECT_ID,
    storageBucket: process.env.FIREBASE_STORAGE_BUCKET,
    messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID,
    appId: process.env.FIREBASE_APP_ID,
  }),
  getGeminiApiKey: () => process.env.GEMINI_API_KEY,
  getWhatsappQr: () => ipcRenderer.invoke('get-whatsapp-qr'),
  getWhatsappStatus: () => ipcRenderer.invoke('get-whatsapp-status'),
  onWhatsappQr: (callback) => ipcRenderer.on('whatsapp-qr', (event, qr) => callback(qr)),
  onWhatsappStatus: (callback) => ipcRenderer.on('whatsapp-status', (event, status) => callback(status)),
  whatsappLogout: () => ipcRenderer.invoke('whatsapp-logout'),
  whatsappInitialize: () => ipcRenderer.invoke('whatsapp-initialize'),
  sendWhatsappMessage: (number, message) => ipcRenderer.invoke('send-whatsapp-message', number, message),
  standardizePhoneNumber: (phoneNumber, countryCode) => ipcRenderer.invoke('standardize-phone-number', phoneNumber, countryCode),
  createClientIfNotExists: (data) => ipcRenderer.invoke('create-client-if-not-exists', data),
  updateClient: (clientId, updateData) => ipcRenderer.invoke('update-client', clientId, updateData),
  deleteClient: (id) => ipcRenderer.invoke('delete-client', id),
  getClientAppointments: (clientId) => ipcRenderer.invoke('get-client-appointments', clientId),
  updateAppointmentNote: (data) => ipcRenderer.invoke('update-appointment-note', data),
  deleteOrder: (id) => ipcRenderer.invoke('delete-order', id),
  updateOrderStatus: (data) => ipcRenderer.invoke('update-order-status', data),
  updateOrder: (id, data) => ipcRenderer.invoke('update-order', { id, data }),
  generateTextWithAI: (data) => ipcRenderer.invoke('generate-ai-response', data),
  updateAiSettings: (settings) => ipcRenderer.invoke('update-ai-settings', settings),
  uploadMenuFile: (fileData) => ipcRenderer.invoke('upload-menu-file', fileData),
  getProducts: () => ipcRenderer.invoke('get-products'),
  addProduct: (p) => ipcRenderer.invoke('add-product', p),
  deleteProduct: (id) => ipcRenderer.invoke('delete-product', id),
  toggleProductStatus: (data) => ipcRenderer.invoke('toggle-product-status', data),
  updateProductStock: (data) => ipcRenderer.invoke('update-product-stock', data),
  createManualOrder: (order) => ipcRenderer.invoke('create-manual-order', order),
  getPrinters: () => ipcRenderer.invoke('get-printers'),
  printOrder: (order) => ipcRenderer.invoke('print-order-manual', order),
  selectProductImage: (id) => ipcRenderer.invoke('select-product-image', id),
  sendProductImage: (data) => ipcRenderer.invoke('send-product-image', data),
  getScheduledOrders: () => ipcRenderer.invoke('get-scheduled-orders'),
  printReport: (data) => ipcRenderer.invoke('print-report', data),
  uploadConfigImage: (data) => ipcRenderer.invoke('upload-config-image', data),
  sendDailyShowcase: (chatId) => ipcRenderer.invoke('send-daily-showcase', chatId),
  createScheduledOrder: (data) => ipcRenderer.invoke('create-scheduled-order', data),
  updateScheduledOrder: (data) => ipcRenderer.invoke('update-scheduled-order', data),
  deleteScheduledOrder: (id) => ipcRenderer.invoke('delete-scheduled-order', id),
  printCloseRegister: (data) => ipcRenderer.invoke('print-close-register', data),
});

================================================================================
ARQUIVO: /src/main/services/AIService.js
================================================================================
const { GoogleGenerativeAI } = require("@google/generative-ai");

class AIService {
    constructor(apiKey, initialConfig = {}) {
        this.genAI = null;
        this.model = null;
        this.config = initialConfig;
        
        if (apiKey) {
            this.init(apiKey);
        }
    }

    init(apiKey) {
        try {
            this.genAI = new GoogleGenerativeAI(apiKey);
            this.model = this.genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
            console.log('[AI] Servi√ßo Gemini inicializado (V6.3 - Anti-Duplicidade).');
        } catch (e) {
            console.error('[AI] Falha ao iniciar Gemini:', e.message);
        }
    }

    updateConfig(newConfig) {
        this.config = { ...this.config, ...newConfig };
        if (newConfig.geminiApiKey && this.genAI && newConfig.geminiApiKey !== this.genAI.apiKey) {
            this.init(newConfig.geminiApiKey);
        }
    }

    async transcribeAudio(mediaBuffer, mimeType) {
        if (!this.model) return null;
        try {
            const result = await this.model.generateContent([
                "Transcreva este √°udio exatamente como falado. Se for apenas ru√≠do, responda [INAUD√çVEL].",
                {
                    inlineData: {
                        data: mediaBuffer.toString("base64"),
                        mimeType: mimeType
                    }
                }
            ]);
            return result.response.text().trim();
        } catch (error) {
            console.error('[AI] Erro transcri√ß√£o:', error);
            return null;
        }
    }

    async generateSalesResponse(context, userMessage) {
        if (!this.model) return { text: "", command: null };

        try {
            const systemPrompt = this._buildSystemPrompt(context);
            
            const result = await this.model.generateContent([
                systemPrompt,
                `Cliente diz: "${userMessage}"`
            ]);

            return this._parseResponse(result.response.text());

        } catch (error) {
            console.error('[AI] Erro gera√ß√£o:', error);
            return { text: "Ops, minha mente congelou por um instante! Pode repetir?", command: null };
        }
    }

    /**
     * PROMPT ENGENHARIA: COM CONTEXTO DE PEDIDO ATIVO
     */
    _buildSystemPrompt({ clientName, history, chatRecent, menuJson, todayDate, dayName, forcedContext, lastAddress, activeOrder }) {
        const { 
            storeName, deliveryFee, address,
            acaiSizes, freeAddons, paidAddons,
            minDeliveryQty     
        } = this.config;

        const knownAddressInfo = lastAddress ? `Endere√ßo Conhecido: "${lastAddress}".` : "Endere√ßo: N√£o informado.";
        const hasAcaiMenu = acaiSizes && acaiSizes.trim().length > 0;
        
        // 2. Criar a string da regra de quantidade
        let deliveryRuleText = `Taxa R$ ${parseFloat(deliveryFee || 0).toFixed(2)}. Endere√ßo obrigat√≥rio.`;

        if (minDeliveryQty && parseInt(minDeliveryQty) > 0) {
        deliveryRuleText += `
        ‚ö†Ô∏è REGRA DE PEDIDO M√çNIMO (CR√çTICO):
        - Para ENTREGA: O pedido DEVE ter no m√≠nimo ${minDeliveryQty} itens (picol√©s/copos).
        - Se o cliente pedir menos de ${minDeliveryQty} itens para entrega, RECUSE GENTILMENTE.
        - Exemplo de recusa: "Para entrega, nosso pedido m√≠nimo √© de ${minDeliveryQty} unidades. Quer completar com mais alguns?"
        - Para RETIRADA (Balc√£o): N√ÉO existe quantidade m√≠nima. Pode liberar qualquer quantidade.
        - N√ÉO gere o JSON "create_order" se for Entrega e a quantidade for menor que ${minDeliveryQty}.
        `;
        }

        // --- ALTERA√á√ÉO AQUI: L√≥gica de A√ßa√≠ ---
        let acaiSection = "";
        let acaiSilentRule = "";

        if (hasAcaiMenu) {
            acaiSection = `
            === üü£ A√áA√ç ===
            1. TAMANHOS: [${acaiSizes}].
            2. GR√ÅTIS: [${freeAddons || 'Nenhum'}].
            3. üí∞ EXTRAS (Pagos): [${paidAddons || 'Nenhum'}].
            `;
        } else {
            // Se n√£o tem a√ßa√≠, N√ÉO CRIAMOS UM CABE√áALHO VIS√çVEL.
            // Apenas uma regra interna.
            acaiSilentRule = `
            REGRA DE A√áA√ç:
            - Atualmente N√ÉO estamos servindo A√ßa√≠ (n√£o cadastrado).
            - IMPORTANTE: N√ÉO mencione que "n√£o tem a√ßa√≠" a menos que o cliente pergunte explicitamente sobre a√ßa√≠.
            - Se o cliente pedir o card√°pio ou disser "Oi", ofere√ßa apenas os picol√©s/sorvetes da vitrine.
            `;
        }

        // L√≥gica Anti-Duplicidade
        let activeOrderSection = "";
        if (activeOrder) {
            activeOrderSection = `
            === üö® PEDIDO EM ABERTO DETECTADO ===
            O cliente J√Å POSSUI um pedido PENDENTE (ID: ${activeOrder.shortId}).
            Itens Atuais: ${activeOrder.items}
            Total Atual: R$ ${activeOrder.total}
            
            REGRAS CR√çTICAS:
            1. Se o cliente quiser adicionar, remover ou mudar algo, use JSON "update_order" com "orderId": "${activeOrder.shortId}".
            2. NUNCA use "create_order" se o cliente estiver apenas continuando a conversa sobre o mesmo pedido.
            3. S√≥ use "create_order" se o cliente disser explicitamente "Quero fazer OUTRO pedido novo" ou "Cancele esse e fa√ßa outro".
            `;
        } else {
            activeOrderSection = `
            === STATUS ===
            Nenhum pedido pendente no momento. Se o cliente pedir algo e confirmar pagamento, use "create_order".
            `;
        }

        return `
        PERSONA: Atendente da ${storeName}. Data: ${todayDate}. Cliente: ${clientName}.
        LOCAL: ${address || 'Balc√£o'}.
        ${knownAddressInfo}

        ${acaiSection}

        === üç¶ ESTOQUE (VITRINE) ===
        ${menuJson}
        *Se estoque (s) = 0, diga que acabou.*

        ${activeOrderSection}

        === üö® REGRAS DE PAGAMENTO (IMPORTANTE) ===
        1. Aceitamos APENAS: **Pix**, **Dinheiro** ou **Cart√£o**.
        2. "A Combinar" N√ÉO EXISTE.
        3. **OBRIGAT√ìRIO:** Antes de confirmar o pedido, voc√™ DEVE perguntar: "Qual a forma de pagamento? (Pix, Dinheiro ou Cart√£o)".
        4. N√ÉO gere o JSON "create_order" se o cliente n√£o tiver definido o pagamento.

        === REGRAS GERAIS ===
        - Retirada: Gr√°tis.
        - Entrega: ${deliveryRuleText} 
        ${acaiSilentRule}

        === COMANDOS JSON ===
        
        A) CRIAR NOVO PEDIDO (S√≥ se n√£o houver pendente E respeitar o m√≠nimo de entrega):
        ###JSON### {"type": "create_order", "items": "...", "total": 0.00, "method": "Entrega", "payment": "Pix", "address": "..."} ###ENDJSON###
        
        B) ATUALIZAR PEDIDO EXISTENTE (Se houver pendente):
        ###JSON### {"type": "update_order", "orderId": "ID_DO_PEDIDO", "newItems": "...", "newTotal": 0.00, "newAddress": "..."} ###ENDJSON###
        *Mande apenas os campos que mudaram em update_order.*

        Hist√≥rico: ${history}
        Chat Atual:
        ${chatRecent}
        `;


    }

    _parseResponse(aiResponseText) {
        let cleanText = aiResponseText;
        let command = null;
        let sendAcaiMenu = false;
        let sendVitrine = false;

        const jsonMatch = aiResponseText.match(/###JSON###([\s\S]*?)###ENDJSON###/);
        if (jsonMatch && jsonMatch[1]) {
            try {
                command = JSON.parse(jsonMatch[1].trim());
                cleanText = cleanText.replace(jsonMatch[0], "").trim();
                
                if (command.type === 'create_order') {
                    const validPayments = ['Pix', 'Dinheiro', 'Cart√£o'];
                    let pay = command.payment || '';
                    pay = pay.charAt(0).toUpperCase() + pay.slice(1).toLowerCase();
                    if (!validPayments.includes(pay)) {
                        command = null; 
                    } else {
                        command.payment = pay;
                    }
                }

            } catch (e) {
                console.error("[AI] JSON Parse Error:", e);
            }
        }

        if (cleanText.includes('###SEND_ACAI_MENU###')) {
            sendAcaiMenu = true;
            cleanText = cleanText.split('###SEND_ACAI_MENU###').join('').trim();
        }

        if (cleanText.includes('###SEND_DAILY_VITRINE###')) {
            sendVitrine = true;
            cleanText = cleanText.split('###SEND_DAILY_VITRINE###').join('').trim();
        }
        
        return { text: cleanText, command, specialActions: { sendAcaiMenu, sendVitrine } };
    }
}

module.exports = AIService;

================================================================================
ARQUIVO: /src/main/services/DatabaseService.js
================================================================================
const admin = require('firebase-admin');
const { DateTime } = require('luxon');

class DatabaseService {
    constructor(dbInstance) {
        this.db = dbInstance;
    }

    /**
     * Busca configura√ß√µes da loja e mescla com defaults
     */
    async getStoreConfig() {
        try {
            const doc = await this.db.collection('settings').doc('storeConfig').get();
            if (doc.exists) return doc.data();
            return {};
        } catch (error) {
            console.error('[DB] Erro ao ler config:', error);
            return {};
        }
    }

    /**
     * Retorna itens para o menu da IA e Frontend
     * @returns {Object} { menuText: string, menuStructured: Array }
     */
    async getActiveProducts() {
        try {
            const snapshot = await this.db.collection('products').where('active', '==', true).get();
            const menuStructured = []; 
            const menuLines = [];      
            snapshot.forEach(doc => {
                const p = doc.data();
                const stock = parseInt(p.quantity || 0);
                const price = typeof p.price === 'number' ? p.price.toFixed(2) : p.price;
                const hasImage = !!p.imagePath;
                let stockInfo = "";
                if (stock <= 0) stockInfo = "[ESGOTADO]";
                menuLines.push(`- ${p.name} (R$ ${price}) ${stockInfo}`);
                menuStructured.push({ id: doc.id, n: p.name, p: price, s: stock, img: hasImage });
            });
            return { menuStructured, menuText: menuLines };
        } catch (error) {
            console.error('[DB] Erro ao buscar produtos:', error);
            return { menuStructured: [], menuText: [] };
        }
    }

    async getLastPendingOrder(clientId) {
        try {
            const snapshot = await this.db.collection('orders').where('clientId', '==', clientId).where('status', '==', 'Pendente').orderBy('createdAt', 'desc').limit(1).get();
            if (snapshot.empty) return null;
            const doc = snapshot.docs[0];
            return { id: doc.id, ...doc.data() };
        } catch (error) { return null; }
    }

    async isDuplicateOrder(clientId, items, total, date) {
        const twoMinsAgo = admin.firestore.Timestamp.fromMillis(Date.now() - 120000);
        const snapshot = await this.db.collection('orders').where('clientId', '==', clientId).where('status', '==', 'Agendado').where('createdAt', '>', twoMinsAgo).get();
        let isDuplicate = false;
        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.items === items && parseFloat(d.total) === parseFloat(total) && d.dueDate === date) isDuplicate = true;
        });
        return isDuplicate;
    }

    /**
     * Cria uma Encomenda (Agendamento)
     * ATUALIZADO: Suporte a Empr√©stimo de Materiais (Caixas, Carrinhos)
     */
    async createScheduledOrder({ clientId, clientName, items, total, date, method, address, loanedItems, returnDate }) {
        const isDup = await this.isDuplicateOrder(clientId, items, total, date);
        if (isDup) {
            console.log(`[Anti-Dup] Pedido ignorado para ${clientName}`);
            return { success: true, note: 'duplicate_prevented' };
        }

        // 2. Grava√ß√£o
        const orderData = {
            clientId,
            clientName,
            items: items || "Encomenda Personalizada",
            total: total || 0,
            deliveryMethod: method || "Retirada",
            paymentMethod: "Sinal Pendente",
            status: "Agendado",
            dueDate: date, // Data do Evento
            address: address || "",
            
            // Novos Campos para Encomendas de Festa
            isPreOrder: true,
            loanedItems: loanedItems || "", // Ex: "1 Caixa Isopor 50L"
            returnDate: returnDate || "",   // Data para devolu√ß√£o
            
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
            notes: loanedItems ? `‚ö†Ô∏è EMPR√âSTIMO: Devolu√ß√£o em ${returnDate}` : "Encomenda"
        };
        await this.db.collection('orders').add(orderData);
        return { success: true, type: 'scheduled' };
    }

      /**
     * Cria Pedido com TRANSA√á√ÉO (Atualizado com ShortID)
     */
    async createStandardOrder({ clientId, clientName, items, total, method, payment, address, cart, shortId }) {
        const orderRef = this.db.collection('orders').doc();
        // --- CORRE√á√ÉO: Garante que o ID exista para o log e grava√ß√£o ---
        const finalShortId = shortId || "0000";

        try {
            await this.db.runTransaction(async (t) => {
                const pendingUpdates = []; 

                if (cart && Array.isArray(cart) && cart.length > 0) {
                    for (const item of cart) {
                        if (!item.id) continue;
                        const productRef = this.db.collection('products').doc(item.id);
                        const productDoc = await t.get(productRef); 

                        if (!productDoc.exists) {
                            console.warn(`Produto ID ${item.id} n√£o encontrado para baixa.`);
                            continue;
                        }

                        const pData = productDoc.data();
                        const currentQty = parseInt(pData.quantity || 0);
                        const soldQty = parseInt(item.qty || item.quantity || 1);

                        if (currentQty < soldQty) {
                            throw new Error(`Estoque insuficiente para: ${pData.name} (Restam: ${currentQty})`);
                        }

                        pendingUpdates.push({ ref: productRef, newQty: currentQty - soldQty });
                    }
                }

                for (const update of pendingUpdates) {
                    t.update(update.ref, { quantity: update.newQty });
                }

                t.set(orderRef, {
                    shortId: finalShortId, // Usa a constante segura
                    clientId, clientName, items: items || "Venda", total: total || 0,
                    deliveryMethod: method || "A Combinar", address: address || "Retirada",
                    paymentMethod: payment || "A Combinar", status: "Pendente",
                    createdAt: admin.firestore.FieldValue.serverTimestamp(),
                    notes: "Pedido Autom√°tico", cart: cart || []
                });
            });

            console.log(`[DB] Pedido #${finalShortId} criado e estoque atualizado.`);
            return { success: true, orderId: orderRef.id, shortId: finalShortId };

        } catch (e) {
            console.error("[DB] Falha na transa√ß√£o:", e.message);
            return { success: false, error: e.message };
        }
    }

    /**
     * Busca pedido pelo ID Curto (Para a IA editar)
     */
    async getOrderByShortId(shortId) {
        try {
            const snapshot = await this.db.collection('orders')
                .where('shortId', '==', String(shortId))
                .limit(1)
                .get();
            
            if (snapshot.empty) return null;
            return snapshot.docs[0]; // Retorna o DocumentSnapshot
        } catch (e) {
            console.error('[DB] Erro busca shortId:', e);
            return null;
        }
    }

    /**
     * Busca ou cria cliente baseado no telefone (ATUALIZADO)
     */
    async getOrCreateClient(rawPhone, name, countryCode = '55', address = null) {
        let inputClean = rawPhone.replace('@c.us', '').replace(/\D/g, '');
        const candidates = new Set([inputClean, `+${inputClean}`]);
        if (inputClean.startsWith('55') && inputClean.length >= 12) {
            const ddd = inputClean.substring(2, 4);
            const numberPart = inputClean.substring(4);
            if (numberPart.length === 9) { 
                candidates.add(`+55${ddd}${numberPart.substring(1)}`);
                candidates.add(`55${ddd}${numberPart.substring(1)}`);
            } else if (numberPart.length === 8) { 
                candidates.add(`+55${ddd}9${numberPart}`);
                candidates.add(`55${ddd}9${numberPart}`);
            }
        }
        const snapshot = await this.db.collection('clients').where('phone', 'in', Array.from(candidates)).limit(1).get();
        if (!snapshot.empty) {
            const doc = snapshot.docs[0];
            const data = doc.data();
            let updates = {};
            if (name && name !== "Cliente" && data.name.startsWith("Cliente ") && name !== data.name) {
                updates.name = name;
            }
            if (address && !data.address) {
                updates.address = address;
                updates.lastAddress = address; // Mant√©m sincronizado para a IA
            }

            if(Object.keys(updates).length > 0) {
                updates.updatedAt = admin.firestore.FieldValue.serverTimestamp();
                await doc.ref.update(updates);
                return { id: doc.id, ...data, ...updates };
            }
            return { id: doc.id, ...data };
        }
        const newClient = {
            name: name || `Cliente ${inputClean.slice(-4)}`,
            phone: `+${inputClean}`,
            countryCode,
            address: address || null,         // Campo Fixo
            lastAddress: address || null,     // Campo Din√¢mico (Usado pela IA no delivery)
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
            aiPaused: false
        };
        const ref = await this.db.collection('clients').add(newClient);
        return { id: ref.id, ...newClient };
    }

    async logMessage(clientId, messageData) {
        return this.db.collection('clients').doc(clientId).collection('messages').add({
            ...messageData,
            timestamp: admin.firestore.FieldValue.serverTimestamp()
        });
    }

    async getClientHistory(clientId) {
        const snapshot = await this.db.collection('orders')
            .where('clientId', '==', clientId)
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();

        if (snapshot.empty) return "Hist√≥rico: Nenhum pedido anterior.";
        return snapshot.docs.map(doc => {
            const d = doc.data();
            const date = d.createdAt ? DateTime.fromJSDate(d.createdAt.toDate()).toLocaleString(DateTime.DATE_SHORT) : '?';
            return `${date}: ${d.items} (R$${d.total}) - Status: ${d.status}`;
        }).join("\n");
    }

    async getRecentChat(clientId) {
        const snapshot = await this.db.collection('clients').doc(clientId)
            .collection('messages')
            .orderBy('timestamp', 'desc')
            .limit(8)
            .get();

        if (snapshot.empty) return "";
        const history = [];
        snapshot.forEach(doc => {
            const d = doc.data();
            const content = d.body || d.content || "";
            if (!content.includes('###JSON###')) {
                history.push(`${d.fromMe ? "Atendente" : "Cliente"}: ${content}`);
            }
        });
        return history.reverse().join("\n");
    }
    
    async getProductImagePath(productId) {
        const doc = await this.db.collection('products').doc(productId).get();
        if(doc.exists && doc.data().imagePath) return { path: doc.data().imagePath, name: doc.data().name };
        return null;
    }

    /**
     * Retorna todas as encomendas agendadas
     */
    async getScheduledOrders() {
        try {
            const snapshot = await this.db.collection('orders')
                .where('status', '==', 'Agendado')
                .get();
            
            const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            return { success: true, orders };
        } catch (err) {
            console.error('[DB] Erro getScheduledOrders:', err);
            return { success: false, error: err.message };
        }
    }

    /**
     * Retorna hist√≥rico de pedidos de um cliente espec√≠fico (formatado para UI)
     */
    async getClientAppointments(clientId) {
        try {
            const { DateTime } = require('luxon');
            const snapshot = await this.db.collection('orders')
                .where('clientId', '==', clientId)
                .orderBy('createdAt', 'desc') // Requer √≠ndice no Firebase, se der erro, remova o orderBy temporariamente
                .limit(10)
                .get();

            if (snapshot.empty) return { success: true, appointments: [] };
            const appointments = snapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    rawDate: data.createdAt ? data.createdAt.toDate() : new Date(0),
                    date: data.createdAt 
                        ? DateTime.fromJSDate(data.createdAt.toDate()).toLocaleString(DateTime.DATETIME_SHORT) 
                        : 'Data n/d',
                    time: `R$ ${parseFloat(data.total || 0).toFixed(2)}`,
                    service: data.items
                };
            });
            appointments.sort((a, b) => b.rawDate - a.rawDate);
            return { success: true, appointments };
        } catch (error) {
            console.error("[DB] Erro getClientAppointments:", error);
            return { success: false, error: error.message };
        }
    }

    async deleteDocument(collection, id) {
        try {
            await this.db.collection(collection).doc(id).delete();
            return { success: true };
        } catch (e) {
            return { success: false, error: e.message };
        }
    }

    async updateDocument(collection, id, data) {
        try {
            await this.db.collection(collection).doc(id).update(data);
            return { success: true };
        } catch (e) {
            return { success: false, error: e.message };
        }
    }
}

module.exports = DatabaseService;

================================================================================
ARQUIVO: /src/main/services/WhatsappService.js
================================================================================
const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const EventEmitter = require('events');
const fs = require('fs');
const path = require('path');

class WhatsappService extends EventEmitter {
    constructor(sessionPath, chromePath, isDev) {
        super();
        this.client = null;
        this.sessionPath = sessionPath;
        this.chromePath = chromePath;
        this.isDev = isDev;
        this.reconnectTimer = null;
        this.status = 'desconectado';
    }

    initialize() {
        if (this.reconnectTimer) clearTimeout(this.reconnectTimer);
        
        if (this.client) {
            try { this.client.destroy(); } catch(e){}
            this.client = null;
        }

        console.log('[WhatsApp] Inicializando com FIX de VERS√ïES: w-w.js@1.19.5 + puppeteer@13.0.0 + Web@2.2307.7 (DEBUG)...');

        this.client = new Client({
            authStrategy: new LocalAuth({ 
                clientId: 'doce-floco-session', 
                dataPath: this.sessionPath 
            }),
            // --- FIX CR√çTICO: FOR√áAR VERS√ÉO EST√ÅVEL DO WHATSAPP WEB ---
            // Esta vers√£o (2.2307.7) √© mais compat√≠vel com puppeteer v13 e w-w.js v1.19.5
            webVersionCache: {
                type: 'remote',
                remotePath: 'https://raw.githubusercontent.com/wppconnect-team/wa-version/main/html/2.2307.7.html',
            },
            // --- Mantenha autoMarkRead: false ---
            autoMarkRead: false,
            // ------------------------------------
            puppeteer: {
                headless: false, // Mantenha false para observar o que acontece
                executablePath: this.chromePath, // Usar√° o Chromium compat√≠vel com Puppeteer 13.0.0
                args: [
                    '--no-sandbox', 
                    '--disable-setuid-sandbox',
                    '--disable-dev-shm-usage',
                    '--disable-accelerated-2d-canvas',
                    '--no-first-run',
                    '--no-zygote',
                    '--disable-gpu',
                    '--window-size=1280,800', 
                    '--disable-web-security',
                    '--disable-features=IsolateOrigins,site-per-process'
                ]
            }
        });

        this._setupListeners();
        
        this.client.initialize().catch(err => {
            console.error('[WhatsApp] Falha cr√≠tica na inicializa√ß√£o:', err.message);
            this.emit('status', 'erro_inicializacao');
            this._scheduleReconnect();
        });
    }

    _setupListeners() {
        this.client.on('qr', (qr) => {
            console.log('[WhatsApp] QR Code gerado.');
            this.status = 'aguardando_scan';
            this.emit('qr', qr);
            this.emit('status', this.status);
        });

        this.client.on('ready', () => {
            console.log('[WhatsApp] Conectado e Pronto!');
            this.status = 'conectado';
            this.emit('ready');
            this.emit('status', this.status);
            this.emit('qr', ''); 
        });

        this.client.on('auth_failure', (msg) => {
            console.error('[WhatsApp] Falha de autentica√ß√£o:', msg);
            this.status = 'desconectado';
            this.emit('status', 'erro_autenticacao');
            this._scheduleReconnect();
        });

        this.client.on('disconnected', (reason) => {
            console.log('[WhatsApp] Desconectado:', reason);
            this.status = 'desconectado';
            this.emit('status', this.status);
            this._scheduleReconnect();
        });

        this.client.on('message', async (message) => {
            if (message.isStatus || message.from.includes('@g.us') || message.from.includes('@broadcast')) return;
            this.emit('message', message);
        });
    }

    _scheduleReconnect() {
        if (this.reconnectTimer) clearTimeout(this.reconnectTimer);
        this.reconnectTimer = setTimeout(() => {
            console.log('[WhatsApp] Tentando reconectar automaticamente...');
            this.initialize();
        }, 15000);
    }

    async logout() {
        if (this.client) {
            try { await this.client.logout(); } catch(e){ console.warn('[WhatsApp] Erro ao fazer logout:', e.message); }
            try { await this.client.destroy(); } catch(e){ console.warn('[WhatsApp] Erro ao destruir cliente:', e.message); }
            this.client = null;
            this.status = 'desconectado';
            this.emit('status', this.status);
            if (this.reconnectTimer) clearTimeout(this.reconnectTimer);
        }
    }

    async sendText(to, text) {
        if (this.status !== 'conectado' || !this.client) {
            console.warn('[WhatsApp] N√£o conectado ou cliente indispon√≠vel para enviar texto.');
            return false;
        }
        try {
            let clean = to.toString().replace(/\D/g, '');
            if ((clean.length === 10 || clean.length === 11) && !clean.startsWith('55')) clean = '55' + clean;
            const finalId = clean.includes('@c.us') ? clean : `${clean}@c.us`;

            console.log(`[WhatsApp-DEBUG] Tentando enviar mensagem. ID: ${finalId}, Texto: "${text.substring(0, 50)}..."`);
            
            await this.client.sendMessage(finalId, text);
            console.log(`[WhatsApp-DEBUG] Mensagem enviada com sucesso para ${finalId}.`);
            return true;
        } catch (error) {
            console.error(`[WhatsApp] Erro envio texto para ${to}:`, error.message);
            if (error.message.includes('markedUnread') || error.message.includes('multiple-uim-roots')) {
                console.error(`[WhatsApp-DEBUG] ERRO CR√çTICO de COMPATIBILIDADE. O WhatsApp Web (vers√£o ${this.client.info ? this.client.info.webVersion : 'desconhecida'}) pode estar incompat√≠vel com o w-w.js ${require('whatsapp-web.js/package.json').version}.`);
            }
            return false;
        }
    }

    async sendImage(to, filePath, caption = "") {
        if (this.status !== 'conectado' || !this.client) {
            console.warn('[WhatsApp] N√£o conectado ou cliente indispon√≠vel para enviar imagem.');
            return false;
        }
        try {
            let clean = to.toString().replace(/\D/g, '');
            if ((clean.length === 10 || clean.length === 11) && !clean.startsWith('55')) clean = '55' + clean;
            const finalId = clean.includes('@c.us') ? clean : `${clean}@c.us`;

            if (fs.existsSync(filePath)) {
                const media = MessageMedia.fromFilePath(filePath);
                await this.client.sendMessage(finalId, media, { caption });
                return true;
            }
            console.warn(`[WhatsApp] Imagem n√£o encontrada ou inv√°lida: ${filePath}`);
            return false;
        } catch (error) {
            console.error('[WhatsApp] Erro envio imagem:', error.message);
            return false;
        }
    }
}

module.exports = WhatsappService;

================================================================================
ARQUIVO: /src/renderer/assets/js/core/App.js
================================================================================

import { FirebaseService } from '../services/FirebaseService.js';
import { Router } from './Router.js';
import { $, hide, show } from '../utils/DOM.js';

// Importe seus m√≥dulos aqui
import { KanbanModule } from '../modules/KanbanModule.js';
import { DashboardModule } from '../modules/DashboardModule.js';
import { ChatModule } from '../modules/ChatModule.js';
import { ConnectionModule } from '../modules/ConnectionModule.js';
import { ClientsModule } from '../modules/ClientsModule.js';
import { CalendarModule } from '../modules/CalendarModule.js';
import { SettingsModule } from '../modules/SettingsModule.js';
import { PosModule } from '../modules/PosModule.js';
import { ReportsModule } from '../modules/ReportsModule.js';

class App {
    constructor() {
        this.firebase = FirebaseService.getInstance();
        
        // REGISTRE AQUI OS NOVOS M√ìDULOS
        this.modules = {
            'dashboard': new DashboardModule(),
            'pedidos': new KanbanModule(),
            'conversas': new ChatModule(),
            'whatsapp': new ConnectionModule(), 
            'clientes': new ClientsModule(),
            'encomendas': new CalendarModule(),
            'config': new SettingsModule(),
            'pos': new PosModule(),
            'relatorios': new ReportsModule()
        };

        this.router = new Router(this.modules);
    }

    init() {
        console.log('[App] Inicializando Doce Floco Dashboard V5.0...');
        
        /** 
         * CR√çTICO: Tornamos a inst√¢ncia da App global.
         * Isso permite que o HTML gerado dinamicamente (como no PDV/POS)
         * consiga chamar fun√ß√µes como: window.app.modules.pos.updateQty()
         */
        window.app = this;

        // Listener de Autentica√ß√£o
        this.firebase.auth.onAuthStateChanged(user => {
            if (user) {
                this._onLogin(user);
            } else {
                this._onLogout();
            }
        });

        // Inicializa listeners do formul√°rio de login (submit, etc)
        this._setupAuthForm();
    }

    _onLogin(user) {
        if ($('userEmail')) $('userEmail').textContent = user.email;
        hide($('authSection'));
        show($('appSection'));
        
        // Inicia na Dashboard (ou Pedidos se Dashboard n√£o estiver pronta)
        this.router.navigateTo('dashboard'); 
    }

    _onLogout() {
        if ($('userEmail')) $('userEmail').textContent = '';
        show($('authSection'));
        hide($('appSection'));
    }

    _setupAuthForm() {
        const form = $('loginForm');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const email = form.email.value;
                    const pass = form.password.value;
                    await this.firebase.auth.signInWithEmailAndPassword(email, pass);
                    form.reset();
                } catch (error) {
                    const msg = $('authMessage');
                    if(msg) {
                        msg.textContent = `Erro: ${error.message}`;
                        show(msg);
                    }
                }
            });
        }
        
        const logoutBtn = $('logoutButtonSidebar');
        if(logoutBtn) logoutBtn.addEventListener('click', () => this.firebase.auth.signOut());
    }
}

// Inicializa√ß√£o Global
document.addEventListener('DOMContentLoaded', () => {
    const app = new App();
    app.init();
});

================================================================================
ARQUIVO: /src/renderer/assets/js/core/Router.js
================================================================================
import { $, hideAll, show } from '../utils/DOM.js';

export class Router {
    constructor(modules) {
        this.modules = modules; // Objeto com as inst√¢ncias dos m√≥dulos
        this.currentModule = null;
        this.setupListeners();
    }

    setupListeners() {
        const links = document.querySelectorAll('.nav-item');
        links.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                this.navigateTo(section);
            });
        });
    }

    navigateTo(sectionId) {
        // 1. UI: Esconde todas as se√ß√µes
        hideAll('.content-section');
        
        // 2. UI: Atualiza Sidebar
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('bg-slate-800'));
        const activeNav = $(`nav${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
        if(activeNav) activeNav.classList.add('bg-slate-800');

        // 3. UI: Atualiza T√≠tulo
        const titles = { 
            'dashboard': 'Vis√£o Geral', 
            'clientes': 'Gerenciar Clientes', 
            'pedidos': 'Kanban de Pedidos', 
            'encomendas': 'Gest√£o de Encomendas', 
            'whatsapp': 'Conex√£o WhatsApp', 
            'conversas': 'Atendimento', 
            'config': 'Configura√ß√£o da Loja',
            'pos': 'PDV - Ponto de Venda',
            'relatorios': 'Relat√≥rios e An√°lises'
        };
        const titleEl = $('currentSectionTitle');
        if(titleEl) titleEl.textContent = titles[sectionId] || 'App';

        // 4. L√≥gica: Desliga m√≥dulo anterior (Ex: para listeners do Firebase)
        if (this.currentModule && this.currentModule.destroy) {
            this.currentModule.destroy();
        }

        // 5. L√≥gica: Inicia novo m√≥dulo
        if (this.modules[sectionId]) {
            this.currentModule = this.modules[sectionId];
            if (this.currentModule.init) this.currentModule.init();
        }

        // 6. UI: Mostra a nova se√ß√£o
        const sectionEl = $(`section${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
        show(sectionEl);
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/CalendarModule.js
================================================================================
import { $, show, hide } from '../utils/DOM.js';
import { UI } from '../utils/UI.js';
import { CalendarService } from '../services/CalendarService.js';
import { ClientService } from '../services/ClientService.js';

export class CalendarModule {
    constructor() {
        this.service = new CalendarService();
        this.clientService = new ClientService();
        this.DateTime = luxon.DateTime; 
        this.currentDate = this.DateTime.now();

        // Elementos UI Principal
        this.grid = $('calendarGrid');
        this.monthLabel = $('currentMonthLabel');
        this.btnPrev = $('btnPrevMonth');
        this.btnNext = $('btnNextMonth');
        this.btnNew = $('btnNewEncomenda');

        // Modal Encomenda (Novo)
        this.modal = $('encomendaModal');
        this.form = $('encomendaForm');
        this.clientSelect = $('encClientSelect');
        this.btnClose = $('closeEncomendaModal');
        this.btnDelete = $('btnDeleteEncomenda');

        // Bindings
        this.changeMonth = this.changeMonth.bind(this);
        this.handleSave = this.handleSave.bind(this);
        this.openModal = this.openModal.bind(this);
    }

    init() {
        console.log('[Calendar] Iniciando Gest√£o de Encomendas...');
        this.renderCalendar();
        this.loadClients();

        // Listeners Navega√ß√£o
        if (this.btnPrev) this.btnPrev.onclick = () => this.changeMonth(-1);
        if (this.btnNext) this.btnNext.onclick = () => this.changeMonth(1);
        
        // Listener Novo Agendamento
        if (this.btnNew) this.btnNew.onclick = () => this.openModal();

        // Listeners Modal
        if (this.form) this.form.onsubmit = this.handleSave;
        if (this.btnClose) this.btnClose.onclick = () => hide(this.modal);
        if (this.btnDelete) this.btnDelete.onclick = async () => {
             if(await UI.confirm('Excluir', 'Tem certeza?', 'Excluir', 'red')) {
                 const id = $('encId').value;
                 if(id) {
                     await this.service.deleteOrder(id);
                     hide(this.modal);
                     this.renderCalendar();
                 }
             }
        };
    }

    loadClients() {
        this.clientService.listenToClients((clients) => {
            if(!this.clientSelect) return;
            this.clientSelect.innerHTML = '<option value="">Selecione o Cliente...</option>';
            clients.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                this.clientSelect.appendChild(opt);
            });
        });
    }

    changeMonth(direction) {
        this.currentDate = this.currentDate.plus({ months: direction });
        this.renderCalendar();
    }

    async renderCalendar() {
        if (!this.grid || !this.monthLabel) return;

        this.grid.innerHTML = '<div class="col-span-7 text-center py-10"><i class="fas fa-spinner fa-spin"></i></div>';
        this.monthLabel.textContent = this.currentDate.setLocale('pt-BR').toFormat('MMMM yyyy').toUpperCase();

        const res = await this.service.getScheduledOrders();
        const scheduledOrders = (res.success && res.orders) ? res.orders : [];

        this.grid.innerHTML = '';

        const firstDay = this.currentDate.startOf('month');
        const daysInMonth = this.currentDate.daysInMonth;
        const startDayOfWeek = firstDay.weekday === 7 ? 0 : firstDay.weekday;

        // Dias vazios
        for (let i = 0; i < startDayOfWeek; i++) {
            const empty = document.createElement('div');
            empty.className = 'bg-gray-50 opacity-30 border border-gray-100 rounded-lg';
            this.grid.appendChild(empty);
        }

        // Dias do M√™s
        for (let i = 1; i <= daysInMonth; i++) {
            const currentDayDate = firstDay.set({ day: i });
            const dateStr = currentDayDate.toFormat('yyyy-MM-dd');
            const isToday = dateStr === this.DateTime.now().toFormat('yyyy-MM-dd');

            // Filtra encomendas
            const daysOrders = scheduledOrders.filter(o => o.dueDate === dateStr);

            const cell = document.createElement('div');
            cell.className = `border rounded-lg p-2 flex flex-col relative h-32 transition overflow-hidden group hover:border-purple-400 ${isToday ? 'bg-purple-50 border-purple-300' : 'bg-white border-gray-100'}`;
            
            cell.innerHTML = `<span class="text-xs font-bold ${isToday ? 'text-purple-600' : 'text-gray-400'} mb-1">${i}</span>`;
            
            // Bot√£o "+" no hover do dia
            const addBtn = document.createElement('button');
            addBtn.className = 'absolute top-1 right-1 text-purple-400 hover:text-purple-700 opacity-0 group-hover:opacity-100 transition text-xs';
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.onclick = (e) => { e.stopPropagation(); this.openModal(null, dateStr); };
            cell.appendChild(addBtn);

            const listDiv = document.createElement('div');
            listDiv.className = 'flex-1 overflow-y-auto space-y-1 custom-scrollbar';
            
            daysOrders.forEach(o => {
                const badge = document.createElement('div');
                const hasLoan = !!o.loanedItems;
                // Cor diferente se tiver empr√©stimo (Laranja) ou normal (Roxo)
                const colorClass = hasLoan 
                    ? 'bg-orange-100 text-orange-700 border-orange-200' 
                    : 'bg-purple-100 text-purple-700 border-purple-200';

                badge.className = `text-[9px] px-1 py-0.5 rounded truncate cursor-pointer border hover:opacity-80 transition ${colorClass}`;
                badge.innerHTML = `${hasLoan ? '<i class="fas fa-box text-[8px] mr-1"></i>' : ''} ${o.clientName.split(' ')[0]}`;
                
                badge.onclick = (e) => { e.stopPropagation(); this.openModal(o); };
                listDiv.appendChild(badge);
            });

            cell.appendChild(listDiv);
            this.grid.appendChild(cell);
        }
    }

    openModal(order = null, preSelectedDate = null) {
        // Reset Form
        this.form.reset();
        $('encId').value = '';
        show(this.btnDelete); // Default show, hide se for novo
        
        if (order) {
            // EDI√á√ÉO
            $('encId').value = order.id;
            this.clientSelect.value = order.clientId;
            $('encDate').value = order.dueDate;
            $('encItems').value = order.items;
            $('encTotal').value = parseFloat(order.total || 0).toFixed(2);
            $('encAddress').value = order.address || '';
            
            // Carrega Pagamento (NOVO)
            if(order.paymentMethod) $('encPayment').value = order.paymentMethod;
            
            // Novos campos empr√©stimo
            $('encLoanedItems').value = order.loanedItems || '';
            $('encReturnDate').value = order.returnDate || '';
            
            show(this.btnDelete);
        } else {
            // NOVO
            hide(this.btnDelete);
            if (preSelectedDate) $('encDate').value = preSelectedDate;
        }

        show(this.modal);
    }

    async handleSave(e) {
        e.preventDefault();
        
        const id = $('encId').value;
        const clientId = this.clientSelect.value;
        if(!clientId) { UI.toast('Selecione um cliente', 'error'); return; }
        
        const clientName = this.clientSelect.options[this.clientSelect.selectedIndex].text;
        
        const data = {
            clientId,
            clientName,
            date: $('encDate').value,
            items: $('encItems').value,
            total: parseFloat($('encTotal').value) || 0,
            address: $('encAddress').value,
            loanedItems: $('encLoanedItems').value,
            returnDate: $('encReturnDate').value,
            // Salva Pagamento
            paymentMethod: $('encPayment').value,
            method: $('encAddress').value ? 'Entrega' : 'Retirada'
        };

        try {
            if (id) {
                // Update
                const res = await this.service.updateOrder(id, {
                    dueDate: data.date,
                    items: data.items,
                    total: data.total,
                    address: data.address,
                    deliveryMethod: data.method,
                    paymentMethod: data.paymentMethod, // Envia para o banco
                    loanedItems: data.loanedItems,
                    returnDate: data.returnDate,
                    notes: data.loanedItems ? `‚ö†Ô∏è EMPR√âSTIMO: Devolu√ß√£o em ${data.returnDate}` : ''
                });
                if(res.success) UI.toast('Encomenda atualizada!');
            } else {
                // Create
                const res = await window.electronAPI.createScheduledOrder(data);
                if(res.success) UI.toast('Encomenda agendada!');
            }
            hide(this.modal);
            this.renderCalendar();
        } catch (err) {
            UI.alert('Erro', err.message);
        }
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/ChatModule.js
================================================================================
import { $, show, hide } from '../utils/DOM.js';
import { UI } from '../utils/UI.js';
import { FirebaseService } from '../services/FirebaseService.js';

export class ChatModule {
    constructor() {
        this.db = FirebaseService.getInstance().db;
        this.unsubList = null;
        this.unsubChat = null;
        this.currentChatId = null;

        // Elementos UI
        this.listEl = $('conversationsList');
        this.chatWindow = $('chatWindow');
        this.messagesContainer = $('messagesContainer');
        this.clientNameEl = $('currentChatClientName');
        this.emptyState = $('emptyChatState');
        this.input = $('chatMessageInput');
        this.sendBtn = $('sendChatMessageButton');
        this.aiToggle = $('aiToggleSwitch');
        this.galleryBtn = $('btnQuickGallery');
    }

    init() {
        console.log('[Chat] Iniciando...');
        this.loadConversations();
        this.setupInputListeners();
    }

    destroy() {
        if (this.unsubList) this.unsubList();
        if (this.unsubChat) this.unsubChat();
        console.log('[Chat] Finalizado.');
    }

    loadConversations() {
        // Ouve a lista de clientes em tempo real
        this.unsubList = this.db.collection('clients').orderBy('name', 'asc').onSnapshot(snap => {
            this.listEl.innerHTML = '';
            if (snap.empty) {
                this.listEl.innerHTML = '<p class="text-gray-500 text-sm p-4">Nenhum cliente.</p>';
                return;
            }
            snap.forEach(doc => {
                const c = doc.data();
                const div = document.createElement('div');
                div.className = 'p-4 hover:bg-purple-50 cursor-pointer border-b transition flex justify-between items-center';
                // Marca visualmente se for o chat ativo
                if(doc.id === this.currentChatId) div.classList.add('bg-purple-100');
                
                div.innerHTML = `
                    <span class="font-bold text-gray-700">${c.name}</span>
                    <i class="fas fa-chevron-right text-xs text-gray-300"></i>
                `;
                div.onclick = () => this.openChat(doc.id, c.name, c.phone);
                this.listEl.appendChild(div);
            });
        });
    }

    async openChat(clientId, name, phone) {
        this.currentChatId = clientId;
        this.clientNameEl.innerText = name;
        this.clientNameEl.dataset.phone = phone; // Armazena telefone para envio
        
        show(this.chatWindow);
        hide(this.emptyState);

        // Configura Toggle da IA
        if (this.aiToggle) {
            try {
                const doc = await this.db.collection('clients').doc(clientId).get();
                if(doc.exists) {
                    // Se aiPaused = true, o toggle deve estar unchecked (IA desligada)
                    // Se aiPaused = false (ou undefined), toggle checked (IA ativa)
                    const isPaused = doc.data().aiPaused === true;
                    this.aiToggle.checked = !isPaused;
                }
            } catch(e) { console.error(e); }
            
            // Listener do Toggle (Remove anterior para evitar duplicidade usando onclick direto)
            this.aiToggle.onclick = async (e) => {
                const isAiActive = e.target.checked; // checked = IA Ativa
                try {
                    await this.db.collection('clients').doc(this.currentChatId).update({ aiPaused: !isAiActive });
                    UI.toast(`IA ${isAiActive ? 'Ativada' : 'Pausada'}`);
                } catch(err) {
                    console.error(err);
                    e.target.checked = !isAiActive; // Reverte visualmente
                }
            };
        }

        // Listener de Mensagens
        if(this.unsubChat) this.unsubChat(); // Limpa listener anterior
        
        this.unsubChat = this.db.collection('clients').doc(clientId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .onSnapshot(snap => {
                this.messagesContainer.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const div = document.createElement('div');
                    div.className = `flex ${m.fromMe ? 'justify-end' : 'justify-start'} mb-2`;
                    
                    let contentHtml = m.body || m.content || "";
                    // Se for imagem (hack visual simples)
                    if(contentHtml.includes('[FOTO')) {
                        contentHtml = `<span class="italic text-xs"><i class="fas fa-camera"></i> ${contentHtml}</span>`;
                    }

                    div.innerHTML = `
                        <div class="${m.fromMe ? 'bg-purple-100' : 'bg-white border'} px-4 py-2 rounded-lg max-w-xs text-sm shadow-sm">
                            ${contentHtml}
                        </div>`;
                    this.messagesContainer.appendChild(div);
                });
                // Auto-scroll para o fim
                setTimeout(() => { 
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; 
                }, 100);
            });
    }

    setupInputListeners() {
        // Envio de Texto
        this.sendBtn.onclick = async () => {
            const phone = this.clientNameEl.dataset.phone;
            const msg = this.input.value;
            if (phone && msg.trim()) {
                this.input.value = '';
                const res = await window.electronAPI.sendWhatsappMessage(phone, msg);
                if(!res.success) UI.alert('Erro', 'Falha ao enviar mensagem via WhatsApp.');
            }
        };

        // Envio com Enter
        this.input.onkeyup = (e) => {
            if(e.key === 'Enter') this.sendBtn.click();
        };

        // Galeria R√°pida
        if (this.galleryBtn) {
            console.log('[Chat] Vinculando bot√£o da galeria...');
            this.galleryBtn.onclick = () => {
                console.log('[Chat] Bot√£o galeria clicado');
                this.openQuickGallery();
            };
        } else {
            console.error('[Chat] Erro: Bot√£o btnQuickGallery n√£o encontrado no DOM');
        }
        // LISTENER DA VITRINE DO DIA
        const btnShowcase = $('btnDailyShowcase');
        if (btnShowcase) {
            btnShowcase.onclick = async () => {
                const phone = this.clientNameEl.dataset.phone;
                const name = this.clientNameEl.innerText;

                if (!phone) {
                    UI.alert('Erro', 'Selecione uma conversa primeiro.');
                    return;
                }

                if (await UI.confirm('Enviar Vitrine?', `Isso enviar√° fotos de TODOS os produtos com estoque para ${name}.`, 'Enviar Agora', 'purple')) {
                    
                    UI.toast('Enviando fotos... (Isso pode levar uns segundos)');
                    const cleanPhone = phone.includes('@') ? phone : `${phone}@c.us`;
                    
                    const res = await window.electronAPI.sendDailyShowcase(cleanPhone);
                    
                    if (res.success) {
                        UI.toast(`${res.count} fotos enviadas!`, 'success');
                    } else {
                        UI.alert('Aviso', res.message || res.error);
                    }
                }
            };
        }
}

async openQuickGallery() {
    const res = await window.electronAPI.getProducts(); 
    if(!res.success) return;
    
    // Filtro: Imagem existe e produto est√° ativo
    const productsWithImages = res.products.filter(p => p.imagePath && p.active !== false);
    
    if(productsWithImages.length === 0) {
        UI.toast('Nenhum produto com foto.', 'error');
        return;
    }
    
    // HTML EXATAMENTE COMO ERA NO ORIGINAL
    let galleryHtml = `<div class="grid grid-cols-3 gap-3 max-h-96 overflow-y-auto">`;
    productsWithImages.forEach(p => { 
        const safePath = p.imagePath.replace(/\\/g, '/'); 
        galleryHtml += `
            <div class="cursor-pointer group relative border rounded-lg overflow-hidden h-24 bg-gray-100 photo-item" 
                 data-path="${safePath}" data-name="${p.name}">
                <img src="file://${safePath}" class="w-full h-full object-cover group-hover:opacity-80 transition">
                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-[9px] p-1 truncate text-center">
                    ${p.name}
                </div>
            </div>`; 
    });
    galleryHtml += `</div>`;

    // Chamada do Modal igual √† antiga
    UI._createModal(`
        <h3 class="text-lg font-bold text-gray-800 mb-4">
            <i class="fas fa-images text-purple-500"></i> Galeria R√°pida
        </h3>
        ${galleryHtml}
        <p class="text-xs text-center text-gray-400 mt-4">Clique na foto para enviar.</p>
    `, (card, close) => {
        card.querySelectorAll('.photo-item').forEach(item => {
            item.onclick = async () => {
                const imgPath = item.dataset.path; 
                const caption = item.dataset.name; 
                // Buscamos o telefone direto do elemento da UI do chat atual
                const phone = this.clientNameEl.dataset.phone;

                if(phone) { 
                    UI.toast(`Enviando foto de ${caption}...`); 
                    close(); 
                    const sendRes = await window.electronAPI.sendProductImage({ 
                        chatId: phone.includes('@') ? phone : `${phone}@c.us`, 
                        imagePath: imgPath, 
                        caption: `Aqui est√° a foto do nosso ${caption}! üéÇ` 
                    }); 
                    if(sendRes.success) { 
                        UI.toast('Foto enviada!', 'success'); 
                    } else { 
                        UI.alert('Erro', sendRes.error); 
                    } 
                } else { 
                    UI.alert('Erro', 'Nenhum chat selecionado.'); 
                }
            };
        });
    });
}
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/ClientsModule.js
================================================================================
import { $, show, hide } from '../utils/DOM.js';
import { UI } from '../utils/UI.js';
import { ClientService } from '../services/ClientService.js';

export class ClientsModule {
    constructor() {
        this.service = new ClientService();
        this.unsub = null;

        // Elementos DOM
        this.listContainer = $('clientsList');
        this.addForm = $('addClientForm');
        this.noClientsMsg = $('noClientsMessage');
        
        // Modal Edi√ß√£o
        this.editModal = $('editClientModal');
        this.editForm = $('editClientForm');
        this.historyContainer = $('clientAppointmentsHistory');
        this.cancelEditBtn = $('cancelEditClientButton');

        this.handleListClick = this.handleListClick.bind(this);
        this.handleAddSubmit = this.handleAddSubmit.bind(this);
        this.handleEditSubmit = this.handleEditSubmit.bind(this);
    }

    init() {
        console.log('[Clients] Iniciando...');
        this.loadClients();
        if (this.addForm) this.addForm.addEventListener('submit', this.handleAddSubmit);
        if (this.editForm) this.editForm.addEventListener('submit', this.handleEditSubmit);
        if (this.listContainer) this.listContainer.addEventListener('click', this.handleListClick);
        if (this.cancelEditBtn) this.cancelEditBtn.onclick = () => hide(this.editModal);
    }

    destroy() {
        if (this.unsub) { this.unsub(); this.unsub = null; }
        if (this.addForm) this.addForm.removeEventListener('submit', this.handleAddSubmit);
        if (this.editForm) this.editForm.removeEventListener('submit', this.handleEditSubmit);
        if (this.listContainer) this.listContainer.removeEventListener('click', this.handleListClick);
    }

    // --- HELPER PARA FORMATAR ITENS (CORRE√á√ÉO DO [object Object]) ---
    _formatItems(items) {
        if (!items) return '-';
        
        // Se for string, retorna ela mesma
        if (typeof items === 'string') return items;

        // Se for Array de objetos (do Carrinho/PDV)
        if (Array.isArray(items)) {
            return items.map(i => {
                if (typeof i === 'object') {
                    const qtd = i.qty || i.quantity || i.q || 1;
                    const nome = i.name || i.item || i.n || 'Item';
                    return `${qtd}x ${nome}`;
                }
                return String(i);
            }).join(', '); // Separa por v√≠rgula para ficar compacto no hist√≥rico
        }

        return String(items);
    }

    loadClients() {
        this.unsub = this.service.listenToClients((clients) => {
            this.renderList(clients);
        });
    }

    renderList(clients) {
        this.listContainer.innerHTML = '';
        if (clients.length === 0) { show(this.noClientsMsg); return; }
        hide(this.noClientsMsg);

        clients.forEach(c => {
            const div = document.createElement('div');
            div.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center mb-2 animate-fade-in hover:border-purple-200 transition';
            
            const addressDisplay = c.address || c.lastAddress || 'Sem endere√ßo cadastrado';

            div.innerHTML = `
                <div>
                    <p class="font-bold text-gray-800 text-sm">${c.name}</p>
                    <p class="text-xs text-gray-500">${c.phone}</p>
                    <p class="text-[10px] text-gray-400 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${addressDisplay}</p>
                </div>
                <div class="space-x-1 flex items-center">
                    <button class="bg-purple-100 hover:bg-purple-200 text-purple-600 px-3 py-1 rounded text-xs transition btn-action font-bold" 
                            data-action="chat" data-id="${c.id}" data-name="${c.name}" data-phone="${c.phone}">
                        Chat
                    </button>
                    <button class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs transition btn-action" 
                            data-action="edit" data-id="${c.id}" 
                            data-name="${c.name}" data-phone="${c.phone}" 
                            data-cc="${c.countryCode || '55'}"
                            data-address="${c.address || c.lastAddress || ''}">
                        Editar
                    </button>
                    <button class="text-red-300 hover:text-red-500 px-2 transition btn-action" 
                            data-action="delete" data-id="${c.id}" title="Excluir Cliente">
                        <i class="fas fa-trash pointer-events-none"></i>
                    </button>
                </div>
            `;
            this.listContainer.appendChild(div);
        });
    }

    async handleListClick(e) {
        const btn = e.target.closest('.btn-action');
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;

        if (action === 'chat') {
            const chatNav = $('navConversas');
            if(chatNav) {
                chatNav.click();
                // Pequeno delay para garantir que a UI trocou
                setTimeout(() => {
                    // Tenta acessar o ChatModule via global window.app (definido no App.js)
                    if (window.app && window.app.modules.conversas) {
                        window.app.modules.conversas.openChat(id, btn.dataset.name, btn.dataset.phone);
                    }
                }, 100);
            }
        }
        
        if (action === 'delete') {
            if (await UI.confirm('Excluir Cliente', 'Isso n√£o apaga o hist√≥rico de pedidos, apenas o cadastro.', 'Excluir', 'red')) {
                await this.service.deleteClient(id);
                UI.toast('Cliente exclu√≠do.');
            }
        }

        if (action === 'edit') {
            this.openEditModal({
                id: id,
                name: btn.dataset.name,
                phone: btn.dataset.phone,
                countryCode: btn.dataset.cc,
                address: btn.dataset.address
            });
        }
    }

    async handleAddSubmit(e) {
        e.preventDefault();
        const name = $('clientNameInput').value.trim();
        const phone = $('clientPhoneInput').value.trim();
        const cc = $('addClientCountryCode').value;
        const address = $('clientAddressInput').value.trim();

        if (!name || !phone) {
            UI.alert('Aten√ß√£o', 'Preencha nome e telefone.');
            return;
        }

        try {
            const res = await this.service.createClient({ rawPhone: phone, name, countryCode: cc, address });
            if (res.success) {
                this.addForm.reset();
                UI.toast('Cliente salvo com sucesso!');
            } else {
                UI.alert('Erro', res.error || 'Falha ao criar cliente.');
            }
        } catch (err) {
            UI.alert('Erro', err.message);
        }
    }

    async openEditModal(clientData) {
        $('editClientId').value = clientData.id;
        $('editClientName').value = clientData.name;
        $('editClientPhone').value = clientData.phone;
        $('editClientCountryCode').value = clientData.countryCode;
        $('editClientAddress').value = clientData.address || '';

        this.historyContainer.innerHTML = '<p class="text-xs text-gray-400 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando hist√≥rico...</p>';
        show(this.editModal);

        try {
            const res = await this.service.getHistory(clientData.id);
            this.renderHistory(res.appointments);
        } catch (error) {
            this.historyContainer.innerHTML = '<p class="text-xs text-red-400 text-center">Erro ao carregar hist√≥rico.</p>';
        }
    }

    renderHistory(appointments) {
        this.historyContainer.innerHTML = '';
        if (!appointments || appointments.length === 0) {
            this.historyContainer.innerHTML = '<div class="text-center py-4 text-gray-400 text-xs">Nenhum pedido encontrado.</div>';
            return;
        }
        
        appointments.forEach(o => {
            // AQUI APLICAMOS A FORMATA√á√ÉO
            const itemsReadable = this._formatItems(o.service);

            const item = document.createElement('div');
            item.className = 'border-b border-gray-50 py-2 hover:bg-gray-50 px-2 rounded';
            item.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] font-bold text-gray-400">${o.date}</span>
                    <span class="text-[10px] font-bold text-purple-600">${o.status}</span>
                </div>
                <!-- Exibe os itens formatados -->
                <div class="text-xs text-gray-700 truncate" title="${itemsReadable}">${itemsReadable}</div>
                <div class="text-[10px] text-gray-400 text-right">${o.time}</div>
            `;
            this.historyContainer.appendChild(item);
        });
    }

    async handleEditSubmit(e) {
        e.preventDefault();
        const id = $('editClientId').value;
        const name = $('editClientName').value.trim();
        const phone = $('editClientPhone').value.trim();
        const countryCode = $('editClientCountryCode').value;
        const address = $('editClientAddress').value.trim();

        try {
            const res = await this.service.updateClient(id, { name, phone, countryCode, address });
            if (res.success) {
                UI.toast('Cliente atualizado!');
                hide(this.editModal);
            } else {
                UI.alert('Erro', res.error);
            }
        } catch (err) {
            UI.alert('Erro', err.message);
        }
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/ConnectionModule.js
================================================================================
import { $, show, hide } from '../utils/DOM.js';

export class ConnectionModule {
    constructor() {
        this.statusEl = $('whatsappStatusText');
        this.qrContainer = $('whatsappQrContainer');
        this.qrCanvas = $('whatsappQrCodeCanvas');
        this.logoutBtn = $('whatsappLogoutButton');
        this.reconnectBtn = $('whatsappReconnectButton');
        
        // QRious Instance
        this.qr = null; 
        if (typeof QRious !== 'undefined' && this.qrCanvas) {
            this.qr = new QRious({ element: this.qrCanvas, size: 200, value: '...' });
        }
        
        // Bindings para n√£o perder o 'this'
        this.handleQr = this.handleQr.bind(this);
        this.handleStatus = this.handleStatus.bind(this);
    }

    async init() {
        console.log('[Connection] Iniciando...');
        
        // Listeners do IPC
        window.electronAPI.onWhatsappQr(this.handleQr);
        window.electronAPI.onWhatsappStatus(this.handleStatus);

        // Listeners de Bot√µes
        if(this.reconnectBtn) this.reconnectBtn.onclick = () => window.electronAPI.whatsappInitialize();
        if(this.logoutBtn) this.logoutBtn.onclick = () => window.electronAPI.whatsappLogout();

        // Estado inicial
        const initialStatus = await window.electronAPI.getWhatsappStatus();
        const initialQr = await window.electronAPI.getWhatsappQr();
        
        this.handleStatus(initialStatus);
        if(initialQr) this.handleQr(initialQr);
    }

    destroy() {
        // Remove listeners para evitar memory leak ao trocar de aba
        // Nota: O Electron `ipcRenderer.on` acumula listeners se n√£o removermos.
        // Como o `contextBridge` n√£o exp√µe `removeListener` facilmente no seu preload atual,
        // garantimos que o callback verifique se o m√≥dulo ainda est√° ativo ou aceitamos o overhead leve.
        // O ideal seria adicionar `removeListener` no preload.js, mas vamos seguir sem alterar o preload agora.
        console.log('[Connection] Parando...');
    }

    handleQr(qrData) {
        if (this.qr && this.qrContainer && qrData) {
            show(this.qrContainer);
            this.qr.value = qrData;
        }
    }

    handleStatus(status) {
        if (!this.statusEl) return;
        
        let txt = status;
        let clr = 'text-gray-500';
        
        hide(this.logoutBtn);
        hide(this.reconnectBtn);
        hide(this.qrContainer);

        if (status === 'conectado') {
            txt = 'Conectado';
            clr = 'text-green-600';
            show(this.logoutBtn);
        } else if (status === 'aguardando_scan') {
            txt = 'Leia o QR Code';
            clr = 'text-yellow-600';
            show(this.qrContainer);
            show(this.logoutBtn); // Permite cancelar
        } else if (status === 'desconectado') {
            txt = 'Desconectado';
            clr = 'text-red-600';
            show(this.reconnectBtn);
        }

        this.statusEl.textContent = txt;
        this.statusEl.className = `font-bold ${clr}`;
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/DashboardModule.js
================================================================================
import { $, hide, show } from '../utils/DOM.js';
import { FirebaseService } from '../services/FirebaseService.js';
// Certifique-se de que luxon est√° dispon√≠vel globalmente ou importe-o
const DateTime = luxon.DateTime;

export class DashboardModule {
    constructor() {
        this.db = FirebaseService.getInstance().db;
        this.chartInstance = null;
    }

    async init() {
        console.log('[Dashboard] Iniciando com Raio-X do Dia...');
        
        // Exibe a data de hoje no t√≠tulo
        if($('dashTodayDate')) $('dashTodayDate').innerText = DateTime.now().toFormat('dd/MM/yyyy');

        this.loadTodayMetrics();     // NOVA FUN√á√ÉO
        this.loadTodaySchedule();    // NOVA FUN√á√ÉO
        this.loadSalesChart();       // Mantida (Gr√°fico 7 dias)
        
        // Listener simples para atualizar status do bot (opcional manter)
        this.updateBotStatus();
    }

    destroy() {
        if (this.chartInstance) {
            this.chartInstance.destroy();
            this.chartInstance = null;
        }
    }

    // --- NOVA: Carrega m√©tricas APENAS DE HOJE ---
    async loadTodayMetrics() {
        try {
            const todayStart = DateTime.now().startOf('day').toJSDate();
            const todayEnd = DateTime.now().endOf('day').toJSDate();

            // 1. Busca pedidos criados HOJE (exclui cancelados se tiver status 'Cancelado')
            const snapshot = await this.db.collection('orders')
                .where('createdAt', '>=', todayStart)
                .where('createdAt', '<=', todayEnd)
                .get();

            let revenue = 0;
            let count = 0;
            let pending = 0;

            snapshot.forEach(doc => {
                const data = doc.data();
                
                // Ignora cancelados
                if (data.status === 'Cancelado') return;
                
                // Soma Pendentes para o card amarelo
                if (data.status === 'Pendente') pending++;

                // Soma receita
                revenue += parseFloat(data.total || 0);
                count++;
            });

            const avgTicket = count > 0 ? revenue / count : 0;

            // Atualiza UI
            if($('dashTodayRevenue')) $('dashTodayRevenue').innerText = `R$ ${revenue.toFixed(2)}`;
            if($('dashTodayCount')) $('dashTodayCount').innerText = count;
            if($('dashTodayTicket')) $('dashTodayTicket').innerText = `R$ ${avgTicket.toFixed(2)}`;
            
            // Atualiza Pendentes (Sobrep√µe a l√≥gica antiga para ser mais preciso com o snapshot atual)
            if($('dashOpenOrders')) $('dashOpenOrders').innerText = pending;

        } catch (e) {
            console.error('[Dashboard] Erro m√©tricas hoje:', e);
        }
    }

    // --- NOVA: Carrega Encomendas/Festas Agendadas para HOJE ---
    async loadTodaySchedule() {
        const container = $('dashTodaySchedule');
        if(!container) return;

        try {
            // Data formato string YYYY-MM-DD igual salvo no CalendarModule
            const todayStr = DateTime.now().toFormat('yyyy-MM-dd');

            const snapshot = await this.db.collection('orders')
                .where('status', '==', 'Agendado')
                .where('dueDate', '==', todayStr)
                .get();

            container.innerHTML = '';

            if (snapshot.empty) {
                container.innerHTML = '<div class="text-center py-6 text-gray-400 text-xs"><i class="fas fa-mug-hot text-2xl mb-2 opacity-30"></i><br>Nada agendado para hoje.</div>';
                return;
            }

            snapshot.forEach(doc => {
                const d = doc.data();
                const div = document.createElement('div');
                // Estilo condicional se for empr√©stimo
                const isLoan = !!d.loanedItems;
                const borderClass = isLoan ? 'border-l-4 border-orange-400' : 'border-l-4 border-purple-400';
                
                div.className = `bg-gray-50 p-3 rounded-lg border border-gray-100 ${borderClass} text-xs shadow-sm`;
                div.innerHTML = `
                    <div class="flex justify-between font-bold text-gray-700 mb-1">
                        <span>${d.clientName}</span>
                        <span>R$ ${parseFloat(d.total).toFixed(2)}</span>
                    </div>
                    <div class="text-gray-500 mb-1 truncate">${d.items}</div>
                    ${isLoan ? `<div class="text-[10px] text-orange-600 font-bold bg-orange-100 px-1 rounded inline-block"><i class="fas fa-box"></i> Empr√©stimo</div>` : ''}
                    <div class="mt-1 text-gray-400 text-[10px]"><i class="fas fa-map-marker-alt"></i> ${d.address || 'Retirada'}</div>
                `;
                container.appendChild(div);
            });

        } catch (e) {
            console.error('[Dashboard] Erro agenda hoje:', e);
        }
    }

    async updateBotStatus() {
        // ... (Mantenha o c√≥digo original do updateBotStatus aqui)
        try {
            const status = await window.electronAPI.getWhatsappStatus();
            // Se voc√™ quiser mostrar isso no header ou outro lugar
            console.log('Bot Status:', status); 
        } catch (e) {}
    }

    async loadSalesChart() {
        // ... (Mantenha o c√≥digo original do loadSalesChart aqui, ele j√° funciona bem para os 7 dias)
        // Apenas garanta que o ID do canvas seja 'salesChart' como no HTML acima
        const ctx = $('salesChart');
        if (!ctx || typeof Chart === 'undefined') return;
        
        // ... (Resto do c√≥digo do gr√°fico original) ...
        // Certifique-se de copiar a l√≥gica do seu arquivo original para c√°
        if (this.chartInstance) this.chartInstance.destroy();
        
        try {
            const snapshot = await this.db.collection('orders')
                .orderBy('createdAt', 'desc')
                .limit(50)
                .get();
                
             // ... (L√≥gica de processamento de dados do gr√°fico original) ...
             // Para brevidade, use a l√≥gica que voc√™ j√° tem no arquivo original aqui.
             const { DateTime } = luxon;
             const salesData = {};
             const today = DateTime.now();
             for (let i = 6; i >= 0; i--) {
                const d = today.minus({ days: i }).toFormat('dd/MM');
                salesData[d] = 0;
             }
             
             snapshot.forEach(doc => {
                const data = doc.data();
                if (data.createdAt && (data.total > 0)) {
                    const dateObj = DateTime.fromJSDate(data.createdAt.toDate());
                    if (dateObj > today.minus({ days: 7 })) {
                        const key = dateObj.toFormat('dd/MM');
                        if (salesData[key] !== undefined) salesData[key] += parseFloat(data.total);
                    }
                }
             });

             this.chartInstance = new Chart(ctx, {
                type: 'bar', // ou 'line' se preferir
                data: {
                    labels: Object.keys(salesData),
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: Object.values(salesData),
                        backgroundColor: '#a78bfa',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
             });

        } catch (error) { console.error(error); }
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/KanbanModule.js
================================================================================
import { $, show, hide } from '../utils/DOM.js';
import { UI } from '../utils/UI.js';
import { OrderService } from '../services/OrderService.js';

export class KanbanModule {
    constructor() {
        this.service = new OrderService();
        this.unsub = null;

        // Seletores do Board (Colunas e Contadores)
        this.cols = {
            'Pendente': $('col-pending'),
            'Preparo': $('col-prep'),
            'Pronto/Envio': $('col-sent'),
            'Conclu√≠do': $('col-done')
        };
        this.counts = {
            'Pendente': $('count-pending'),
            'Preparo': $('count-prep'),
            'Pronto/Envio': $('count-sent'),
            'Conclu√≠do': $('count-done')
        };
    }

    init() {
        console.log('[Kanban] Iniciando Gest√£o de Fluxo...');
        
        // 1. Carrega o Quadro
        this.loadOrders();

        // 2. Listener do Modal de Edi√ß√£o (que est√° no index.html global)
        if($('editOrderForm')) $('editOrderForm').onsubmit = (e) => this.handleEditSubmit(e);
    }

    destroy() {
        if (this.unsub) this.unsub();
        console.log('[Kanban] Finalizado.');
    }

    // --- FORMATA√á√ÉO VISUAL ---
    _formatItems(items, separator = '<br>') {
        if (!items) return '-';
        if (typeof items === 'string') return separator === '<br>' ? items.replace(/\n/g, '<br>') : items;
        if (Array.isArray(items)) {
            return items.map(i => {
                if (typeof i === 'object') {
                    const qtd = i.qty || i.quantity || i.q || 1;
                    const nome = i.name || i.item || i.n || 'Item sem nome';
                    const obs = i.obs ? ` (${i.obs})` : '';
                    return `${qtd}x ${nome}${obs}`;
                }
                return String(i);
            }).join(separator);
        }
        return String(items);
    }

    // --- A√á√ïES DO MODAL DE EDI√á√ÉO ---
    async handleEditSubmit(e) {
        e.preventDefault();
        const id = $('editOrderId').value;
        const data = { 
            items: $('editOrderItems').value, 
            total: parseFloat($('editOrderTotal').value) || 0, 
            paymentMethod: $('editOrderPayment').value, 
            deliveryMethod: $('editOrderDelivery').value, 
            address: $('editOrderAddress').value,
            dueDate: $('editOrderDate').value 
        };

        try {
            const res = await this.service.updateOrder(id, data);
            if(res.success) {
                UI.toast('Pedido atualizado!');
                hide($('editOrderModal'));
            }
        } catch(err) {
            UI.alert('Erro', err.message);
        }
    }

    // --- L√ìGICA DO QUADRO KANBAN ---

    loadOrders() {
        this.unsub = this.service.listenToPendingOrders((orders) => {
            this.renderBoard(orders);
        });
    }

    renderBoard(orders) {
        // Limpa colunas
        Object.values(this.cols).forEach(col => col.innerHTML = '');
        
        // Zera contadores
        const countsCalc = { 'Pendente': 0, 'Preparo': 0, 'Pronto/Envio': 0, 'Conclu√≠do': 0 };

        orders.forEach(order => {
            if(order.status === 'Agendado') return; // Ignora agendamentos futuros
            
            let status = order.status;
            // Normaliza√ß√£o de status antigos ou varia√ß√µes
            if (status === 'Entregue' || status === 'Finalizado') status = 'Conclu√≠do';
            if (!this.cols[status]) status = 'Pendente';

            countsCalc[status]++;
            
            const card = this.createCard(order, status);
            this.cols[status].appendChild(card);
        });

        // Atualiza badges de contagem
        Object.keys(countsCalc).forEach(key => {
            if (this.counts[key]) this.counts[key].innerText = countsCalc[key];
        });
    }

    createCard(data, currentStatus) {
        const div = document.createElement('div');
        div.className = 'kanban-card group bg-white p-3 rounded-xl shadow-sm border border-gray-100 mb-3';
        
        const { DateTime } = luxon;
        const timeStr = data.createdAt ? DateTime.fromJSDate(data.createdAt.toDate()).toFormat('HH:mm') : '--:--';
        const itemsFormatted = this._formatItems(data.items, '<br>');

        // Destaque para o Pagamento no Card
        const payMethod = data.paymentMethod || '?';
        let payColor = 'text-gray-500';
        if(payMethod === 'Pix') payColor = 'text-green-600 font-bold';
        if(payMethod === 'Cart√£o') payColor = 'text-blue-600 font-bold';

        div.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <span class="font-bold text-gray-700 text-sm truncate w-24">${data.clientName}</span>
                <span class="text-[10px] text-gray-400 font-mono">${timeStr}</span>
            </div>
            <div class="text-xs text-gray-600 mb-2 leading-tight max-h-24 overflow-y-auto custom-scrollbar">${itemsFormatted}</div>
            
            <div class="flex justify-between items-center border-t border-gray-50 pt-2 mt-1">
                <span class="font-bold text-gray-800 text-xs">R$ ${parseFloat(data.total).toFixed(2)}</span>
                <div class="text-xs ${payColor}">${payMethod}</div>
            </div>
            ${data.notes ? `<div class="text-[10px] text-red-400 mt-1 italic truncate"><i class="fas fa-sticky-note mr-1"></i>${data.notes}</div>` : ''}
            
            <div class="flex justify-between mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                 <div class="flex gap-1">
                    <button class="text-gray-400 hover:text-red-500 p-1 btn-delete" title="Excluir"><i class="fas fa-trash text-xs"></i></button>
                    <button class="text-gray-400 hover:text-gray-600 p-1 btn-print" title="Imprimir"><i class="fas fa-print text-xs"></i></button>
                    <button class="text-gray-400 hover:text-blue-500 p-1 btn-edit" title="Editar Pedido"><i class="fas fa-pen-to-square text-xs"></i></button>
                 </div>
                 <div class="flex gap-1">${this.getKanbanButtons(currentStatus)}</div>
            </div>`;

        // Listeners dos Bot√µes do Card
        div.querySelector('.btn-edit').onclick = () => this.openEditOrderModal(data);
        
        div.querySelector('.btn-print').onclick = async () => {
            if(await UI.confirm('Imprimir', 'Deseja imprimir o cupom?', 'Imprimir', 'blue')) { 
                await this.service.printOrder(data); 
            }
        };
        
        div.querySelector('.btn-delete').onclick = async () => {
            if(await UI.confirm('Excluir', 'Tem certeza?', 'Sim, Excluir', 'red')) { 
                await this.service.deleteOrder(data.id); 
            }
        };
        
        const btnNext = div.querySelector('.btn-next');
        if(btnNext) btnNext.onclick = () => this.advanceStatus(data.id, currentStatus, data);

        return div;
    }

    openEditOrderModal(order) {
        // Preenche Modal
        $('editOrderId').value = order.id;
        $('editOrderItems').value = this._formatItems(order.items, '\n');
        $('editOrderTotal').value = parseFloat(order.total).toFixed(2);
        
        // Pagamento
        const currentPay = order.paymentMethod;
        const validOptions = ['Pix', 'Dinheiro', 'Cart√£o'];
        if(validOptions.includes(currentPay)) {
            $('editOrderPayment').value = currentPay;
        } else {
            $('editOrderPayment').selectedIndex = -1; // For√ßa escolha se estiver inv√°lido
        }

        $('editOrderDelivery').value = order.deliveryMethod;
        $('editOrderAddress').value = order.address || '';
        
        const dateInput = $('editOrderDate');
        if (order.dueDate) {
            dateInput.value = order.dueDate;
        } else if (order.createdAt) {
            const dt = luxon.DateTime.fromJSDate(order.createdAt.toDate ? order.createdAt.toDate() : new Date(order.createdAt));
            dateInput.value = dt.toFormat('yyyy-MM-dd');
        }

        const badge = $('modalStatusBadge');
        if(badge) {
            badge.innerText = order.status;
            badge.className = 'text-[10px] px-2 py-1 rounded bg-gray-100 text-gray-500 font-bold uppercase border border-gray-200';
        }

        // Bot√µes do Rodap√© do Modal
        const btnDel = $('btnModalDelete');
        // Clonamos o n√≥ para remover listeners antigos e evitar duplica√ß√£o de execu√ß√£o
        const newBtnDel = btnDel.cloneNode(true);
        btnDel.parentNode.replaceChild(newBtnDel, btnDel);
        
        newBtnDel.onclick = async () => {
            if (await UI.confirm('Excluir Pedido', 'Tem certeza?', 'Excluir', 'red')) {
                await this.service.deleteOrder(order.id);
                hide($('editOrderModal'));
            }
        };

        const btnPrint = $('btnModalPrint');
        const newBtnPrint = btnPrint.cloneNode(true);
        btnPrint.parentNode.replaceChild(newBtnPrint, btnPrint);

        newBtnPrint.onclick = async () => { await this.service.printOrder(order); };

        // Bot√£o Fechar/Cancelar
        $('cancelEditOrderButton').onclick = () => hide($('editOrderModal'));
        
        show($('editOrderModal'));
    }

    getKanbanButtons(status) {
        if(status === 'Pendente') return `<button class="text-green-500 hover:bg-green-50 rounded p-1 btn-next"><i class="fas fa-arrow-right"></i></button>`;
        if(status === 'Preparo') return `<button class="text-blue-500 hover:bg-blue-50 rounded p-1 btn-next"><i class="fas fa-arrow-right"></i></button>`;
        if(status === 'Pronto/Envio') return `<button class="text-gray-500 hover:bg-gray-50 rounded p-1 btn-next"><i class="fas fa-check"></i></button>`;
        return '';
    }

    async advanceStatus(orderId, currentStatus, orderData) {
        let nextStatus = '';
        if(currentStatus === 'Pendente') nextStatus = 'Preparo';
        else if(currentStatus === 'Preparo') nextStatus = 'Pronto/Envio';
        else if(currentStatus === 'Pronto/Envio') nextStatus = 'Conclu√≠do';
        if(!nextStatus) return;

        const notify = await UI.decision(`Mover para "${nextStatus}"?`, `Deseja avisar o cliente no WhatsApp?`, "Sim", "N√£o");
        if (notify === null) return;
        await this.service.updateStatus(orderId, nextStatus, notify, orderData);
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/PosModule.js
================================================================================
import { $, $$, show, hide } from '../utils/DOM.js';
import { UI } from '../utils/UI.js';
import { ProductService } from '../services/ProductService.js';
import { ClientService } from '../services/ClientService.js';
import { FirebaseService } from '../services/FirebaseService.js';

export class PosModule {
    constructor() {
        this.productService = new ProductService();
        this.clientService = new ClientService();
        this.db = FirebaseService.getInstance().db;
        
        this.products = [];
        this.cart = [];
        this.paymentMethod = 'Pix';

        // Elementos
        this.grid = $('posProductGrid');
        this.searchInput = $('posSearchInput');
        this.cartList = $('posCartList');
        this.clientSelect = $('posClientSelect');
        this.totalEl = $('posTotal');
        this.subtotalEl = $('posSubtotal');
        this.btnFinalize = $('btnPosFinalize');
        this.btnCloseRegister = $('btnCloseRegister');
    }

    async init() {
        console.log('[POS] Inicializando Frente de Caixa...');
        this.cart = [];
        this.renderCart();
        
        await this.loadProducts();
        await this.loadClients();
        this.setupEvents();
    }

    destroy() {
        document.onkeydown = null;
    }

    async loadProducts() {
        const res = await this.productService.getActiveProducts();
        if (res.success) {
            this.products = res.products.filter(p => p.active !== false);
            this.renderProducts(this.products);
        }
    }

    async loadClients() {
        this.clientService.listenToClients((clients) => {
            this.clientSelect.innerHTML = '<option value="">Consumidor Final</option>';
            clients.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                this.clientSelect.appendChild(opt);
            });
        });
    }

    setupEvents() {
        this.searchInput.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = this.products.filter(p => p.name.toLowerCase().includes(term));
            this.renderProducts(filtered);
        };

        $$('.pos-pay-btn').forEach(btn => {
            btn.onclick = () => {
                $$('.pos-pay-btn').forEach(b => b.classList.remove('bg-purple-600', 'border-purple-500'));
                btn.classList.add('bg-purple-600', 'border-purple-500');
                this.paymentMethod = btn.dataset.method;
            };
        });

        $('btnPosClear').onclick = () => {
            this.cart = [];
            this.renderCart();
        };

        this.btnFinalize.onclick = () => this.handleCheckout();

        if (this.btnCloseRegister) {
            this.btnCloseRegister.onclick = () => this.handleCloseRegister();
        }

        document.onkeydown = (e) => {
            if (e.key === 'F10') {
                e.preventDefault();
                this.btnFinalize.click();
            }
        };
    }

    // --- NOVA L√ìGICA: PR√â-VISUALIZA√á√ÉO NA TELA ---
    async handleCloseRegister() {
        UI.toast('Calculando fechamento...');

        try {
            const { DateTime } = luxon;
            const now = DateTime.now();
            const startOfDay = now.startOf('day').toJSDate();
            const endOfDay = now.endOf('day').toJSDate();

            // Busca pedidos v√°lidos do dia
            const snapshot = await this.db.collection('orders')
                .where('createdAt', '>=', startOfDay)
                .where('createdAt', '<=', endOfDay)
                .get();

            const summary = {
                date: now.toFormat('dd/MM/yyyy HH:mm'),
                total: 0,
                count: 0,
                methods: { 'Pix': 0, 'Dinheiro': 0, 'Cart√£o': 0, 'Outros': 0 }
            };

            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.status === 'Cancelado') return; // Ignora cancelados

                const val = parseFloat(data.total || 0);
                summary.total += val;
                summary.count++;

                let method = data.paymentMethod || 'Outros';
                // Normaliza (ex: pix -> Pix)
                method = method.charAt(0).toUpperCase() + method.slice(1).toLowerCase();
                
                if (summary.methods[method] !== undefined) {
                    summary.methods[method] += val;
                } else {
                    summary.methods['Outros'] += val;
                }
            });

            // GERA HTML DO CUPOM PARA VISUALIZA√á√ÉO
            const cupomHtml = `
                <div class="bg-yellow-50 border border-yellow-200 p-4 font-mono text-sm text-gray-800 shadow-inner rounded mb-4">
                    <div class="text-center border-b border-dashed border-gray-400 pb-2 mb-2">
                        <h3 class="font-bold text-lg">FECHAMENTO DE CAIXA</h3>
                        <p class="text-xs">${summary.date}</p>
                    </div>
                    
                    <div class="flex justify-between mb-1"><span>Qtd Pedidos:</span> <span>${summary.count}</span></div>
                    <div class="border-b border-dashed border-gray-300 my-2"></div>

                    <div class="flex justify-between"><span>Pix:</span> <span>R$ ${summary.methods.Pix.toFixed(2)}</span></div>
                    <div class="flex justify-between"><span>Dinheiro:</span> <span>R$ ${summary.methods.Dinheiro.toFixed(2)}</span></div>
                    <div class="flex justify-between"><span>Cart√£o:</span> <span>R$ ${summary.methods.Cart√£o.toFixed(2)}</span></div>
                    ${summary.methods.Outros > 0 ? `<div class="flex justify-between text-gray-500"><span>Outros:</span> <span>R$ ${summary.methods.Outros.toFixed(2)}</span></div>` : ''}

                    <div class="border-t border-dashed border-gray-800 mt-3 pt-2">
                        <div class="flex justify-between font-bold text-lg">
                            <span>TOTAL:</span>
                            <span>R$ ${summary.total.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-500 mb-4">Confira os valores antes de imprimir.</p>
            `;

            // ABRE MODAL DE DECIS√ÉO
            UI._createModal(`
                <h3 class="text-lg font-bold text-gray-800 mb-2">Confer√™ncia de Caixa</h3>
                ${cupomHtml}
                <div class="flex flex-col gap-2">
                    <button id="btnPrintConfirm" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow-lg flex justify-center items-center gap-2">
                        <i class="fas fa-print"></i> CONFIRMAR E IMPRIMIR
                    </button>
                    <button id="btnCancelClose" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 rounded-lg hover:bg-gray-50">
                        Apenas Fechar (N√£o Imprimir)
                    </button>
                </div>
            `, async (card, close) => {
                
                // Bot√£o IMPRIMIR
                card.querySelector('#btnPrintConfirm').onclick = async () => {
                    close();
                    UI.toast('Enviando para impressora...');
                    const res = await window.electronAPI.printCloseRegister(summary);
                    if (!res.success) {
                        UI.alert('Erro Impress√£o', res.error || 'Verifique se a impressora est√° ligada e selecionada nas Configura√ß√µes.');
                    } else {
                        UI.toast('Relat√≥rio impresso com sucesso!', 'success');
                    }
                };

                // Bot√£o FECHAR
                card.querySelector('#btnCancelClose').onclick = () => close();
            });

        } catch (e) {
            console.error(e);
            UI.alert('Erro', 'Falha ao processar fechamento: ' + e.message);
        }
    }

    renderProducts(list) {
        this.grid.innerHTML = '';
        list.forEach(p => {
            const hasStock = p.quantity > 0;
            const card = document.createElement('div');
            card.className = `bg-white border border-gray-100 rounded-xl p-3 shadow-sm hover:shadow-md transition cursor-pointer flex flex-col gap-2 relative ${!hasStock ? 'opacity-60 grayscale' : ''}`;
            
            card.innerHTML = `
                <div class="h-24 w-full bg-gray-50 rounded-lg overflow-hidden relative">
                    ${p.imagePath ? `<img src="file://${p.imagePath.replace(/\\/g, '/')}" class="w-full h-full object-cover">` : `<i class="fas fa-image text-gray-200 text-3xl flex items-center justify-center h-full"></i>`}
                    ${!hasStock ? `<div class="absolute inset-0 bg-black/50 flex items-center justify-center"><span class="text-white text-[10px] font-bold uppercase">Esgotado</span></div>` : ''}
                </div>
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-gray-700 truncate">${p.name}</span>
                    <span class="text-sm font-black text-purple-600">R$ ${parseFloat(p.price).toFixed(2)}</span>
                    <span class="text-[9px] text-gray-400">Estoque: ${p.quantity}</span>
                </div>
            `;

            if(hasStock) {
                card.onclick = () => this.addToCart(p);
            }
            this.grid.appendChild(card);
        });
    }

    addToCart(product) {
        const existing = this.cart.find(item => item.id === product.id);
        if (existing) {
            if (existing.quantity < product.quantity) {
                existing.quantity++;
            } else {
                UI.toast('Limite de estoque atingido', 'error');
            }
        } else {
            this.cart.push({ ...product, quantity: 1 });
        }
        this.renderCart();
    }

    renderCart() {
        this.cartList.innerHTML = '';
        if (this.cart.length === 0) {
            show($('posEmptyCart'));
            this.totalEl.innerText = 'R$ 0,00';
            this.subtotalEl.innerText = 'R$ 0,00';
            return;
        }
        hide($('posEmptyCart'));

        let total = 0;
        this.cart.forEach((item, index) => {
            const sub = item.price * item.quantity;
            total += sub;

            const div = document.createElement('div');
            div.className = 'bg-slate-800 rounded-lg p-3 flex justify-between items-center animate-fade-in';
            div.innerHTML = `
                <div class="flex flex-col">
                    <span class="text-xs font-bold">${item.name}</span>
                    <div class="flex items-center gap-2 mt-1">
                        <button class="w-5 h-5 bg-slate-700 rounded text-xs hover:bg-slate-600" onclick="event.stopPropagation(); window.app.modules.pos.updateQty(${index}, -1)">-</button>
                        <span class="text-xs font-mono w-4 text-center">${item.quantity}</span>
                        <button class="w-5 h-5 bg-slate-700 rounded text-xs hover:bg-slate-600" onclick="event.stopPropagation(); window.app.modules.pos.updateQty(${index}, 1)">+</button>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-xs font-bold text-purple-400">R$ ${sub.toFixed(2)}</span>
                    <button class="text-red-400 text-[10px] mt-1 hover:underline" onclick="window.app.modules.pos.removeFromCart(${index})">Remover</button>
                </div>
            `;
            this.cartList.appendChild(div);
        });

        this.totalEl.innerText = `R$ ${total.toFixed(2)}`;
        this.subtotalEl.innerText = `R$ ${total.toFixed(2)}`;
        
        this.cartList.scrollTop = this.cartList.scrollHeight;
    }

    updateQty(index, delta) {
        const item = this.cart[index];
        const product = this.products.find(p => p.id === item.id);
        
        if (delta > 0 && item.quantity >= product.quantity) {
            UI.toast('Estoque insuficiente', 'error');
            return;
        }

        item.quantity += delta;
        if (item.quantity <= 0) {
            this.cart.splice(index, 1);
        }
        this.renderCart();
    }

    removeFromCart(index) {
        this.cart.splice(index, 1);
        this.renderCart();
    }

    async handleCheckout() {
        if (this.cart.length === 0) return;

        const totalValue = parseFloat(this.totalEl.innerText.replace('R$ ', ''));
        const clientName = this.clientSelect.options[this.clientSelect.selectedIndex].text;
        const clientId = this.clientSelect.value || "CONSUMIDOR_FINAL";

        const orderData = {
            clientId,
            clientName: clientId === "CONSUMIDOR_FINAL" ? "Consumidor Final" : clientName,
            items: this.cart.map(i => `${i.quantity}x ${i.name}`).join(', '),
            total: totalValue,
            paymentMethod: this.paymentMethod,
            deliveryMethod: 'Balc√£o',
            status: 'Conclu√≠do',
            notes: 'Venda R√°pida POS',
            cart: this.cart.map(i => ({ id: i.id, qty: i.quantity })) 
        };

        this.btnFinalize.disabled = true;
        this.btnFinalize.innerText = "PROCESSANDO...";

        try {
            const res = await window.electronAPI.createManualOrder(orderData);
            if (res.success) {
                UI.toast('Venda finalizada com sucesso!', 'success');
                
                const print = await UI.confirm('Sucesso!', 'Deseja imprimir o cupom?', 'Imprimir', 'blue');
                if (print) {
                    await window.electronAPI.printOrder({ ...orderData, id: res.orderId });
                }

                this.cart = [];
                this.renderCart();
                await this.loadProducts(); 
            } else {
                UI.alert('Erro na Venda', res.error);
            }
        } catch (err) {
            UI.alert('Erro', err.message);
        } finally {
            this.btnFinalize.disabled = false;
            this.btnFinalize.innerText = "FINALIZAR VENDA (F10)";
        }
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/ReportsModule.js
================================================================================
import { $, $$, hide, show } from '../utils/DOM.js';
import { FirebaseService } from '../services/FirebaseService.js';
import { UI } from '../utils/UI.js';

export class ReportsModule {
    constructor() {
        this.db = FirebaseService.getInstance().db;
        this.charts = {}; // Armazena inst√¢ncias para destrui√ß√£o/re-render
        this.period = 30; // Default 30 dias
    }

    async init() {
        console.log('[Reports] Gerando Intelig√™ncia de Neg√≥cio...');
        this.setupListeners();
        await this.renderAll();
    }

    destroy() {
        Object.values(this.charts).forEach(chart => chart.destroy());
        this.charts = {};
    }

    setupListeners() {
        $$('.report-period-btn').forEach(btn => {
            btn.onclick = async () => {
                $$('.report-period-btn').forEach(b => b.classList.remove('bg-purple-600', 'text-white'));
                btn.classList.add('bg-purple-600', 'text-white');
                this.period = parseInt(btn.dataset.days);
                await this.renderAll();
            };
        });
        const btnPrint = $('btnIdPrintReport');
        if(btnPrint) btnPrint.onclick = () => this.printReport();
    }

    async renderAll() {
        UI.toast('Atualizando relat√≥rios...');
        const data = await this.fetchData();
        
        this.renderMetrics(data);
        this.renderSalesChart(data);
        this.renderPaymentsChart(data);
        this.renderTopProducts(data);
        this.renderTopClients(data);
    }

    async fetchData() {
        const { DateTime } = luxon;
        const startDate = DateTime.now().minus({ days: this.period }).startOf('day');

        // 1. Busca todos os produtos para ter um "Dicion√°rio de Nomes" (mapeia ID -> Nome)
        const productsSnap = await this.db.collection('products').get();
        const productLookup = {};
        productsSnap.forEach(doc => {
            productLookup[doc.id] = doc.data().name;
        });

        // 2. Busca pedidos (Status != Cancelado seria ideal, mas pegamos todos que tem total > 0)
        const snap = await this.db.collection('orders')
            .where('createdAt', '>=', startDate.toJSDate())
            .get();

        const orders = [];
        snap.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));

        const stats = {
            totalRevenue: 0,
            orderCount: orders.length,
            payments: {},
            products: {}, 
            dailySales: {},
            clients: {},
            avgTicket: 0
        };

        orders.forEach(o => {
            // Pula pedidos cancelados se houver status expl√≠cito, ou considera todos
            // Aqui assumimos que se tem total, conta.
            
            const val = parseFloat(o.total || 0);
            stats.totalRevenue += val;

            // --- 1. Pagamentos ---
            // Normaliza nomes (ex: pix -> Pix)
            let method = o.paymentMethod || 'Outros';
            method = method.charAt(0).toUpperCase() + method.slice(1).toLowerCase();
            if(method === 'A combinar') method = 'Outros'; 
            stats.payments[method] = (stats.payments[method] || 0) + val;

            // --- 2. Vendas Di√°rias ---
            if (o.createdAt) {
                const day = DateTime.fromJSDate(o.createdAt.toDate()).toFormat('dd/MM');
                stats.dailySales[day] = (stats.dailySales[day] || 0) + val;
            }

            // --- 3. Ranking Clientes ---
            const cName = o.clientName || 'An√¥nimo';
            if (!stats.clients[cName]) stats.clients[cName] = { total: 0, count: 0 };
            stats.clients[cName].total += val;
            stats.clients[cName].count += 1;

            // --- 4. PRODUTOS POPULARES (CORRE√á√ÉO DE PARSE) ---
            
            // CASO A: Carrinho Estruturado (Vindo do PDV ou IA Nova)
            if (o.cart && Array.isArray(o.cart) && o.cart.length > 0) {
                o.cart.forEach(item => {
                    // Tenta pegar o nome salvo, ou busca no lookup, ou usa o ID
                    const pName = item.name || productLookup[item.id] || item.id || 'Item Desconhecido';
                    const qty = parseInt(item.qty || item.quantity || 0);
                    if(qty > 0) {
                        stats.products[pName] = (stats.products[pName] || 0) + qty;
                    }
                });
            } 
            // CASO B: Texto Simples (Vindo da IA antiga, Manual ou Edi√ß√£o)
            else if (typeof o.items === 'string') {
                // Quebra por quebra de linha ou v√≠rgula
                const lines = o.items.split(/[\n,]/);
                
                lines.forEach(line => {
                    let cleanLine = line.trim();
                    if(!cleanLine) return;

                    // Regex inteligente para capturar quantidade: "2x Picol√©" ou "2 Picol√©" ou "Picol√©"
                    // Grupo 1: Quantidade (Opcional)
                    // Grupo 2: Nome
                    const match = cleanLine.match(/^(\d+)\s*[xX]?\s*(.+)$/);
                    
                    let qty = 1;
                    let name = cleanLine;

                    if (match) {
                        qty = parseInt(match[1]);
                        name = match[2].trim();
                    } else {
                        // Se n√£o tem n√∫mero, assume 1, mas tenta limpar caracteres soltos como "-"
                        name = name.replace(/^-\s*/, ''); 
                    }

                    // Ignora textos muito longos (provavelmente observa√ß√µes) ou vazios
                    if (name.length > 2 && name.length < 60 && !name.toLowerCase().includes('entrega')) {
                        // Padroniza primeira letra mai√∫scula para agrupar melhor
                        name = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
                        stats.products[name] = (stats.products[name] || 0) + qty;
                    }
                });
            }
        });

        stats.avgTicket = stats.orderCount > 0 ? stats.totalRevenue / stats.orderCount : 0;
        return stats;
    }

    async printReport() {
        UI.toast("Preparando documento...");

        const chartRevenueImg = this.charts.revenue ? this.charts.revenue.toBase64Image() : '';
        const chartPaymentsImg = this.charts.payments ? this.charts.payments.toBase64Image() : '';

        const reportData = {
            period: this.period,
            revenue: $('repTotalRevenue').innerText,
            orders: $('repOrderCount').innerText,
            avgTicket: $('repAvgTicket').innerText,
            clients: $('repTopClientsList').innerHTML,
            products: $('repTopProductsList').innerHTML,
            charts: {
                revenue: chartRevenueImg,
                payments: chartPaymentsImg
            },
            date: luxon.DateTime.now().toFormat('dd/MM/yyyy HH:mm')
        };

        const res = await window.electronAPI.printReport(reportData);
        if(res.success) {
            UI.toast("Relat√≥rio enviado para a impressora!");
        } else {
            UI.alert("Erro", "N√£o foi poss√≠vel gerar o relat√≥rio.");
        }
    }

    renderMetrics(stats) {
        $('repTotalRevenue').innerText = `R$ ${stats.totalRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        $('repOrderCount').innerText = stats.orderCount;
        $('repAvgTicket').innerText = `R$ ${stats.avgTicket.toFixed(2)}`;
    }

    renderSalesChart(stats) {
        const ctx = $('chartRevenue');
        if (this.charts.revenue) this.charts.revenue.destroy();

        // Ordena as datas para o gr√°fico n√£o ficar bagun√ßado
        const sortedDates = Object.keys(stats.dailySales).sort((a, b) => {
            const [da, ma] = a.split('/');
            const [db, mb] = b.split('/');
            return new Date(2024, ma-1, da) - new Date(2024, mb-1, db);
        });

        this.charts.revenue = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [{
                    label: 'Faturamento Di√°rio',
                    data: sortedDates.map(d => stats.dailySales[d]),
                    borderColor: '#ec4899',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    renderPaymentsChart(stats) {
        const ctx = $('chartPayments');
        if (this.charts.payments) this.charts.payments.destroy();

        this.charts.payments = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(stats.payments),
                datasets: [{
                    data: Object.values(stats.payments),
                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1']
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    renderTopProducts(stats) {
        const list = $('repTopProductsList');
        list.innerHTML = '';

        // Converte objeto em array e ordena por quantidade decrescente
        const sorted = Object.entries(stats.products)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5);

        if (sorted.length === 0) {
            list.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">Sem dados suficientes para ranking.</p>';
            return;
        }

        sorted.forEach(([name, qty]) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 border-b border-gray-50';
            div.innerHTML = `
                <span class="text-sm text-gray-700 truncate pr-2" title="${name}">${name}</span>
                <span class="text-sm font-bold text-purple-500 whitespace-nowrap">${qty} un.</span>
            `;
            list.appendChild(div);
        });
    }

    renderTopClients(stats) {
        const list = $('repTopClientsList');
        list.innerHTML = '';
        
        const sorted = Object.entries(stats.clients)
            .sort(([,a], [,b]) => b.total - a.total)
            .slice(0, 5);

        if (sorted.length === 0) {
            list.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">Sem dados.</p>';
            return;
        }

        sorted.forEach(([name, data]) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-2 border-b border-gray-50';
            div.innerHTML = `
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-gray-700 truncate w-32" title="${name}">${name}</span>
                    <span class="text-[10px] text-gray-400">${data.count} pedidos</span>
                </div>
                <span class="text-sm font-bold text-emerald-600">R$ ${data.total.toFixed(2)}</span>
            `;
            list.appendChild(div);
        });
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/modules/SettingsModule.js
================================================================================
import { $, $$, show, hide } from '../utils/DOM.js';
import { UI } from '../utils/UI.js';
import { SettingsService } from '../services/SettingsService.js';

export class SettingsModule {
    constructor() {
        this.service = new SettingsService();
        
        // Elementos UI Principais
        this.form = $('configForm');
        this.btnSave = $('btnSaveConfig');
        this.btnNext = $('next-step-btn');
        this.btnPrev = $('prev-step-btn');
        
        // ESTRUTURA DE DADOS
        this.chips = {
            acaiSizes: new Set(),
            freeAddons: new Set(),
            paidAddons: new Set()
        };

        // Controle do Stepper
        this.currentStep = 1;
        this.totalSteps = 4;

        // Bindings
        this.handleSave = this.handleSave.bind(this);
        this.handleAddProduct = this.handleAddProduct.bind(this);
        this.handleProductAction = this.handleProductAction.bind(this);
    }

    init() {
        console.log('[Settings] Iniciando V6.2 (Doce Floco Manager)...');
        
        this.loadConfig();
        this.loadProducts();
        this.setupStepper();
        this.setupChips();

        if (this.form) this.form.addEventListener('submit', this.handleSave);
        
        const btnAdd = $('btnAddProduct');
        if (btnAdd) btnAdd.onclick = this.handleAddProduct;
        
        const prodList = $('productsListConfig');
        if (prodList) prodList.onclick = this.handleProductAction;
        
        const btnRefresh = $('btnRefreshPrinters');
        if (btnRefresh) btnRefresh.onclick = () => this.loadPrinters($('cfgPrinterSelect').value);
    }

    // =========================================================================
    // 1. STEPPER NAVIGATION (CORRIGIDO VISUAL)
    // =========================================================================
    setupStepper() {
        const updateUI = () => {
            // CORRE√á√ÉO: Mapa de larguras fixas para garantir que a linha chegue na bolinha
            // Como a bolinha tem fundo branco e z-index maior, podemos "passar" um pouco.
            const widthMap = {
                1: '0%',
                2: '35%', // Era 33% (aumentado para esconder a ponta atr√°s da bolinha)
                3: '68%', // Era 66%
                4: '100%'
            };

            const progressBar = $('stepperProgress');
            if(progressBar) progressBar.style.width = widthMap[this.currentStep];

            // Atualiza visibilidade dos pain√©is e indicadores
            for (let i = 1; i <= this.totalSteps; i++) {
                const panel = $(`step-${i}`);
                if(panel) i === this.currentStep ? show(panel) : hide(panel);

                // Atualiza visual das bolinhas (steps)
                // Usamos querySelector para achar o elemento espec√≠fico pelo data-step
                const indicatorDiv = document.querySelector(`.step-indicator[data-step="${i}"] div`);
                const indicatorText = document.querySelector(`.step-indicator[data-step="${i}"] span`);
                
                if (indicatorDiv && indicatorText) {
                    if (i <= this.currentStep) {
                        // Ativo ou Passado (Roxo)
                        indicatorDiv.className = 'w-6 h-6 rounded-full bg-purple-600 border-2 border-purple-600 mx-auto transition-colors duration-300 shadow-md ring-2 ring-purple-100';
                        indicatorText.className = 'text-[10px] font-bold text-purple-600 mt-2 block uppercase tracking-wide';
                    } else {
                        // Futuro (Cinza)
                        indicatorDiv.className = 'w-6 h-6 rounded-full bg-white border-2 border-gray-200 mx-auto transition-colors duration-300';
                        indicatorText.className = 'text-[10px] font-bold text-gray-400 mt-2 block uppercase tracking-wide';
                    }
                }
            }

            // Controle dos bot√µes Voltar/Pr√≥ximo/Salvar
            if (this.currentStep === 1) hide(this.btnPrev); else show(this.btnPrev);
            
            if (this.currentStep === this.totalSteps) { 
                hide(this.btnNext); 
                show(this.btnSave); 
            } else { 
                show(this.btnNext); 
                hide(this.btnSave); 
            }
        };

        if(this.btnNext) this.btnNext.onclick = () => {
            if (this.validateStep(this.currentStep)) {
                if (this.currentStep < this.totalSteps) {
                    this.currentStep++;
                    updateUI();
                }
            }
        };

        if(this.btnPrev) this.btnPrev.onclick = () => {
            if (this.currentStep > 1) {
                this.currentStep--;
                updateUI();
            }
        };

        updateUI();
    }

    validateStep(step) {
        if (step === 1) {
            const name = $('cfgStoreName').value.trim();
            if (!name) {
                UI.toast('Por favor, informe o nome da loja.', 'error');
                $('cfgStoreName').focus();
                return false;
            }
        }
        return true;
    }

    // =========================================================================
    // 2. CHIPS LOGIC (Etiquetas)
    // =========================================================================
    setupChips() {
        const setupInput = (inputId, containerId, setKey) => {
            const input = $(inputId);
            const container = $(containerId);
            if(!input || !container) return;

            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const val = input.value.trim();
                    if (val && !this.chips[setKey].has(val)) {
                        this.chips[setKey].add(val);
                        input.value = '';
                        this.renderChips(container, setKey);
                    }
                }
            };
        };

        setupInput('inpAcaiSize', 'chipsAcaiSizeContainer', 'acaiSizes');
        setupInput('inpFreeAddon', 'chipsFreeAddonContainer', 'freeAddons');
        setupInput('inpPaidAddon', 'chipsPaidAddonContainer', 'paidAddons');
    }

    renderChips(container, setKey) {
        if(!container) return;
        container.innerHTML = '';
        
        this.chips[setKey].forEach(tag => {
            const span = document.createElement('span');
            const hasPrice = tag.includes('=');
            
            span.className = `text-xs px-2 py-1 rounded-full flex items-center gap-1 border transition shadow-sm ${
                hasPrice ? 'bg-cyan-50 text-cyan-700 border-cyan-200 font-bold' : 'bg-purple-50 text-purple-700 border-purple-200 font-medium'
            }`;
            
            let displayText = tag;
            if (hasPrice) {
                const parts = tag.split('=');
                if(parts.length === 2) {
                    displayText = `${parts[0]} <span class="text-[9px] opacity-70">R$${parts[1]}</span>`;
                }
            }

            span.innerHTML = `${displayText} <i class="fas fa-times cursor-pointer hover:text-red-500 ml-1 opacity-60 hover:opacity-100"></i>`;
            
            span.querySelector('i').onclick = () => {
                this.chips[setKey].delete(tag);
                this.renderChips(container, setKey);
            };
            container.appendChild(span);
        });
    }

    // =========================================================================
    // 3. LOAD DATA
    // =========================================================================
    async loadConfig() {
        try {
            const d = await this.service.getStoreConfig();
            
            // Step 1: Identidade
            $('cfgStoreName').value = d.storeName || '';
            $('cfgPixKey').value = d.pixKey || '';
            $('cfgAddress').value = d.address || '';
            $('cfgWelcomeMsg').value = d.welcomeMsg || '';
            if($('cfgUseEmojis')) $('cfgUseEmojis').checked = d.useEmojis || false;

            // Step 2: Regras & A√ßa√≠
            $('cfgDeliveryFee').value = d.deliveryFee || '';
            $('cfgMinDeliveryQty').value = d.minDeliveryQty || 0;
            
            if (d.imgAcaiPath) show($('statusImgAcai'));

            // Preenchimento dos Chips
            const loadSet = (dbString, setKey, containerId) => {
                this.chips[setKey].clear();
                if (dbString) {
                    dbString.split(',').forEach(t => {
                        if(t.trim()) this.chips[setKey].add(t.trim());
                    });
                }
                this.renderChips($(containerId), setKey);
            };

            loadSet(d.acaiSizes, 'acaiSizes', 'chipsAcaiSizeContainer');
            loadSet(d.freeAddons, 'freeAddons', 'chipsFreeAddonContainer');
            loadSet(d.paidAddons, 'paidAddons', 'chipsPaidAddonContainer');

            // Step 4: Sistema
            $('cfgApiKey').value = d.geminiApiKey || '';
            $('cfgAutoPrint').checked = d.autoPrint || false;
            
            await this.loadPrinters(d.printerName);

        } catch (e) {
            console.error('[Settings] Erro loadConfig:', e);
            UI.toast('Erro ao carregar configura√ß√µes.', 'error');
        }
    }

    async loadPrinters(selected) {
        const el = $('cfgPrinterSelect');
        if(!el) return;
        el.innerHTML = '<option>Carregando...</option>';
        const res = await this.service.getPrinters();
        el.innerHTML = '<option value="">Selecione...</option>';
        if (res.success && res.printers) {
            res.printers.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name + (p.isDefault ? ' (Padr√£o)' : '');
                if (p.name === selected) opt.selected = true;
                el.appendChild(opt);
            });
        }
    }

    // =========================================================================
    // 4. PRODUTOS / ESTOQUE
    // =========================================================================
    async loadProducts() {
        const container = $('productsListConfig');
        if(!container) return;
        container.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-10"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando picol√©s...</div>';
        
        const res = await this.service.getProducts();
        container.innerHTML = '';

        if (res.success && res.products.length > 0) {
            res.products.forEach(p => {
                const isActive = p.active !== false;
                const card = document.createElement('div');
                card.className = `relative group bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow-md transition flex flex-col justify-between ${!isActive ? 'opacity-50 grayscale' : ''}`;
                
                const imgDisplay = p.imagePath 
                    ? `<img src="file://${p.imagePath.replace(/\\/g, '/')}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">`
                    : `<i class="fas fa-ice-cream text-gray-300 text-lg"></i>`;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center overflow-hidden border border-gray-100">
                             ${imgDisplay}
                        </div>
                        <input type="checkbox" class="toggle-active accent-purple-500 cursor-pointer w-4 h-4" data-id="${p.id}" ${isActive ? 'checked' : ''} title="Ativar/Desativar">
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-bold text-gray-700 truncate" title="${p.name}">${p.name}</p>
                        <p class="text-[10px] font-bold text-purple-600 bg-purple-50 inline-block px-1 rounded">R$ ${parseFloat(p.price).toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-1 border-t border-gray-100 pt-2 mt-auto">
                        <div class="relative flex-1">
                            <input type="number" class="stock-input w-full bg-gray-50 border rounded text-center text-xs py-1 outline-none focus:ring-1 ring-purple-300 font-bold text-gray-600" 
                                value="${p.quantity || 0}" data-id="${p.id}" placeholder="Qtd">
                        </div>
                        <button class="text-gray-400 hover:text-blue-500 p-1.5 rounded hover:bg-blue-50 transition btn-img" data-id="${p.id}" title="Alterar Foto"><i class="fas fa-camera"></i></button>
                        <button class="text-gray-400 hover:text-red-500 p-1.5 rounded hover:bg-red-50 transition btn-del" data-id="${p.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(card);
            });
        } else {
            container.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-4 text-xs">Nenhum produto cadastrado.</div>';
        }
    }

    async handleAddProduct() {
        const nameInput = $('prodName');
        const priceInput = $('prodPrice');
        const name = nameInput.value.trim();
        const price = priceInput.value;
        if(name && price) {
            await this.service.addProduct({ name, price, quantity: 0, active: true });
            nameInput.value = '';
            priceInput.value = '';
            nameInput.focus();
            UI.toast('Produto adicionado!');
            this.loadProducts();
        } else {
            UI.toast('Preencha nome e pre√ßo.', 'error');
        }
    }

    async handleProductAction(e) {
        const t = e.target.closest('button') || e.target; 
        
        // Excluir
        if (t.classList.contains('btn-del') || (t.parentElement && t.parentElement.classList.contains('btn-del'))) {
            const btn = t.classList.contains('btn-del') ? t : t.parentElement;
            if(await UI.confirm('Excluir Produto', 'Essa a√ß√£o n√£o pode ser desfeita.', 'Excluir', 'red')) {
                await this.service.deleteProduct(btn.dataset.id);
                this.loadProducts();
            }
            return;
        }
        
        // Ativar/Desativar
        if (t.classList.contains('toggle-active')) {
            await this.service.toggleProductStatus(t.dataset.id, t.checked);
            this.loadProducts(); 
            return;
        }
        
        // Alterar Imagem
        if (t.classList.contains('btn-img') || (t.parentElement && t.parentElement.classList.contains('btn-img'))) {
            const btn = t.classList.contains('btn-img') ? t : t.parentElement;
            const res = await this.service.selectProductImage(btn.dataset.id);
            if(res.success) {
                UI.toast('Imagem atualizada!');
                this.loadProducts();
            }
            return;
        }
        
        // Atualizar Estoque (Input)
        if (t.classList.contains('stock-input')) {
            t.onblur = async () => {
                const newVal = parseInt(t.value) || 0;
                await this.service.updateProductStock(t.dataset.id, newVal);
            };
            t.onkeydown = (k) => {
                if(k.key === 'Enter') t.blur();
            };
        }
    }

    // =========================================================================
    // 5. SAVE CONFIGURATION
    // =========================================================================
    async handleSave(e) {
        e.preventDefault();
        
        const originalBtnText = this.btnSave.innerHTML;
        this.btnSave.disabled = true;
        this.btnSave.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...';

        try {
            let newAcaiPath = null;
            const inpAcai = $('cfgImgAcai');
            if (inpAcai && inpAcai.files.length > 0) {
                const file = inpAcai.files[0];
                const reader = new FileReader();
                await new Promise(r => {
                    reader.onload = async () => {
                        const res = await window.electronAPI.uploadConfigImage({ category: 'acai', buffer: reader.result });
                        if(res.success) newAcaiPath = res.path;
                        r();
                    };
                    reader.readAsArrayBuffer(file);
                });
            }

            const data = {
                storeName: $('cfgStoreName').value,
                pixKey: $('cfgPixKey').value,
                address: $('cfgAddress').value,
                welcomeMsg: $('cfgWelcomeMsg').value,
                useEmojis: $('cfgUseEmojis').checked,
                deliveryFee: parseFloat($('cfgDeliveryFee').value) || 0,
                minDeliveryQty: parseInt($('cfgMinDeliveryQty').value) || 0,
                acaiSizes: Array.from(this.chips.acaiSizes).join(', '),
                freeAddons: Array.from(this.chips.freeAddons).join(', '),
                paidAddons: Array.from(this.chips.paidAddons).join(', '),
                geminiApiKey: $('cfgApiKey').value,
                printerName: $('cfgPrinterSelect').value,
                autoPrint: $('cfgAutoPrint').checked
            };

            if (newAcaiPath) data.imgAcaiPath = newAcaiPath;

            await this.service.saveStoreConfig(data);
            UI.toast('Configura√ß√µes salvas e IA atualizada!');

            if (newAcaiPath) show($('statusImgAcai'));

        } catch (err) {
            console.error(err);
            UI.alert('Erro ao Salvar', err.message);
        } finally {
            this.btnSave.disabled = false;
            this.btnSave.innerHTML = originalBtnText;
        }
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/services/CalendarService.js
================================================================================
export class CalendarService {
    // Busca encomendas agendadas
    async getScheduledOrders() {
        return await window.electronAPI.getScheduledOrders();
    }

    // Atualiza uma encomenda (data, itens, valor)
    async updateOrder(id, data) {
        return await window.electronAPI.updateOrder(id, data);
    }

    // Exclui encomenda
    async deleteOrder(id) {
        return await window.electronAPI.deleteOrder(id);
    }

    // Imprime comprovante
    async printOrder(order) {
        return await window.electronAPI.printOrder(order);
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/services/ClientService.js
================================================================================
import { FirebaseService } from './FirebaseService.js';

export class ClientService {
    constructor() {
        this.db = FirebaseService.getInstance().db;
    }

    // Ouve mudan√ßas na lista de clientes (Realtime)
    listenToClients(callback) {
        return this.db.collection('clients')
            .orderBy('name', 'asc')
            .onSnapshot(snapshot => {
                const clients = [];
                snapshot.forEach(doc => {
                    clients.push({ id: doc.id, ...doc.data() });
                });
                callback(clients);
            });
    }

    // Cria cliente via Backend (IPC) para validar telefone
    async createClient(data) {
        return await window.electronAPI.createClientIfNotExists(data);
    }

    // Atualiza dados
    async updateClient(id, data) {
        return await window.electronAPI.updateClient(id, data);
    }

    // Deleta cliente
    async deleteClient(id) {
        return await window.electronAPI.deleteClient(id);
    }

    // Busca hist√≥rico de pedidos (IPC)
    async getHistory(clientId) {
        return await window.electronAPI.getClientAppointments(clientId);
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/services/FirebaseService.js
================================================================================
export class FirebaseService {
    constructor() {
        try {
            const config = window.electronAPI.getFirebaseConfig();
            this.app = firebase.initializeApp(config);
            this.auth = firebase.auth();
            this.db = firebase.firestore();
            console.log('[Firebase] Inicializado');
        } catch (e) {
            console.error('[Firebase] Erro Cr√≠tico:', e);
        }
    }

    // Retorna a inst√¢ncia compartilhada
    static getInstance() {
        if (!FirebaseService.instance) {
            FirebaseService.instance = new FirebaseService();
        }
        return FirebaseService.instance;
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/services/OrderService.js
================================================================================
import { FirebaseService } from './FirebaseService.js';

export class OrderService {
    constructor() {
        this.db = FirebaseService.getInstance().db;
    }

    // Ouve pedidos em tempo real (Kanban)
    listenToPendingOrders(callback) {
        return this.db.collection('orders')
            .orderBy('createdAt', 'desc')
            .limit(60)
            .onSnapshot(snapshot => {
                const orders = [];
                snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
                callback(orders);
            });
    }

    // Ouve agendamentos (Calend√°rio)
    async getScheduledOrders() {
        return await window.electronAPI.getScheduledOrders();
    }

    // --- CORRE√á√ÉO: M√©todo adicionado para o Modal de Edi√ß√£o funcionar ---
    async updateOrder(id, data) {
        // Envia para o preload (backend) fazer a atualiza√ß√£o no Firestore
        return await window.electronAPI.updateOrder(id, data);
    }
    // -------------------------------------------------------------------

    async updateStatus(orderId, newStatus, shouldNotify, orderData) {
        return await window.electronAPI.updateOrderStatus({ 
            orderId, newStatus, shouldNotify, orderData 
        });
    }

    async deleteOrder(id) {
        return await window.electronAPI.deleteOrder(id);
    }
    
    async printOrder(order) {
        return await window.electronAPI.printOrder(order);
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/services/ProductService.js
================================================================================
import { FirebaseService } from './FirebaseService.js';

export class ProductService {
    constructor() {
        this.db = FirebaseService.getInstance().db;
    }

    async getActiveProducts() {
        return await window.electronAPI.getProducts();
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/services/SettingsService.js
================================================================================
import { FirebaseService } from './FirebaseService.js';

export class SettingsService {
    constructor() {
        this.db = FirebaseService.getInstance().db;
    }

    // --- CONFIGURA√á√ïES DA LOJA ---

    async getStoreConfig() {
        try {
            const doc = await this.db.collection('settings').doc('storeConfig').get();
            return doc.exists ? doc.data() : {};
        } catch (error) {
            console.error('[Settings] Erro ao ler config:', error);
            throw error;
        }
    }

    async saveStoreConfig(data) {
        // 1. Salva no Firestore
        await this.db.collection('settings').doc('storeConfig').set(data, { merge: true });
        // 2. Avisa o Backend (Main Process) para atualizar a IA em mem√≥ria
        await window.electronAPI.updateAiSettings(data);
        return { success: true };
    }

    async uploadMenuFile(fileData) {
        return await window.electronAPI.uploadMenuFile(fileData);
    }

    // --- HARDWARE ---

    async getPrinters() {
        return await window.electronAPI.getPrinters();
    }

    // --- PRODUTOS (CRUD) ---

    async getProducts() {
        return await window.electronAPI.getProducts();
    }

    async addProduct(product) {
        return await window.electronAPI.addProduct(product);
    }

    async deleteProduct(id) {
        return await window.electronAPI.deleteProduct(id);
    }

    async toggleProductStatus(id, isActive) {
        return await window.electronAPI.toggleProductStatus({ id, isActive });
    }

    async updateProductStock(id, quantity) {
        return await window.electronAPI.updateProductStock({ id, quantity });
    }

    async selectProductImage(id) {
        // Abre di√°logo nativo do sistema operacional
        return await window.electronAPI.selectProductImage(id);
    }
}

================================================================================
ARQUIVO: /src/renderer/assets/js/utils/DOM.js
================================================================================
export const $ = (id) => document.getElementById(id);
export const $$ = (selector) => document.querySelectorAll(selector);

export const show = (element) => {
    if (element) element.classList.remove('hidden');
};

export const hide = (element) => {
    if (element) element.classList.add('hidden');
};

export const hideAll = (selector) => {
    $$(selector).forEach(el => el.classList.add('hidden'));
};

================================================================================
ARQUIVO: /src/renderer/assets/js/utils/UI.js
================================================================================
export class UI {
    static _createModal(contentHtml, onMount) {
        return new Promise((resolve) => {
            const overlay = document.createElement('div');
            // Classes originais do seu projeto
            overlay.className = 'fixed inset-0 bg-slate-900 bg-opacity-70 flex items-center justify-center z-[100] animate-fade-in backdrop-blur-sm';
            
            const card = document.createElement('div');
            // O segredo do "ajust√°vel" era o w-96 e o overflow
            card.className = 'bg-white p-6 rounded-xl shadow-2xl w-96 transform transition-all scale-100 border-t-4 border-purple-500 relative max-h-[90vh] overflow-y-auto'; 
            card.innerHTML = contentHtml;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'absolute top-3 right-3 text-gray-300 hover:text-red-500 transition';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            
            const close = (val) => { 
                overlay.classList.add('opacity-0'); 
                setTimeout(() => { 
                    if(document.body.contains(overlay)) document.body.removeChild(overlay); 
                    resolve(val); 
                }, 200); 
            };
            
            closeBtn.onclick = () => close(null);
            overlay.onclick = (e) => { if (e.target === overlay) close(null); };
            
            card.appendChild(closeBtn);
            overlay.appendChild(card);
            document.body.appendChild(overlay);

            if (onMount) onMount(card, close);
        });
    }

    // Mantendo os outros m√©todos simples
    static alert(title, message) {
        return UI._createModal(`<div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4"><i class="fas fa-check text-green-600 text-xl"></i></div><h3 class="text-lg font-bold text-gray-900">${title}</h3><p class="text-sm text-gray-500 mt-2 mb-6">${message}</p><button id="btnOk" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none sm:text-sm">OK</button></div>`, (card, close) => { card.querySelector('#btnOk').onclick = () => close(true); });
    }

    static confirm(title, message, confirmText = 'Confirmar', color = 'purple') {
        const btnColorClass = color === 'red' ? 'bg-red-600 hover:bg-red-700' : 'bg-purple-600 hover:bg-purple-700';
        return UI._createModal(`<div class="text-left"><h3 class="text-lg font-bold text-gray-900 mb-2">${title}</h3><p class="text-sm text-gray-600 mb-6">${message}</p><div class="flex justify-end gap-3"><button id="btnCancel" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium text-sm transition">Cancelar</button><button id="btnConfirm" class="px-4 py-2 ${btnColorClass} text-white rounded-lg font-bold shadow-md text-sm transition flex items-center gap-2">${confirmText}</button></div></div>`, (card, close) => { card.querySelector('#btnConfirm').onclick = () => close(true); card.querySelector('#btnCancel').onclick = () => close(false); });
    }

    // NOVO M√âTODO ADICIONADO ABAIXO:
    static decision(title, message, primaryLabel, secondaryLabel) {
        return UI._createModal(`
            <h3 class="text-lg font-bold text-gray-800 mb-2">${title}</h3>
            <p class="text-gray-600 mb-6 text-sm">${message}</p>
            <div class="flex flex-col gap-3">
                <button id="btnPrimary" class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-md transition flex justify-center items-center gap-2">
                    <i class="fab fa-whatsapp text-lg"></i> ${primaryLabel}
                </button>
                <button id="btnSecondary" class="w-full py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition">
                    ${secondaryLabel}
                </button>
            </div>
        `, (card, close) => {
            const btnPrimary = card.querySelector('#btnPrimary');
            const btnSecondary = card.querySelector('#btnSecondary');

            if (btnPrimary) btnPrimary.onclick = () => close(true);
            if (btnSecondary) btnSecondary.onclick = () => close(false);
        });
    }

    static toast(message, type = 'success') {
        const container = document.getElementById('toast-container') || (() => { const d = document.createElement('div'); d.id = 'toast-container'; d.className = 'fixed bottom-4 right-4 z-[200] flex flex-col gap-2'; document.body.appendChild(d); return d; })();
        const el = document.createElement('div');
        const colors = type === 'success' ? 'bg-slate-800 text-green-400 border-green-500' : 'bg-slate-800 text-red-400 border-red-500';
        el.className = `${colors} border-l-4 px-4 py-3 rounded shadow-lg flex items-center gap-3 min-w-[250px] animate-slide-in`;
        el.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i><span class="text-sm font-medium text-white">${message}</span>`;
        container.appendChild(el);
        setTimeout(() => { if(container.contains(el)) container.removeChild(el); }, 3000);
    }
}

================================================================================
ARQUIVO: /src/renderer/index.html
================================================================================
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doce Floco Manager V6.2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Utils -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://unpkg.com/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Tailwind Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        purple: { 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9' },
                        cyan: { 50: '#ecfeff', 100: '#cffafe', 400: '#22d3ee', 500: '#06b6d4', 600: '#0891b2' } 
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideIn: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(0)' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* Modal Overlay */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 50; backdrop-filter: blur(2px);
        }
        .modal-content { 
            background: white; padding: 1.5rem; border-radius: 0.75rem; 
            width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
            animation: modalPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Stepper Logic */
        .step-circle.active { border-color: #7c3aed; background: #7c3aed; color: white; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .toggle-label { width: 40px; height: 20px; position: relative; display: block; background: #e5e7eb; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        
        /* Scrollbars */
        .custom-scrollbar { overflow-y: auto; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Kanban */
        .kanban-card { transition: all 0.2s; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-color: #a78bfa; }
    </style>
</head>
<body class="bg-purple-50 text-gray-800 h-screen w-screen flex flex-col">

    <!-- =================================================================================
         1. TELA DE LOGIN
    ================================================================================== -->
    <div id="authSection" class="flex-1 flex flex-col justify-center items-center bg-slate-900 relative overflow-hidden">
        <!-- Background Decorativo -->
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
            <i class="fas fa-snowflake text-9xl text-white absolute top-10 left-10 animate-pulse"></i>
            <i class="fas fa-ice-cream text-9xl text-white absolute bottom-10 right-10"></i>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-purple-500 z-10">
            <div class="text-center mb-6">
                <div class="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-ice-cream text-3xl text-purple-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Doce Floco Manager</h1>
                <p class="text-gray-400 text-xs uppercase tracking-widest mt-1">Acesso Administrativo</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">EMAIL</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-3 top-3 text-gray-400"></i>
                        <input type="email" id="email" required class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none transition" placeholder="admin@docefloco.com">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">SENHA</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                        <input type="password" id="password" required class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-bold transition shadow-lg transform active:scale-95">
                    Entrar no Sistema
                </button>
                <p id="authMessage" class="text-red-500 text-center text-xs hidden font-bold mt-2"></p>
            </form>
        </div>
        <p class="text-slate-600 text-xs mt-8">V6.2 - Doce Floco (A√ßa√≠ & Picol√©s)</p>
    </div>

    <!-- =================================================================================
         2. APLICA√á√ÉO PRINCIPAL
    ================================================================================== -->
    <div id="appSection" class="flex h-screen w-full hidden overflow-hidden">
        
        <!-- SIDEBAR (Barra Lateral) -->
        <aside id="sidebar" class="w-64 bg-slate-900 text-white flex flex-col justify-between p-4 shadow-xl z-20 flex-shrink-0 transition-all duration-300">
            <div>
                <!-- Logo -->
                <div class="flex items-center gap-3 mb-10 px-2 mt-2">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-cyan-400 rounded-lg flex items-center justify-center shadow-lg">
                        <i class="fas fa-snowflake text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">Doce Floco</h1>
                        <p class="text-[10px] text-cyan-400 font-bold tracking-widest uppercase">Manager</p>
                    </div>
                </div>
                
                <!-- Menu -->
                <nav class="space-y-1">
                    <a href="#" id="navDashboard" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="dashboard">
                        <i class="fas fa-chart-pie w-6 text-center text-slate-400 group-hover:text-cyan-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Vis√£o Geral</span>
                    </a>
                    
                    <a href="#" id="navPos" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="pos">
                        <i class="fas fa-cash-register w-6 text-center text-slate-400 group-hover:text-cyan-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Frente de Caixa</span>
                    </a>

                    <a href="#" id="navPedidos" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="pedidos">
                        <i class="fas fa-receipt w-6 text-center text-slate-400 group-hover:text-cyan-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Pedidos</span>
                    </a>

                    <a href="#" id="navEncomendas" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="encomendas">
                        <i class="fas fa-calendar-alt w-6 text-center text-slate-400 group-hover:text-cyan-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Encomendas</span>
                    </a>

                    <a href="#" id="navClientes" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="clientes">
                        <i class="fas fa-users w-6 text-center text-slate-400 group-hover:text-cyan-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Clientes</span>
                    </a>

                    <div class="my-4 border-t border-slate-800"></div>

                    <a href="#" id="navConversas" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="conversas">
                        <i class="fas fa-comments w-6 text-center text-slate-400 group-hover:text-cyan-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Chat Inteligente</span>
                    </a>

                    <a href="#" id="navWhatsapp" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="whatsapp">
                        <i class="fab fa-whatsapp w-6 text-center text-slate-400 group-hover:text-green-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Conex√£o</span>
                    </a>

                    <a href="#" id="navRelatorios" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="relatorios">
                        <i class="fas fa-chart-line w-6 text-center text-slate-400 group-hover:text-cyan-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Relat√≥rios</span>
                    </a>

                    <a href="#" id="navConfig" class="flex items-center p-3 rounded-xl hover:bg-slate-800 transition group nav-item mb-1" data-section="config">
                        <i class="fas fa-cog w-6 text-center text-slate-400 group-hover:text-yellow-400 transition"></i>
                        <span class="ml-3 font-medium text-sm text-slate-300 group-hover:text-white">Configura√ß√£o</span>
                    </a>
                </nav>
            </div>
            
            <button id="logoutButtonSidebar" class="flex items-center p-3 rounded-xl hover:bg-red-900/30 text-red-400 hover:text-red-300 transition w-full mt-auto group">
                <i class="fas fa-sign-out-alt w-6 text-center group-hover:rotate-180 transition-transform"></i>
                <span class="ml-3 font-medium text-sm">Sair</span>
            </button>
        </aside>

        <!-- AREA DE CONTE√öDO -->
        <div id="contentArea" class="flex-1 flex flex-col bg-purple-50 overflow-hidden relative">
            
            <!-- Header Topo -->
            <header class="bg-white px-8 py-4 shadow-sm flex justify-between items-center z-10 border-b border-purple-100">
                <div>
                    <h2 id="currentSectionTitle" class="text-xl font-bold text-gray-800 tracking-tight">Vis√£o Geral</h2>
                    <p class="text-xs text-gray-400">Gerenciador de Pedidos</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden md:block">
                        <p class="text-xs font-bold text-gray-600" id="userEmail">Admin</p>
                        <p class="text-[10px] text-purple-500 font-bold uppercase">Gerente</p>
                    </div>
                    <div class="h-10 w-10 rounded-full bg-purple-100 border-2 border-purple-200 flex items-center justify-center text-purple-600">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </header>

            <!-- Main Scrollable Area -->
            <main class="flex-1 overflow-y-auto p-6 scroll-smooth custom-scrollbar relative">
                
                <!-- 1. DASHBOARD (Raio-X do Dia) -->
                <section id="sectionDashboard" class="content-section">
                    
                    <!-- Cabe√ßalho do Dia -->
                    <div class="mb-2 flex items-center gap-2">
                        <div class="bg-purple-600 text-white w-8 h-8 rounded-lg flex items-center justify-center shadow-sm">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div>
                            <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Resumo de Hoje</h3>
                            <p class="text-[10px] text-gray-400 font-mono" id="dashTodayDate">Carregando data...</p>
                        </div>
                    </div>

                    <!-- GRID DE CARDS (4 Colunas) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        
                        <!-- 1. Faturamento Hoje -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500 flex justify-between items-center transition hover:shadow-md">
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Vendido Hoje</p>
                                <h3 class="text-2xl font-black text-gray-800 mt-1" id="dashTodayRevenue">R$ 0,00</h3>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
                                <i class="fas fa-dollar-sign text-lg"></i>
                            </div>
                        </div>

                        <!-- 2. Qtd Pedidos Hoje -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 flex justify-between items-center transition hover:shadow-md">
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Pedidos Hoje</p>
                                <h3 class="text-2xl font-black text-gray-800 mt-1" id="dashTodayCount">0</h3>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                                <i class="fas fa-shopping-bag text-lg"></i>
                            </div>
                        </div>

                        <!-- 3. Ticket M√©dio Hoje -->
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500 flex justify-between items-center transition hover:shadow-md">
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Ticket M√©dio</p>
                                <h3 class="text-2xl font-black text-gray-800 mt-1" id="dashTodayTicket">R$ 0,00</h3>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600">
                                <i class="fas fa-chart-line text-lg"></i>
                            </div>
                        </div>

                        <!-- 4. Fila / Pendentes (Operacional) -->
                        <div id="dashCardOrders" class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-400 flex justify-between items-center cursor-pointer hover:bg-yellow-50 transition" onclick="document.getElementById('navPedidos').click()">
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Fila / Pendentes</p>
                                <h3 class="text-2xl font-black text-yellow-600 mt-1 animate-pulse" id="dashOpenOrders">0</h3>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600">
                                <i class="fas fa-clock text-lg"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Layout Dividido: Gr√°fico (2/3) + Agenda (1/3) -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100%-140px)]">
                        
                        <!-- Coluna Esquerda: Gr√°fico -->
                        <div class="lg:col-span-2 bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="font-bold text-gray-800">Desempenho da Semana</h3>
                                    <p class="text-xs text-gray-400">Comparativo √∫ltimos 7 dias</p>
                                </div>
                                <button class="text-xs text-purple-600 font-bold bg-purple-50 px-3 py-1 rounded hover:bg-purple-100 transition" onclick="document.getElementById('navRelatorios').click()">
                                    Ver Detalhes <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                            <div class="relative flex-1 w-full min-h-[250px]">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>

                        <!-- Coluna Direita: Agenda do Dia -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative">
                            <!-- Cabe√ßalho Agenda -->
                            <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-2">
                                <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-calendar-check text-orange-500"></i> Encomendas Hoje
                                </h3>
                                <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-bold">HOJE</span>
                            </div>

                            <!-- Lista Scroll√°vel -->
                            <div id="dashTodaySchedule" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-1">
                                <!-- O JavaScript vai injetar os itens aqui ou a mensagem de vazio -->
                                <div class="flex flex-col items-center justify-center h-full text-gray-300 opacity-60">
                                    <i class="fas fa-mug-hot text-3xl mb-2"></i>
                                    <p class="text-xs">Carregando agenda...</p>
                                </div>
                            </div>

                            <!-- Bot√£o R√°pido -->
                            <button onclick="document.getElementById('navEncomendas').click()" class="mt-4 w-full py-2 bg-orange-50 text-orange-600 text-xs font-bold rounded-lg hover:bg-orange-100 transition border border-orange-200">
                                Ver Calend√°rio Completo
                            </button>
                        </div>
                    </div>
                </section>

                <!-- 2. PEDIDOS (KANBAN + MANUAL) -->
                <section id="sectionPedidos" class="content-section hidden flex flex-col h-full gap-6">
                    <!-- Kanban Board - CORRE√á√ÉO DE SCROLL AQUI -->
                    <div id="kanbanBoard" class="flex-1 grid grid-cols-4 gap-4 overflow-hidden min-h-[400px] pt-2">
                        <!-- Coluna Pendente -->
                        <div class="kanban-col bg-slate-50 border border-slate-200 rounded-xl flex flex-col p-3 h-full min-h-0">
                            <div class="kanban-col-title text-slate-500 font-bold text-xs uppercase mb-3 flex justify-between flex-shrink-0">
                                <span><i class="fas fa-clock mr-1"></i> Pendente</span>
                                <span id="count-pending" class="bg-slate-200 px-2 rounded-full text-[10px]">0</span>
                            </div>
                            <div id="col-pending" class="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1"></div>
                        </div>

                        <!-- Coluna Preparo -->
                        <div class="kanban-col bg-orange-50 border border-orange-100 rounded-xl flex flex-col p-3 h-full min-h-0">
                            <div class="kanban-col-title text-orange-600 font-bold text-xs uppercase mb-3 flex justify-between flex-shrink-0">
                                <span><i class="fas fa-blender mr-1"></i> Preparo</span>
                                <span id="count-prep" class="bg-orange-200 px-2 rounded-full text-[10px]">0</span>
                            </div>
                            <div id="col-prep" class="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1"></div>
                        </div>

                        <!-- Coluna Envio/Pronto -->
                        <div class="kanban-col bg-cyan-50 border border-cyan-100 rounded-xl flex flex-col p-3 h-full min-h-0">
                            <div class="kanban-col-title text-cyan-600 font-bold text-xs uppercase mb-3 flex justify-between flex-shrink-0">
                                <span><i class="fas fa-motorcycle mr-1"></i> Envio/Pronto</span>
                                <span id="count-sent" class="bg-cyan-200 px-2 rounded-full text-[10px]">0</span>
                            </div>
                            <div id="col-sent" class="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1"></div>
                        </div>

                        <!-- Coluna Conclu√≠do -->
                        <div class="kanban-col bg-emerald-50 border border-emerald-100 rounded-xl flex flex-col p-3 h-full min-h-0">
                            <div class="kanban-col-title text-emerald-600 font-bold text-xs uppercase mb-3 flex justify-between flex-shrink-0">
                                <span><i class="fas fa-check-circle mr-1"></i> Conclu√≠do</span>
                                <span id="count-done" class="bg-emerald-200 px-2 rounded-full text-[10px]">0</span>
                            </div>
                            <div id="col-done" class="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1"></div>
                        </div>
                    </div>
                </section>

                <!-- 3. POS -->
                <section id="sectionPos" class="content-section hidden h-full flex gap-6 overflow-hidden">
                    <!-- Esquerda: Cat√°logo -->
                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex gap-4 bg-gray-50">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-4 top-3 text-gray-400"></i>
                                <input type="text" id="posSearchInput" placeholder="Buscar picol√©, pote..." 
                                    class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-sm">
                            </div>
                        </div>
                        <div id="posProductGrid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 custom-scrollbar content-start">
                            <!-- Cards Injetados via JS -->
                        </div>
                    </div>

                    <!-- Direita: Carrinho -->
                    <div class="w-96 flex flex-col bg-slate-900 rounded-2xl shadow-2xl overflow-hidden text-white border-l-4 border-purple-500">
                        <!-- Header do Carrinho com Bot√£o de Fechar Caixa -->
                        <div class="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase">Cliente</label>
                                <select id="posClientSelect" class="w-40 bg-slate-900 border border-slate-600 rounded-lg p-1 text-sm mt-1 focus:border-purple-500 outline-none"></select>
                            </div>
                            <!-- NOVO BOT√ÉO DE FECHAR CAIXA -->
                            <button id="btnCloseRegister" class="bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-bold py-2 px-3 rounded-lg shadow transition flex flex-col items-center gap-1" title="Imprimir Relat√≥rio do Dia">
                                <i class="fas fa-cash-register text-sm"></i> FECHAR CAIXA
                            </button>
                        </div>

                        <div id="posCartList" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                            <div id="posEmptyCart" class="h-full flex flex-col items-center justify-center text-slate-600 space-y-2 opacity-60">
                                <i class="fas fa-shopping-basket text-4xl"></i>
                                <p class="text-sm">Seu carrinho est√° vazio</p>
                            </div>
                        </div>
                        <div class="p-6 bg-slate-800 shadow-lg space-y-4">
                            <div class="flex justify-between items-center text-slate-400 text-sm">
                                <span>Subtotal</span>
                                <span id="posSubtotal">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center text-3xl font-bold text-purple-400">
                                <span>Total</span>
                                <span id="posTotal">R$ 0,00</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 pt-2">
                                <button class="pos-pay-btn flex flex-col items-center p-2 rounded-lg border border-slate-600 hover:bg-slate-700 transition" data-method="Pix">
                                    <i class="fas fa-qrcode text-emerald-400 mb-1"></i><span class="text-[10px]">PIX</span>
                                </button>
                                <button class="pos-pay-btn flex flex-col items-center p-2 rounded-lg border border-slate-600 hover:bg-slate-700 transition" data-method="Cart√£o">
                                    <i class="fas fa-credit-card text-blue-400 mb-1"></i><span class="text-[10px]">CART√ÉO</span>
                                </button>
                                <button class="pos-pay-btn flex flex-col items-center p-2 rounded-lg border border-slate-600 hover:bg-slate-700 transition" data-method="Dinheiro">
                                    <i class="fas fa-money-bill-wave text-green-400 mb-1"></i><span class="text-[10px]">DINHEIRO</span>
                                </button>
                                <button id="btnPosClear" class="flex flex-col items-center p-2 rounded-lg border border-red-900/50 text-red-400 hover:bg-red-900/20 transition">
                                    <i class="fas fa-trash mb-1"></i><span class="text-[10px]">LIMPAR</span>
                                </button>
                            </div>

                            <button id="btnPosFinalize" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-check-circle"></i> FINALIZAR VENDA (F10)
                            </button>
                        </div>
                    </div>
                </section>

                <!-- 4. ENCOMENDAS -->
                <section id="sectionEncomendas" class="content-section hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Calend√°rio de Pedidos</h2>
                            <p class="text-sm text-gray-500" id="currentMonthLabel">...</p>
                        </div>
                        <div class="flex gap-2 bg-white p-1 rounded-lg border shadow-sm">
                            <button id="btnPrevMonth" class="p-2 hover:bg-gray-50 rounded"><i class="fas fa-chevron-left text-gray-600"></i></button>
                            <button id="btnNextMonth" class="p-2 hover:bg-gray-50 rounded"><i class="fas fa-chevron-right text-gray-600"></i></button>
                        </div>
                        <button id="btnNewEncomenda" class="ml-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-bold shadow-md">
                            <i class="fas fa-plus mr-2"></i>Agendar
                        </button>
                    </div>
                    <div class="flex-1 bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col overflow-hidden">
                        <div class="grid grid-cols-7 gap-1 text-center mb-4">
                            <div class="text-xs font-bold text-gray-300 uppercase">Dom</div>
                            <div class="text-xs font-bold text-gray-300 uppercase">Seg</div>
                            <div class="text-xs font-bold text-gray-300 uppercase">Ter</div>
                            <div class="text-xs font-bold text-gray-300 uppercase">Qua</div>
                            <div class="text-xs font-bold text-gray-300 uppercase">Qui</div>
                            <div class="text-xs font-bold text-gray-300 uppercase">Sex</div>
                            <div class="text-xs font-bold text-gray-300 uppercase">S√°b</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-2 flex-1 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </section>

                <!-- 5. CLIENTES -->
                <section id="sectionClientes" class="content-section hidden">
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 border border-gray-100">
                        <h3 class="text-xs font-bold text-gray-400 uppercase mb-4"><i class="fas fa-user-plus mr-1"></i> Cadastrar Cliente</h3>
                        <form id="addClientForm" class="space-y-4">
                            <div class="flex flex-col md:flex-row gap-4 items-start">
                                <div class="w-full md:w-24">
                                    <label class="text-xs font-bold text-gray-500">DDI</label>
                                    <select id="addClientCountryCode" class="w-full border rounded-lg p-2 bg-gray-50 text-sm h-[40px]"><option value="55" selected>üáßüá∑ +55</option></select>
                                </div>
                                <div class="flex-1 w-full">
                                    <label class="text-xs font-bold text-gray-500">Nome</label>
                                    <input type="text" id="clientNameInput" required class="w-full border rounded-lg p-2 text-sm h-[40px]" placeholder="Nome Completo">
                                </div>
                                <div class="flex-1 w-full">
                                    <label class="text-xs font-bold text-gray-500">Telefone (Whatsapp)</label>
                                    <input type="text" id="clientPhoneInput" required class="w-full border rounded-lg p-2 text-sm h-[40px]" placeholder="DDD + N√∫mero">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500">Endere√ßo Completo (Opcional)</label>
                                <input type="text" id="clientAddressInput" class="w-full border rounded-lg p-2 text-sm h-[40px]" placeholder="Rua, N√∫mero, Bairro e Complemento">
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 font-bold h-[40px] shadow-md transition transform active:scale-95">
                                    Salvar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="space-y-2" id="clientsList"></div>
                    <p id="noClientsMessage" class="hidden text-center text-gray-400 mt-10">Nenhum cliente na base de dados.</p>
                </section>

                <!-- 6. WHATSAPP -->
                <section id="sectionWhatsapp" class="content-section hidden flex flex-col items-center justify-center h-full">
                    <div class="bg-white p-12 rounded-3xl shadow-xl text-center max-w-md w-full border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-emerald-600"></div>
                        <div class="mb-8">
                            <div class="w-24 h-24 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                                <i class="fab fa-whatsapp text-5xl text-green-600"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">Conex√£o WhatsApp</h3>
                            <p class="text-sm text-gray-500">Escaneie o QR Code para conectar o rob√¥.</p>
                        </div>
                        <div class="mb-6">
                            <p class="text-xs font-bold text-gray-400 uppercase mb-2">Status da Conex√£o</p>
                            <p class="text-lg"><span id="whatsappStatusText" class="font-bold text-gray-400">Desconectado</span></p>
                        </div>

                        <div id="whatsappQrContainer" class="hidden mb-6 flex flex-col items-center p-4 border rounded-xl bg-gray-50">
                            <canvas id="whatsappQrCodeCanvas" class="rounded-lg shadow-sm"></canvas>
                        </div>

                        <div class="space-y-3 w-full">
                            <button id="whatsappReconnectButton" class="hidden w-full bg-green-600 text-white py-3 rounded-xl hover:bg-green-700 font-bold shadow-lg transition">
                                Iniciar Conex√£o
                            </button>
                            <button id="whatsappLogoutButton" class="hidden w-full border border-red-200 text-red-500 py-3 rounded-xl hover:bg-red-50 font-bold transition">
                                Desconectar
                            </button>
                        </div>
                    </div>
                </section>

                <!-- 7. CONVERSAS -->
                <section id="sectionConversas" class="content-section hidden h-[calc(100vh-140px)] flex border border-gray-200 rounded-2xl overflow-hidden shadow-sm bg-white">
                    <!-- Lista Lateral -->
                    <div class="w-80 border-r bg-gray-50 flex flex-col">
                        <div class="p-4 border-b bg-white">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wide">Conversas Recentes</h4>
                        </div>
                        <div id="conversationsList" class="flex-1 overflow-y-auto custom-scrollbar"></div>
                    </div>

                    <!-- Janela de Chat -->
                    <div id="chatWindow" class="flex-1 flex flex-col hidden bg-slate-50 relative">
                        <!-- Header Chat -->
                        <div class="p-4 bg-white border-b flex justify-between items-center shadow-sm z-10">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-lg"><i class="fas fa-user"></i></div>
                                <div><h4 id="currentChatClientName" class="font-bold text-gray-800 leading-tight">Cliente</h4><span class="text-xs text-green-500 font-medium flex items-center gap-1"><i class="fas fa-circle text-[8px]"></i> Online</span></div>
                            </div>
                            <div class="flex items-center gap-3 bg-gray-100 px-4 py-2 rounded-full border border-gray-200">
                                <span class="text-xs font-bold text-gray-500 uppercase">Rob√¥ Ativo</span>
                                <div class="relative inline-block w-10 align-middle select-none">
                                    <input type="checkbox" id="aiToggleSwitch" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                                    <label for="aiToggleSwitch" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                        <div id="messagesContainer" class="flex-1 p-6 overflow-y-auto flex flex-col space-y-3 custom-scrollbar bg-slate-50"></div>
                        <div class="p-4 bg-white border-t flex items-end gap-3">
                            <button id="btnDailyShowcase" class="bg-cyan-50 text-cyan-600 w-10 h-10 rounded-xl hover:bg-cyan-100 transition flex items-center justify-center border border-cyan-200 shadow-sm" title="Enviar Vitrine (Picol√©s)"><i class="fas fa-layer-group"></i></button>
                            <button id="btnQuickGallery" class="bg-purple-50 text-purple-600 w-10 h-10 rounded-xl hover:bg-purple-100 transition flex items-center justify-center border border-purple-200 shadow-sm" title="Enviar Foto Produto"><i class="fas fa-image"></i></button>
                            <div class="flex-1 relative"><textarea id="chatMessageInput" rows="1" class="w-full border rounded-xl pl-4 pr-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none bg-gray-50" placeholder="Digite sua mensagem... (Enter para enviar)"></textarea></div>
                            <button id="sendChatMessageButton" class="bg-purple-600 text-white w-12 h-10 rounded-xl hover:bg-purple-700 shadow-md transition flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                    <div id="emptyChatState" class="flex-1 flex flex-col items-center justify-center text-gray-300 bg-white"><i class="far fa-comments text-6xl mb-4 text-purple-200"></i><p class="font-medium text-gray-400">Selecione uma conversa para atender</p></div>
                </section>

                <!-- 8. RELAT√ìRIOS -->
                <section id="sectionRelatorios" class="content-section hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">Business Intelligence</h2>
                        <div class="flex items-center gap-4">
                            <button id="btnIdPrintReport" class="bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-50 transition text-xs font-bold flex items-center gap-2 shadow-sm"><i class="fas fa-file-pdf text-red-500"></i> Exportar Relat√≥rio</button>
                            <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200">
                                <button class="report-period-btn px-4 py-1 text-xs rounded-md bg-purple-600 text-white font-bold" data-days="7">7 Dias</button>
                                <button class="report-period-btn px-4 py-1 text-xs rounded-md hover:bg-gray-100 text-gray-600" data-days="30">30 Dias</button>
                                <button class="report-period-btn px-4 py-1 text-xs rounded-md hover:bg-gray-100 text-gray-600" data-days="90">90 Dias</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-purple-500"><p class="text-xs font-bold text-gray-400 uppercase">Faturamento Bruto</p><h3 class="text-3xl font-black text-gray-800 mt-2" id="repTotalRevenue">R$ 0,00</h3></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-blue-500"><p class="text-xs font-bold text-gray-400 uppercase">Pedidos Realizados</p><h3 class="text-3xl font-black text-gray-800 mt-2" id="repOrderCount">0</h3></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border-t-4 border-emerald-500"><p class="text-xs font-bold text-gray-400 uppercase">Ticket M√©dio</p><h3 class="text-3xl font-black text-gray-800 mt-2" id="repAvgTicket">R$ 0,00</h3></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h4 class="font-bold text-gray-700 mb-4">Evolu√ß√£o Di√°ria</h4><div class="h-64"><canvas id="chartRevenue"></canvas></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h4 class="font-bold text-gray-700 mb-4">Meios de Pagamento</h4><div class="h-64"><canvas id="chartPayments"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fas fa-crown text-yellow-400"></i> Top Clientes</h4><div id="repTopClientsList" class="space-y-1"></div></div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fas fa-star text-purple-400"></i> Produtos Populares</h4><div id="repTopProductsList" class="space-y-1"></div></div>
                    </div>
                </section>

                <!-- 9. CONFIGURA√á√ÉO -->
                <section id="sectionConfig" class="content-section hidden">
                    <div class="bg-white p-8 rounded-2xl shadow-lg max-w-5xl mx-auto border border-gray-100 min-h-[600px] flex flex-col relative overflow-hidden">
                        <div class="text-center mb-8"><h2 class="text-2xl font-bold text-gray-800">Configura√ß√£o da Loja</h2><p class="text-sm text-gray-400">Ajuste os par√¢metros da IA e do Card√°pio</p></div>
                        <div class="mb-10 px-10 relative">
                            <div class="relative w-full h-1 bg-gray-200 rounded overflow-hidden"><div id="stepperProgress" class="absolute top-0 left-0 h-full bg-purple-600 transition-all duration-500 ease-out" style="width: 0%"></div></div>
                            <div class="flex justify-between -mt-3 relative z-10">
                                <div class="step-indicator text-center cursor-default" data-step="1"><div class="w-6 h-6 rounded-full bg-white border-2 border-purple-600 mx-auto transition-colors duration-300"></div><span class="text-[10px] font-bold text-purple-600 mt-2 block uppercase tracking-wide">Identidade</span></div>
                                <div class="step-indicator text-center cursor-default" data-step="2"><div class="w-6 h-6 rounded-full bg-white border-2 border-gray-300 mx-auto transition-colors duration-300"></div><span class="text-[10px] font-bold text-gray-400 mt-2 block uppercase tracking-wide">Card√°pio A√ßa√≠</span></div>
                                <div class="step-indicator text-center cursor-default" data-step="3"><div class="w-6 h-6 rounded-full bg-white border-2 border-gray-300 mx-auto transition-colors duration-300"></div><span class="text-[10px] font-bold text-gray-400 mt-2 block uppercase tracking-wide">Estoque</span></div>
                                <div class="step-indicator text-center cursor-default" data-step="4"><div class="w-6 h-6 rounded-full bg-white border-2 border-gray-300 mx-auto transition-colors duration-300"></div><span class="text-[10px] font-bold text-gray-400 mt-2 block uppercase tracking-wide">Sistema</span></div>
                            </div>
                        </div>
                        <form id="configForm" class="flex-1 flex flex-col">
                            <div id="step-1" class="step-panel space-y-6 animate-fade-in">
                                <div class="grid grid-cols-2 gap-6">
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome do Estabelecimento</label><input id="cfgStoreName" class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Ex: Doce Floco"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chave Pix</label><input id="cfgPixKey" class="w-full border rounded-lg p-3 text-sm bg-green-50 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Email, CPF..."></div>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Endere√ßo (Retirada)</label><input id="cfgAddress" class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mensagem de Boas-vindas</label><textarea id="cfgWelcomeMsg" class="w-full border rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none" rows="2" placeholder="Ex: Ol√°! Sou a assistente virtual da Doce Floco."></textarea></div>
                                <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-lg border border-gray-100"><input type="checkbox" id="cfgUseEmojis" class="w-5 h-5 accent-purple-600 rounded cursor-pointer"><label for="cfgUseEmojis" class="text-sm font-medium text-gray-700 cursor-pointer">Usar Emojis nas Respostas da IA (üíú, üç¶, ‚ùÑÔ∏è)</label></div>
                            </div>
                            <div id="step-2" class="step-panel hidden space-y-6 animate-fade-in">
                                <div class="bg-purple-50 p-6 rounded-xl border border-purple-100 relative overflow-hidden">
                                    <i class="fas fa-utensils text-6xl text-purple-200 absolute -right-4 -bottom-4 opacity-50"></i>
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-sm font-bold text-purple-800 uppercase flex items-center gap-2"><i class="fas fa-wine-glass"></i> Montagem de Copos (A√ßa√≠)</h3>
                                        <div class="flex items-center gap-2 z-10">
                                            <span id="statusImgAcai" class="text-[10px] text-green-600 font-bold hidden bg-white px-2 py-1 rounded shadow-sm"><i class="fas fa-check-circle"></i> Imagem Salva</span>
                                            <label class="cursor-pointer bg-white text-purple-600 px-3 py-1 rounded-lg text-xs font-bold border border-purple-200 shadow-sm hover:bg-purple-100 transition"><i class="fas fa-upload mr-1"></i> Upload Tabela <input type="file" id="cfgImgAcai" accept="image/*" class="hidden"></label>
                                        </div>
                                    </div>
                                    <div class="space-y-4 relative z-10">
                                        <div><label class="text-[10px] font-bold text-purple-400 uppercase">Tamanhos (Ex: 300ml=12)</label><div id="chipsAcaiSizeContainer" class="flex flex-wrap gap-2 mb-2 min-h-[30px]"></div><input id="inpAcaiSize" class="w-full text-xs p-2 rounded border border-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-400 bg-white/80" placeholder="Digite e aperte Enter..."></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm"><label class="text-xs font-bold text-gray-500 uppercase block mb-2">Complementos Gr√°tis</label><div id="chipsFreeAddonContainer" class="flex flex-wrap gap-2 mb-2 min-h-[40px]"></div><input id="inpFreeAddon" class="w-full text-xs p-2 border-b border-gray-200 focus:border-purple-500 outline-none bg-transparent" placeholder="Ex: Leite em p√≥..."></div>
                                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm"><label class="text-xs font-bold text-gray-500 uppercase block mb-2">Adicionais Pagos (Upsell)</label><div id="chipsPaidAddonContainer" class="flex flex-wrap gap-2 mb-2 min-h-[40px]"></div><input id="inpPaidAddon" class="w-full text-xs p-2 border-b border-gray-200 focus:border-purple-500 outline-none bg-transparent" placeholder="Ex: Nutella=5..."></div>
                                </div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase block mb-1">Taxa de Entrega (R$)</label><input type="number" id="cfgDeliveryFee" class="w-32 border rounded-lg p-2 text-sm font-bold" placeholder="0.00"></div>
                                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <label class="text-[10px] font-bold text-yellow-700 uppercase block mb-1">
                                        <i class="fas fa-hand-paper mr-1"></i> Pedido M√≠nimo (Apenas Entrega)
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="cfgMinDeliveryQty" class="w-24 border rounded-lg p-2 text-sm font-bold text-gray-700" placeholder="0">
                                        <span class="text-xs text-gray-500">unidades (0 = sem m√≠nimo)</span>
                                    </div>
                                    <p class="text-[10px] text-gray-400 mt-1">A IA recusar√° entregas com quantidade menor que esta.</p>
                                </div>
                            </div>
                            <div id="step-3" class="step-panel hidden flex flex-col h-full animate-fade-in">
                                <div class="flex gap-4 mb-4 items-end bg-gray-50 p-4 rounded-xl border border-gray-200">
                                    <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Nome do Produto</label><input id="prodName" class="w-full border-b-2 border-gray-300 bg-transparent py-1 text-sm focus:border-purple-500 outline-none" placeholder="Ex: Picol√© de Coco"></div>
                                    <div class="w-24"><label class="text-[10px] font-bold text-gray-500 uppercase">Pre√ßo</label><input id="prodPrice" type="number" class="w-full border-b-2 border-gray-300 bg-transparent py-1 text-sm focus:border-purple-500 outline-none" placeholder="0.00"></div>
                                    <button type="button" id="btnAddProduct" class="bg-green-500 text-white w-10 h-10 rounded-full hover:bg-green-600 shadow-md flex items-center justify-center transition transform hover:rotate-90"><i class="fas fa-plus"></i></button>
                                </div>
                                <div id="productsListConfig" class="flex-1 overflow-y-auto grid grid-cols-3 gap-3 custom-scrollbar content-start p-1"></div>
                            </div>
                            <div id="step-4" class="step-panel hidden space-y-6 animate-fade-in">
                                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 shadow-sm">
                                    <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-brain text-purple-500"></i> Intelig√™ncia Artificial (Gemini)</h4>
                                    <label class="block text-xs font-bold text-gray-400 mb-1">API KEY</label>
                                    <input type="password" id="cfgApiKey" class="w-full border rounded-lg p-3 text-sm bg-white focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Cole sua chave aqui...">
                                </div>
                                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200 shadow-sm">
                                    <h4 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-print text-gray-600"></i> Impress√£o T√©rmica</h4>
                                    <div class="flex gap-3 mb-4">
                                        <select id="cfgPrinterSelect" class="flex-1 border rounded-lg p-2 text-sm bg-white"></select>
                                        <button type="button" id="btnRefreshPrinters" class="text-gray-500 hover:text-gray-800 px-2"><i class="fas fa-sync-alt"></i></button>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="relative inline-block w-10 align-middle select-none">
                                            <input type="checkbox" id="cfgAutoPrint" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                                            <label for="cfgAutoPrint" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                                        </div>
                                        <span class="text-xs font-bold text-gray-600">Imprimir Automaticamente ao confirmar pedido</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-auto pt-6 border-t border-gray-100 flex justify-between items-center">
                                <button type="button" id="prev-step-btn" class="hidden text-gray-500 hover:text-gray-800 text-sm font-medium px-4 py-2 rounded-lg hover:bg-gray-100 transition"><i class="fas fa-arrow-left mr-2"></i> Voltar</button>
                                <div class="flex gap-3 ml-auto">
                                    <button type="button" id="next-step-btn" class="bg-slate-800 text-white px-8 py-3 rounded-lg hover:bg-slate-700 font-bold shadow-lg transition">Pr√≥ximo <i class="fas fa-arrow-right ml-2"></i></button>
                                    <button type="submit" id="btnSaveConfig" class="hidden bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700 font-bold shadow-lg transition flex items-center gap-2"><i class="fas fa-save"></i> Salvar Tudo</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- =================================================================================
         MODAIS (POP-UPS)
    ================================================================================== -->
    
    <!-- Modal Editar Cliente -->
    <div id="editClientModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">Editar Cliente</h3>
            <form id="editClientForm" class="space-y-4">
                <input type="hidden" id="editClientId">
                <div class="flex gap-3">
                    <select id="editClientCountryCode" class="border rounded-lg p-2 bg-gray-50 w-24 text-sm"><option value="55">üáßüá∑ +55</option></select>
                    <input type="text" id="editClientName" class="border rounded-lg p-2 flex-1 text-sm focus:border-purple-500 outline-none" placeholder="Nome">
                </div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Telefone</label><input type="text" id="editClientPhone" class="border rounded-lg p-2 w-full text-sm focus:border-purple-500 outline-none"></div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Endere√ßo Salvo</label><input type="text" id="editClientAddress" class="border rounded-lg p-2 w-full text-sm focus:border-purple-500 outline-none" placeholder="Rua, N√∫mero..."></div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 mt-2"><p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Hist√≥rico Recente</p><div id="clientAppointmentsHistory" class="text-xs text-gray-600 max-h-32 overflow-y-auto space-y-2 custom-scrollbar"></div></div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancelEditClientButton" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium shadow-md transition">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Pedido -->
    <div id="editOrderModal" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-lg font-bold text-gray-800">Detalhes do Pedido</h3>
                <span id="modalStatusBadge" class="text-[10px] px-3 py-1 rounded-full bg-gray-100 text-gray-500 font-bold uppercase tracking-wider">STATUS</span>
            </div>
            <form id="editOrderForm" class="space-y-4">
                <input type="hidden" id="editOrderId">
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Itens do Pedido</label><textarea id="editOrderItems" class="w-full border rounded-lg p-3 text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-purple-500 outline-none transition" rows="3"></textarea></div>
                <div class="flex gap-4">
                    <div class="flex-1"><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Total (R$)</label><input type="number" step="0.50" id="editOrderTotal" class="w-full border rounded-lg p-2 text-sm font-bold text-gray-800"></div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Forma Pagamento</label>
                        <select id="editOrderPayment" class="w-full border rounded-lg p-2 text-sm bg-white"><option value="Pix">Pix</option><option value="Dinheiro">Dinheiro</option><option value="Cart√£o">Cart√£o</option></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Data Agendada</label><input type="date" id="editOrderDate" class="w-full border rounded-lg p-2 text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">M√©todo Entrega</label><input type="text" id="editOrderDelivery" class="w-full border rounded-lg p-2 text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Endere√ßo de Entrega</label><input type="text" id="editOrderAddress" class="w-full border rounded-lg p-2 text-sm" placeholder="Rua, N√∫mero..."></div>
                <div class="flex justify-between items-center pt-4 border-t mt-4">
                    <div class="flex gap-2">
                        <button type="button" id="btnModalDelete" class="w-10 h-10 flex items-center justify-center text-red-400 hover:bg-red-50 rounded-lg transition" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                        <button type="button" id="btnModalPrint" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:bg-gray-100 rounded-lg transition" title="Imprimir"><i class="fas fa-print"></i></button>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" id="cancelEditOrderButton" class="px-5 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-bold transition">Fechar</button>
                        <button type="submit" class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-bold shadow-md transition transform active:scale-95">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nova/Editar Encomenda (FESTAS) -->
    <div id="encomendaModal" class="modal hidden">
        <div class="modal-content max-w-2xl bg-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-3 p-4 bg-purple-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-purple-800"><i class="fas fa-glass-cheers mr-2"></i>Gest√£o de Encomenda (Festas)</h3>
                <button id="closeEncomendaModal" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <form id="encomendaForm" class="p-6 space-y-4">
                <input type="hidden" id="encId"> 
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Cliente</label><select id="encClientSelect" class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-purple-500 outline-none"></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data do Evento</label><input type="date" id="encDate" required class="w-full border rounded-lg p-2 text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hora (Opcional)</label><input type="time" id="encTime" class="w-full border rounded-lg p-2 text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Itens do Pedido (Picol√©s/Potes)</label><textarea id="encItems" class="w-full border rounded-lg p-2 text-sm bg-gray-50 focus:bg-white transition" rows="2" placeholder="Ex: 50 Picol√©s Fruta, 30 Picol√©s Leite..."></textarea></div>
                <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <label class="block text-xs font-bold text-orange-700 uppercase mb-1"><i class="fas fa-box-open mr-1"></i> Materiais Emprestados</label>
                    <input type="text" id="encLoanedItems" class="w-full border border-orange-200 rounded-lg p-2 text-sm mb-2" placeholder="Ex: 1 Caixa T√©rmica, 2 Carrinhos...">
                    <div class="flex items-center gap-2"><label class="text-xs font-bold text-gray-500">Data Devolu√ß√£o:</label><input type="date" id="encReturnDate" class="border rounded-lg p-1 text-sm bg-white"></div>
                </div>
                
                <!-- AQUI EST√Å A ALTERA√á√ÉO: 3 COLUNAS (TOTAL, PAGAMENTO, ENDERE√áO) -->
                <div class="flex gap-4 items-end">
                     <div class="w-1/3">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor Total (R$)</label>
                        <input type="number" step="0.50" id="encTotal" class="w-full border rounded-lg p-2 text-sm font-bold text-gray-800" placeholder="0.00">
                    </div>
                     <div class="w-1/3">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pagamento</label>
                        <select id="encPayment" class="w-full border rounded-lg p-2 text-sm bg-white focus:border-purple-500 outline-none">
                            <option value="Pix">Pix</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cart√£o">Cart√£o</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Endere√ßo Entrega</label>
                        <input type="text" id="encAddress" class="w-full border rounded-lg p-2 text-sm" placeholder="Opcional (Retirada)">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t mt-2">
                    <button type="button" id="btnDeleteEncomenda" class="hidden px-4 py-2 text-red-400 hover:bg-red-50 rounded-lg text-sm font-bold transition mr-auto">Excluir</button>
                    <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-bold shadow-md transition transform active:scale-95">Salvar Encomenda</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script Principal -->
    <script type="module" src="./assets/js/core/App.js"></script>
</body>
</html>

================================================================================
ARQUIVO: /tailwind.config.js
================================================================================
/** @type {import('tailwindcss').Config} */
    module.exports = {
      content: [
        "./src/renderer/**/*.html",
        "./src/renderer/**/*.js",
      ],
      safelist: [
        'hidden', // Garante que a classe 'hidden' com !important seja sempre gerada.
      ],
      theme: {
        extend: {},
      },
      plugins: [],
    }

