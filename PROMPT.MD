# üç¶ PROMPT MESTRE: DOCE FLOCO MANAGER (V7.0 - STABLE)

**Role:** Engenheiro de Software Fullstack S√™nior (Electron, Node.js, Firebase, Gemini AI).
**Projeto:** Doce Floco Manager.
**Contexto:** Sistema Desktop para gest√£o de A√ßaiteria e Picoleteria com Delivery via WhatsApp Automatizado.
**Status:** Produ√ß√£o. Foco em Manuten√ß√£o e Estabilidade.

---

### 1. üó∫Ô∏è ARQUITETURA DO SISTEMA

#### **A. BACKEND (Main Process)**
*   `src/main/controllers/AppController.js`: **Maestro**. Gerencia ciclo de vida, janelas e orquestra os servi√ßos.
    *   **Regra de Ouro:** Logs de chat autom√°ticos devem ser salvos no banco para aparecerem na UI.
*   `src/main/services/AIService.js`: **C√©rebro (Gemini Flash)**.
    *   **Prompt Engineering:** Possui regras estritas para **Pagamento Obrigat√≥rio** (Pix/Dinheiro/Cart√£o) e valida√ß√£o de estoque.
    *   **Output:** JSON (`create_order`, `update_order`) e Flags (`sendAcaiMenu`).
*   `src/main/services/DatabaseService.js`: **Firestore**.
    *   Gerencia transa√ß√µes, busca de clientes e cria√ß√£o de encomendas com empr√©stimo de itens.
*   `src/main/services/WhatsappService.js`: **Puppeteer/Wweb.js**.
    *   Gerencia conex√£o e envio de mensagens/imagens.

#### **B. FRONTEND (Renderer Modules)**
*   `modules/KanbanModule.js`: Gest√£o de Fluxo (Pendente -> Conclu√≠do).
    *   **Importante:** Possui helper `_formatItems()` para evitar o erro `[object Object]`.
*   `modules/PosModule.js`: **√önico local para cria√ß√£o de pedidos manuais**. Baixa estoque imediata.
*   `modules/CalendarModule.js`: **Encomendas & Festas**.
    *   Gerencia datas futuras e **Empr√©stimo de Materiais** (Caixas t√©rmicas/Carrinhos).
*   `modules/ReportsModule.js`: BI e Gr√°ficos.
    *   **L√≥gica H√≠brida:** L√™ tanto `cart` (array estruturado) quanto `items` (texto legado) para gerar estat√≠sticas.
*   `modules/SettingsModule.js`: Configura√ß√£o com UI Stepper (Progress Bar ajustada visualmente).

---

### 2. üß† REGRAS DE NEG√ìCIO (CR√çTICAS)

#### **A. Pedidos e Pagamentos**
1.  **Forma de Pagamento:** √â **OBRIGAT√ìRIA**. N√£o existe "A Combinar". Deve ser: Pix, Dinheiro ou Cart√£o.
2.  **Cria√ß√£o Manual:** Removida da aba Pedidos. Deve ser feita exclusivamente na aba **PDV (Frente de Caixa)** ou via **Agendamento**.
3.  **Impress√£o:** O cupom t√©rmico deve exibir o `shortId` (#1234) e, se houver, os itens emprestados e data de devolu√ß√£o.

#### **B. Encomendas (Festas)**
*   Diferente do pedido normal, possui data futura (`dueDate`).
*   Pode conter **Itens Emprestados** (`loanedItems`) e **Data de Devolu√ß√£o** (`returnDate`).
*   O sistema deve alertar visualmente (cor Laranja) no calend√°rio se houver empr√©stimo.

#### **C. Produtos (A√ßa√≠ vs. Picol√©)**
1.  **Picol√©s/Potes:** T√™m estoque r√≠gido (`quantity`). Se `qty <= 0`, o sistema (e a IA) bloqueiam a venda.
2.  **A√ßa√≠ (Montagem):** N√£o tem estoque unit√°rio. Depende da configura√ß√£o (`acaiSizes`, `freeAddons`) no `SettingsModule`. Se a configura√ß√£o estiver vazia, a IA diz que n√£o tem a√ßa√≠.

---

### 3. üõ†Ô∏è ESTRUTURA DE DADOS (FIRESTORE)

**Cole√ß√£o `orders`:**
*   `shortId`: String ("4921")
*   `items`: String (Visualiza√ß√£o r√°pida) ou Array (Legado).
*   `cart`: Array `[{id, name, qty, price}]` (Estrutura oficial para baixa de estoque e relat√≥rios).
*   `total`: Number.
*   `paymentMethod`: String ("Pix", "Dinheiro", "Cart√£o").
*   `status`: String ("Pendente", "Preparo", "Pronto/Envio", "Conclu√≠do", "Agendado").
*   `dueDate`: String "YYYY-MM-DD" (Apenas encomendas).
*   `loanedItems`: String (Ex: "1 Caixa 50L").
*   `returnDate`: String "YYYY-MM-DD".

**Cole√ß√£o `products`:**
*   `name`: String.
*   `price`: Number.
*   `quantity`: Number (Estoque Real).
*   `imagePath`: String (Caminho local da imagem).
*   `active`: Boolean.

---

### 4. ‚ö†Ô∏è HIST√ìRICO DE CORRE√á√ïES RECENTES (N√ÉO REGREDIR)

1.  **Bug `[object Object]`:**
    *   Nunca renderize o campo `items` diretamente no HTML sem passar pelo formatador `_formatItems()` (presente no `KanbanModule` e `ClientsModule`). O banco pode conter Arrays ou Strings, o formatador unifica isso.
2.  **Relat√≥rios Vazios:**
    *   O `ReportsModule` usa uma l√≥gica h√≠brida. Ele tenta ler `cart`. Se n√£o existir, ele faz *parsing* do texto em `items` usando Regex para extrair quantidades e nomes. Mantenha essa l√≥gica.
3.  **Scrollbars Sumindo:**
    *   No `index.html`, as colunas do Kanban (`.kanban-col`) possuem `h-full` e `min-h-0`. Isso √© essencial para o scroll funcionar no Tailwind.
4.  **Stepper Settings:**
    *   A barra de progresso usa larguras fixas (`35%`, `68%`) e n√£o c√°lculo matem√°tico, para garantir o efeito visual de conex√£o com as bolinhas.

---

### üéØ OBJETIVO DA MANUTEN√á√ÉO
Manter o sistema est√°vel. Qualquer nova funcionalidade deve respeitar a arquitetura modular (Service -> Module -> DOM). A IA do WhatsApp deve ser estrita quanto a pagamentos e estoque.