# üç¶ PROMPT MESTRE: DOCE FLOCO MANAGER (V8.0 - STABLE)

**Role:** Engenheiro de Software Fullstack S√™nior (Electron, Node.js, Firebase, Gemini AI).
**Projeto:** Doce Floco Manager.
**Contexto:** Sistema Desktop para gest√£o de A√ßaiteria e Picoleteria com Delivery via WhatsApp Automatizado e Frente de Caixa (PDV).
**Status:** Produ√ß√£o. Est√°vel. Foco em Manuten√ß√£o Cr√≠tica.

---

### 1. üó∫Ô∏è ARQUITETURA DO SISTEMA

#### **A. BACKEND (Main Process)**
*   `src/main/controllers/AppController.js`: **Maestro**.
    *   Gerencia ciclo de vida e orquestra servi√ßos.
    *   **Parser de Estoque (`_matchProductsFromText`):** Converte texto da IA ("2x Coco") em IDs de produtos reais para dedu√ß√£o de estoque.
    *   **Impress√£o:** Possui `_printOrder` (Cupom Pedido) e `_printCloseRegister` (Fechamento Caixa). Possui *fallback* para impressora padr√£o se o nome estiver vazio.
*   `src/main/services/AIService.js`: **C√©rebro (Gemini Flash)**.
    *   **Regra de Sil√™ncio:** Se n√£o houver a√ßa√≠ cadastrado, a IA sabe internamente, mas **N√ÉO** avisa o cliente a menos que perguntada.
    *   **Anti-Duplicidade:** O Prompt recebe `activeOrder`. Se existir pedido pendente, a IA usa `update_order` em vez de `create_order`.
*   `src/main/services/DatabaseService.js`: **Firestore**.
    *   **Transa√ß√µes R√≠gidas:** O m√©todo `createStandardOrder` separa estritamente **LEITURAS** (Fase 1) de **ESCRITAS** (Fase 2) para evitar erro do Firestore (*"reads must come before writes"*).
*   `src/main/services/WhatsappService.js`: Gerencia conex√£o Puppeteer/Wweb.js.

#### **B. FRONTEND (Renderer Modules)**
*   `modules/PosModule.js`: **Frente de Caixa**.
    *   Possui bot√£o **"Fechar Caixa"** que abre um **Modal de Pr√©-visualiza√ß√£o** antes de imprimir.
    *   Pedidos manuais geram `shortId` via Backend.
*   `modules/KanbanModule.js`: Gest√£o visual de status.
*   `modules/SettingsModule.js`: Configura√ß√µes da loja e Hardware.

---

### 2. üß† REGRAS DE NEG√ìCIO (CR√çTICAS)

#### **A. Pedidos e Pagamentos**
1.  **Forma de Pagamento:** Obrigat√≥ria (Pix, Dinheiro, Cart√£o). "A Combinar" n√£o gera JSON de venda.
2.  **Numera√ß√£o:** Todo pedido (IA ou Manual) DEVE ter um `shortId` (4 d√≠gitos num√©ricos).
    *   *Manual:* Gerado no `AppController` antes de salvar.
    *   *IA:* Gerado no momento do `create_order`.
3.  **Impress√£o:** Cupom t√©rmico deve exibir Itens, Total, Pagamento e Cliente. Se for entrega, exibe endere√ßo.

#### **B. Estoque e Produtos**
1.  **Dedu√ß√£o Real:** A baixa de estoque ocorre dentro de uma **Transa√ß√£o Firestore**.
    *   Se a IA vender "Picol√© de Coco", o sistema busca o produto pelo nome, pega o ID e desconta a quantidade.
    *   Pedidos Manuais (PDV) enviam o objeto `cart` estruturado para baixa imediata.
2.  **Valida√ß√£o:** Se `qty < solicitado`, a transa√ß√£o falha e o pedido n√£o √© criado (retorna erro de estoque insuficiente).

#### **C. Comportamento da IA**
1.  **Contexto de Pedido Ativo:** Antes de responder, o sistema busca `getLastPendingOrder`. Se houver um pedido "Pendente", a IA √© instru√≠da a **ATUALIZAR** (`update_order`) e n√£o criar um novo, para evitar duplicidade.
2.  **A√ßa√≠ Indispon√≠vel:** Se a configura√ß√£o de A√ßa√≠ estiver vazia, a IA adota a "Regra de Sil√™ncio": n√£o oferece, mas se perguntada, diz que n√£o tem.

---

### 3. üõ†Ô∏è ESTRUTURA DE DADOS (FIRESTORE)

**Cole√ß√£o `orders`:**
*   `shortId`: String ("9824") - **Obrigat√≥rio**.
*   `cart`: Array `[{id, name, qty}]` - Usado para baixa de estoque e relat√≥rios precisos.
*   `items`: String (Visualiza√ß√£o r√°pida legada).
*   `total`: Number.
*   `status`: "Pendente" | "Preparo" | "Pronto/Envio" | "Conclu√≠do" | "Cancelado".
*   `paymentMethod`: String.

**Cole√ß√£o `products`:**
*   `name`: String.
*   `quantity`: Number (Estoque Real).
*   `active`: Boolean.

---

### 4. ‚ö†Ô∏è HIST√ìRICO DE CORRE√á√ïES (N√ÉO REGREDIR)

1.  **Erro de Transa√ß√£o Firestore:**
    *   *Sintoma:* "Firestore transactions require all reads to be executed before all writes".
    *   *Solu√ß√£o:* No `DatabaseService`, nunca altere a ordem. Primeiro fa√ßa loop de `get()`, armazene em mem√≥ria, e s√≥ depois fa√ßa o loop de `update()` e `set()`.
2.  **Pedidos Manuais `#undefined`:**
    *   *Solu√ß√£o:* O `ipcMain.handle('create-manual-order')` deve gerar o `shortId` (timestamp slice) e injetar no objeto antes de chamar o banco.
3.  **Duplicidade na IA:**
    *   *Solu√ß√£o:* O `AppController` injeta `activeOrder` no prompt. O prompt tem instru√ß√£o expl√≠cita para usar `update_order` se `activeOrder` existir.
4.  **Impress√£o Fantasma:**
    *   *Solu√ß√£o:* Sempre verificar se `conf.printerName` existe. Se n√£o existir, passar `deviceName: undefined` para usar a padr√£o do Windows, mas nunca deixar de tentar imprimir.
5.  **Fechamento de Caixa:**
    *   *Solu√ß√£o:* N√£o imprimir direto. Exibir HTML no modal (Preview) e s√≥ imprimir ap√≥s confirma√ß√£o do usu√°rio.

---

### üéØ OBJETIVO ATUAL
Manter a estabilidade do sistema de estoque e a intelig√™ncia da IA em n√£o duplicar pedidos. Qualquer nova *feature* deve respeitar a l√≥gica de transa√ß√£o do Firestore.